<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>si'se - 整体院経営ダッシュボード</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts Dependencies -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config for Tailwind (si'se Theme - Gentle Green) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        sise: {
                            50: '#f0fdf4',   // 非常に薄い緑
                            100: '#dcfce7',  // 薄い緑
                            200: '#bbf7d0',  // 明るい緑
                            300: '#86efac',  // 柔らかい緑
                            400: '#4ade80',  // ミディアム緑
                            500: '#22c55e',  // Brand Primary - 優しい緑
                            600: '#16a34a',  // 深い緑
                            700: '#15803d',  // 暗い緑
                            800: '#166534',  // より暗い緑
                            900: '#14532d',  // 最も暗い緑
                        },
                        accent: {
                            50: '#fefce8',
                            100: '#fef9c3',
                            500: '#eab308',  // Success/Accent - 黄緑
                            600: '#ca8a04',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', '"Hiragino Sans"', 'sans-serif'],
                        display: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: "Noto Sans JP", "Hiragino Sans", sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Dark Mode Styles */
        .dark body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .dark .bg-white {
            background-color: #1e293b !important;
        }

        .dark .bg-slate-50 {
            background-color: #0f172a !important;
        }

        .dark .text-slate-900 {
            color: #f1f5f9 !important;
        }

        .dark .text-slate-700 {
            color: #cbd5e1 !important;
        }

        .dark .text-slate-600 {
            color: #94a3b8 !important;
        }

        .dark .border-slate-200 {
            border-color: #334155 !important;
        }

        .dark .border-sise-200 {
            border-color: #15803d !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #22c55e;
            border-radius: 4px;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .skeleton {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e2e8f0;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            input, select, textarea {
                font-size: 16px !important;
            }
            button, a {
                min-height: 44px;
            }
        }

        /* Safe Area Support */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading-indicator" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f8fafc;">
            <div style="text-align: center;">
                <div style="width: 50px; height: 50px; border: 5px solid #22c55e; border-top: 5px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #1e293b; font-size: 16px; font-family: sans-serif;">si'se Dashboard</p>
                <p style="color: #64748b; font-size: 12px; font-family: sans-serif; margin-top: 10px;">読み込み中...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const RechartsLib = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, AreaChart, Area, PieChart, Pie, Cell } = RechartsLib;

        // ========================================
        // 設定・定数
        // ========================================

        // 店舗マスタ - 各店舗ごとにSquare設定を保持
        const stores = [
            {
                id: 1,
                name: "新宿店",
                code: "shinjuku",
                squareConfig: {
                    accessToken: 'YOUR_SQUARE_ACCESS_TOKEN_SHINJUKU',
                    locationId: 'YOUR_LOCATION_ID_SHINJUKU',
                    baseUrl: 'https://connect.squareup.com/v2'
                }
            },
            {
                id: 2,
                name: "渋谷店",
                code: "shibuya",
                squareConfig: {
                    accessToken: 'YOUR_SQUARE_ACCESS_TOKEN_SHIBUYA',
                    locationId: 'YOUR_LOCATION_ID_SHIBUYA',
                    baseUrl: 'https://connect.squareup.com/v2'
                }
            }
        ];

        // Google Apps Script Web App URL (日報データ取得用)
        // ※実際のデプロイ後URLに置き換えてください
        const GOOGLE_FORM_SHEET_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL';

        // ========================================
        // ヘルパー関数
        // ========================================

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
        };

        const formatNumber = (value) => {
            return new Intl.NumberFormat('ja-JP').format(value);
        };

        const formatPercent = (value) => {
            return `${value.toFixed(1)}%`;
        };

        // ========================================
        // コンポーネント
        // ========================================

        // アイコンコンポーネント
        const Icon = ({ name, size = 20, color = "currentColor", className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
        };

        // カードコンポーネント
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>
                {children}
            </div>
        );

        // KPIカードコンポーネント
        const KpiCard = ({ title, value, subValue, trend, icon, color = "bg-sise-500" }) => (
            <Card className="hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start mb-4">
                    <div className={`rounded-lg ${color} text-white shadow-md p-3`}>
                        <Icon name={icon} size={24} />
                    </div>
                    {trend !== null && trend !== undefined && (
                        <span className={`font-medium ${trend >= 0 ? 'text-green-600' : 'text-red-500'} flex items-center bg-slate-50 px-2 py-1 rounded-full text-sm`}>
                            {trend >= 0 ? '+' : ''}{trend}%
                            <Icon name={trend >= 0 ? 'trending-up' : 'trending-down'} size={14} className="ml-1" />
                        </span>
                    )}
                </div>
                <h3 className="text-slate-600 font-medium text-sm">{title}</h3>
                <div className="flex items-baseline mt-1">
                    <span className="text-2xl font-bold text-slate-900">{value}</span>
                </div>
                {subValue && <p className="text-xs text-slate-500 mt-1">{subValue}</p>}
            </Card>
        );

        // ========================================
        // Square API連携
        // ========================================

        // 店舗ごとのSquareデータ取得フック
        const useSquareData = (storeId = null) => {
            const [memberData, setMemberData] = useState({
                totalMembers: 0,
                activeMembers: 0,
                newMembersThisMonth: 0,
                churnedMembers: 0,
                churnRate: 0,
                expectedRevenue: 0,
                loading: true,
                error: null
            });

            const fetchSquareData = useCallback(async () => {
                // 店舗が指定されている場合、その店舗のSquare設定を取得
                const store = storeId ? stores.find(s => s.id === storeId || s.name === storeId) : null;
                const squareConfig = store?.squareConfig;

                // デモモード: 実際のAPIが設定されていない場合はサンプルデータを返す
                if (!squareConfig || squareConfig.accessToken.startsWith('YOUR_SQUARE_ACCESS_TOKEN')) {
                    // サンプルデータ（店舗ごとに異なる値を生成）
                    const baseMembers = storeId === 1 || storeId === "新宿店" ? 85 : 71;
                    setMemberData({
                        totalMembers: Math.floor(baseMembers * 1.1),
                        activeMembers: baseMembers,
                        newMembersThisMonth: Math.floor(Math.random() * 8) + 4,
                        churnedMembers: Math.floor(Math.random() * 4) + 1,
                        churnRate: (Math.random() * 3 + 1.5).toFixed(1),
                        expectedRevenue: baseMembers * 10000,
                        loading: false,
                        error: null
                    });
                    return;
                }

                try {
                    // Square Customers APIでサブスク会員を取得
                    const response = await fetch(`${squareConfig.baseUrl}/customers/search`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${squareConfig.accessToken}`,
                            'Content-Type': 'application/json',
                            'Square-Version': '2024-01-18'
                        },
                        body: JSON.stringify({
                            limit: 100,
                            query: {
                                filter: {
                                    // サブスク会員をフィルタ（実際の設定に合わせて調整）
                                    group_ids: {
                                        any: ['YOUR_SUBSCRIPTION_GROUP_ID']
                                    }
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Square API request failed');
                    }

                    const data = await response.json();
                    const customers = data.customers || [];

                    // サブスクリプションデータを取得
                    const subscriptionsResponse = await fetch(`${squareConfig.baseUrl}/subscriptions/search`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${squareConfig.accessToken}`,
                            'Content-Type': 'application/json',
                            'Square-Version': '2024-01-18'
                        },
                        body: JSON.stringify({
                            query: {
                                filter: {
                                    location_ids: [squareConfig.locationId]
                                }
                            }
                        })
                    });

                    const subsData = await subscriptionsResponse.json();
                    const subscriptions = subsData.subscriptions || [];

                    const activeSubscriptions = subscriptions.filter(s => s.status === 'ACTIVE');
                    const canceledThisMonth = subscriptions.filter(s => {
                        if (s.status !== 'CANCELED') return false;
                        const cancelDate = new Date(s.canceled_date);
                        const now = new Date();
                        return cancelDate.getMonth() === now.getMonth() &&
                               cancelDate.getFullYear() === now.getFullYear();
                    });

                    const monthlyPrice = 10000; // サブスク月額（実際の設定に合わせて）

                    setMemberData({
                        totalMembers: customers.length,
                        activeMembers: activeSubscriptions.length,
                        newMembersThisMonth: activeSubscriptions.filter(s => {
                            const startDate = new Date(s.start_date);
                            const now = new Date();
                            return startDate.getMonth() === now.getMonth() &&
                                   startDate.getFullYear() === now.getFullYear();
                        }).length,
                        churnedMembers: canceledThisMonth.length,
                        churnRate: customers.length > 0
                            ? (canceledThisMonth.length / customers.length * 100)
                            : 0,
                        expectedRevenue: activeSubscriptions.length * monthlyPrice,
                        loading: false,
                        error: null
                    });

                } catch (error) {
                    console.error('Square API Error:', error);
                    setMemberData(prev => ({
                        ...prev,
                        loading: false,
                        error: error.message
                    }));
                }
            }, [storeId]);

            useEffect(() => {
                fetchSquareData();
                // 5分ごとに更新
                const interval = setInterval(fetchSquareData, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, [fetchSquareData]);

            return { memberData, refreshSquareData: fetchSquareData };
        };

        // 全店舗のSquareデータを取得するフック
        const useAllStoresSquareData = () => {
            const [allStoresData, setAllStoresData] = useState({});
            const [loading, setLoading] = useState(true);

            const fetchAllStoresData = useCallback(async () => {
                setLoading(true);
                const dataPromises = stores.map(async (store) => {
                    // 各店舗のSquare設定を確認
                    const squareConfig = store.squareConfig;

                    // デモモードチェック
                    if (!squareConfig || squareConfig.accessToken.startsWith('YOUR_SQUARE_ACCESS_TOKEN')) {
                        // サンプルデータ
                        const baseMembers = store.id === 1 ? 85 : 71;
                        return {
                            storeId: store.id,
                            storeName: store.name,
                            data: {
                                totalMembers: Math.floor(baseMembers * 1.1),
                                activeMembers: baseMembers,
                                newMembersThisMonth: Math.floor(Math.random() * 8) + 4,
                                churnedMembers: Math.floor(Math.random() * 4) + 1,
                                churnRate: (Math.random() * 3 + 1.5),
                                expectedRevenue: baseMembers * 10000,
                            }
                        };
                    }

                    // 実際のAPI呼び出し（上記のロジックと同じ）
                    try {
                        const response = await fetch(`${squareConfig.baseUrl}/subscriptions/search`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${squareConfig.accessToken}`,
                                'Content-Type': 'application/json',
                                'Square-Version': '2024-01-18'
                            },
                            body: JSON.stringify({
                                query: {
                                    filter: {
                                        location_ids: [squareConfig.locationId]
                                    }
                                }
                            })
                        });

                        const subsData = await response.json();
                        const subscriptions = subsData.subscriptions || [];
                        const activeSubscriptions = subscriptions.filter(s => s.status === 'ACTIVE');

                        return {
                            storeId: store.id,
                            storeName: store.name,
                            data: {
                                activeMembers: activeSubscriptions.length,
                                expectedRevenue: activeSubscriptions.length * 10000,
                            }
                        };
                    } catch (error) {
                        console.error(`Error fetching data for ${store.name}:`, error);
                        return {
                            storeId: store.id,
                            storeName: store.name,
                            data: { error: error.message }
                        };
                    }
                });

                const results = await Promise.all(dataPromises);
                const dataMap = {};
                results.forEach(result => {
                    dataMap[result.storeId] = result.data;
                });

                setAllStoresData(dataMap);
                setLoading(false);
            }, []);

            useEffect(() => {
                fetchAllStoresData();
                // 5分ごとに更新
                const interval = setInterval(fetchAllStoresData, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, [fetchAllStoresData]);

            return { allStoresData, loading, refreshAllStoresData: fetchAllStoresData };
        };

        // ========================================
        // Googleフォーム日報データ連携
        // ========================================

        const useDailyReportData = () => {
            const [reportData, setReportData] = useState({
                reports: [],
                loading: true,
                error: null,
                lastUpdated: null
            });

            const fetchReportData = useCallback(async () => {
                // デモモード
                if (GOOGLE_FORM_SHEET_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                    // サンプルデータ
                    const sampleData = generateSampleReportData();
                    setReportData({
                        reports: sampleData,
                        loading: false,
                        error: null,
                        lastUpdated: new Date()
                    });
                    return;
                }

                try {
                    const response = await fetch(GOOGLE_FORM_SHEET_URL);
                    if (!response.ok) {
                        throw new Error('Failed to fetch report data');
                    }
                    const data = await response.json();

                    setReportData({
                        reports: data.reports || [],
                        loading: false,
                        error: null,
                        lastUpdated: new Date()
                    });
                } catch (error) {
                    console.error('Report fetch error:', error);
                    setReportData(prev => ({
                        ...prev,
                        loading: false,
                        error: error.message
                    }));
                }
            }, []);

            useEffect(() => {
                fetchReportData();
            }, [fetchReportData]);

            return { reportData, refreshReportData: fetchReportData };
        };

        // サンプル日報データ生成
        const generateSampleReportData = () => {
            const reports = [];
            const storeNames = ['新宿店', '渋谷店'];
            const now = new Date();

            for (let i = 0; i < 30; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);

                storeNames.forEach(store => {
                    reports.push({
                        timestamp: date.toISOString(),
                        store: store,
                        hpbNew: Math.floor(Math.random() * 5),
                        metaNew: Math.floor(Math.random() * 4),
                        referralNew: Math.floor(Math.random() * 3),
                        discountNew: Math.floor(Math.random() * 2),
                        hpbContract: Math.floor(Math.random() * 3),
                        metaContract: Math.floor(Math.random() * 2),
                        referralContract: Math.floor(Math.random() * 2),
                        discountContract: Math.floor(Math.random() * 1),
                        existingTreatments: Math.floor(Math.random() * 15) + 5,
                        dailyTasksCompleted: Math.random() > 0.1,
                        tomorrowPrepCompleted: Math.random() > 0.15
                    });
                });
            }

            return reports;
        };

        // ========================================
        // ダッシュボードメインビュー
        // ========================================

        const DashboardView = ({ reportData, selectedStore, setSelectedStore }) => {
            const [dateRange, setDateRange] = useState('month'); // 'week', 'month', 'quarter'

            // 選択された店舗のSquareデータを取得
            const selectedStoreObj = stores.find(s => s.name === selectedStore);
            const { memberData } = useSquareData(selectedStore === 'all' ? null : selectedStoreObj?.id);
            const { allStoresData } = useAllStoresSquareData();

            // 全店舗のSquareデータを集計
            const aggregatedMemberData = useMemo(() => {
                if (selectedStore === 'all') {
                    const totalData = {
                        totalMembers: 0,
                        activeMembers: 0,
                        newMembersThisMonth: 0,
                        churnedMembers: 0,
                        expectedRevenue: 0,
                    };

                    Object.values(allStoresData).forEach(storeData => {
                        totalData.totalMembers += storeData.totalMembers || 0;
                        totalData.activeMembers += storeData.activeMembers || 0;
                        totalData.newMembersThisMonth += storeData.newMembersThisMonth || 0;
                        totalData.churnedMembers += storeData.churnedMembers || 0;
                        totalData.expectedRevenue += storeData.expectedRevenue || 0;
                    });

                    totalData.churnRate = totalData.totalMembers > 0
                        ? (totalData.churnedMembers / totalData.totalMembers * 100)
                        : 0;

                    return totalData;
                }
                return memberData;
            }, [selectedStore, memberData, allStoresData]);

            if (!window.Recharts) return <div className="p-8 text-center">チャートを読み込み中...</div>;

            // 日報データの集計
            const aggregatedData = useMemo(() => {
                if (!reportData.reports || reportData.reports.length === 0) {
                    return {
                        totalNewVisits: 0,
                        totalContracts: 0,
                        totalTreatments: 0,
                        conversionRate: 0,
                        byChannel: [],
                        byStore: [],
                        dailyTrend: []
                    };
                }

                let filtered = reportData.reports;
                if (selectedStore !== 'all') {
                    filtered = filtered.filter(r => r.store === selectedStore);
                }

                // 期間フィルタ
                const now = new Date();
                const startDate = new Date();
                switch (dateRange) {
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                }
                filtered = filtered.filter(r => new Date(r.timestamp) >= startDate);

                // チャネル別集計
                const channels = [
                    { name: 'HPB', newKey: 'hpbNew', contractKey: 'hpbContract', color: '#f97316' },
                    { name: 'Meta', newKey: 'metaNew', contractKey: 'metaContract', color: '#3b82f6' },
                    { name: '紹介', newKey: 'referralNew', contractKey: 'referralContract', color: '#22c55e' },
                    { name: '割引集客', newKey: 'discountNew', contractKey: 'discountContract', color: '#a855f7' }
                ];

                const byChannel = channels.map(ch => {
                    const newCount = filtered.reduce((sum, r) => sum + (r[ch.newKey] || 0), 0);
                    const contractCount = filtered.reduce((sum, r) => sum + (r[ch.contractKey] || 0), 0);
                    return {
                        name: ch.name,
                        new: newCount,
                        contract: contractCount,
                        rate: newCount > 0 ? (contractCount / newCount * 100).toFixed(1) : 0,
                        color: ch.color
                    };
                });

                // 店舗別集計
                const storeMap = {};
                filtered.forEach(r => {
                    if (!storeMap[r.store]) {
                        storeMap[r.store] = { store: r.store, new: 0, contract: 0, treatments: 0 };
                    }
                    storeMap[r.store].new += (r.hpbNew || 0) + (r.metaNew || 0) + (r.referralNew || 0) + (r.discountNew || 0);
                    storeMap[r.store].contract += (r.hpbContract || 0) + (r.metaContract || 0) + (r.referralContract || 0) + (r.discountContract || 0);
                    storeMap[r.store].treatments += r.existingTreatments || 0;
                });
                const byStore = Object.values(storeMap);

                // 日別推移
                const dailyMap = {};
                filtered.forEach(r => {
                    const dateKey = new Date(r.timestamp).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                    if (!dailyMap[dateKey]) {
                        dailyMap[dateKey] = { date: dateKey, new: 0, contract: 0, treatments: 0 };
                    }
                    dailyMap[dateKey].new += (r.hpbNew || 0) + (r.metaNew || 0) + (r.referralNew || 0) + (r.discountNew || 0);
                    dailyMap[dateKey].contract += (r.hpbContract || 0) + (r.metaContract || 0) + (r.referralContract || 0) + (r.discountContract || 0);
                    dailyMap[dateKey].treatments += r.existingTreatments || 0;
                });
                const dailyTrend = Object.values(dailyMap).slice(-14);

                const totalNew = byChannel.reduce((sum, ch) => sum + ch.new, 0);
                const totalContract = byChannel.reduce((sum, ch) => sum + ch.contract, 0);
                const totalTreatments = filtered.reduce((sum, r) => sum + (r.existingTreatments || 0), 0);

                return {
                    totalNewVisits: totalNew,
                    totalContracts: totalContract,
                    totalTreatments: totalTreatments,
                    conversionRate: totalNew > 0 ? (totalContract / totalNew * 100) : 0,
                    byChannel,
                    byStore,
                    dailyTrend
                };
            }, [reportData.reports, selectedStore, dateRange]);

            const CHART_COLORS = ['#22c55e', '#4ade80', '#86efac', '#16a34a', '#f97316', '#a855f7'];

            return (
                <div className="space-y-6">
                    {/* フィルターバー */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <label className="text-sm font-medium text-slate-600">店舗:</label>
                                <select
                                    value={selectedStore}
                                    onChange={(e) => setSelectedStore(e.target.value)}
                                    className="px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                >
                                    <option value="all">全店舗</option>
                                    {stores.map(s => (
                                        <option key={s.id} value={s.name}>{s.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex items-center gap-2">
                                {['week', 'month', 'quarter'].map(range => (
                                    <button
                                        key={range}
                                        onClick={() => setDateRange(range)}
                                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                            dateRange === range
                                                ? 'bg-sise-500 text-white'
                                                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                        }`}
                                    >
                                        {range === 'week' ? '1週間' : range === 'month' ? '1ヶ月' : '3ヶ月'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Square会員データ KPIカード */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KpiCard
                            title="アクティブ会員数"
                            value={formatNumber(aggregatedMemberData.activeMembers)}
                            subValue={`総会員: ${formatNumber(aggregatedMemberData.totalMembers)}人`}
                            trend={null}
                            icon="users"
                            color="bg-sise-500"
                        />
                        <KpiCard
                            title="今月の想定売上"
                            value={formatCurrency(aggregatedMemberData.expectedRevenue)}
                            subValue="サブスク収益"
                            trend={null}
                            icon="wallet"
                            color="bg-green-500"
                        />
                        <KpiCard
                            title="今月の新規会員"
                            value={formatNumber(aggregatedMemberData.newMembersThisMonth)}
                            subValue="入会者数"
                            trend={null}
                            icon="user-plus"
                            color="bg-blue-500"
                        />
                        <KpiCard
                            title="退会率"
                            value={formatPercent(aggregatedMemberData.churnRate)}
                            subValue={`退会者: ${aggregatedMemberData.churnedMembers}人`}
                            trend={aggregatedMemberData.churnRate > 5 ? null : null}
                            icon="user-minus"
                            color={aggregatedMemberData.churnRate > 5 ? "bg-red-500" : "bg-slate-500"}
                        />
                    </div>

                    {/* 日報集計 KPIカード */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KpiCard
                            title="新規来店数"
                            value={formatNumber(aggregatedData.totalNewVisits)}
                            subValue="全チャネル合計"
                            trend={null}
                            icon="user-check"
                            color="bg-orange-500"
                        />
                        <KpiCard
                            title="契約数"
                            value={formatNumber(aggregatedData.totalContracts)}
                            subValue="新規契約"
                            trend={null}
                            icon="file-signature"
                            color="bg-purple-500"
                        />
                        <KpiCard
                            title="成約率"
                            value={formatPercent(aggregatedData.conversionRate)}
                            subValue="新規→契約"
                            trend={null}
                            icon="target"
                            color="bg-teal-500"
                        />
                        <KpiCard
                            title="既存施術数"
                            value={formatNumber(aggregatedData.totalTreatments)}
                            subValue="リピーター対応"
                            trend={null}
                            icon="heart-handshake"
                            color="bg-rose-500"
                        />
                    </div>

                    {/* チャート */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* チャネル別成績 */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">チャネル別新規・契約数</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={aggregatedData.byChannel}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="name" tick={{ fontSize: 12 }} />
                                    <YAxis tick={{ fontSize: 12 }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0' }}
                                        formatter={(value, name) => [value, name === 'new' ? '新規' : '契約']}
                                    />
                                    <Legend formatter={(value) => value === 'new' ? '新規数' : '契約数'} />
                                    <Bar dataKey="new" name="new" fill="#4ade80" radius={[4, 4, 0, 0]} />
                                    <Bar dataKey="contract" name="contract" fill="#22c55e" radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </Card>

                        {/* 日別推移 */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">日別推移</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={aggregatedData.dailyTrend}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="date" tick={{ fontSize: 10 }} />
                                    <YAxis tick={{ fontSize: 12 }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0' }}
                                    />
                                    <Legend />
                                    <Line type="monotone" dataKey="new" name="新規" stroke="#4ade80" strokeWidth={2} dot={{ r: 3 }} />
                                    <Line type="monotone" dataKey="contract" name="契約" stroke="#22c55e" strokeWidth={2} dot={{ r: 3 }} />
                                    <Line type="monotone" dataKey="treatments" name="施術" stroke="#86efac" strokeWidth={2} dot={{ r: 3 }} />
                                </LineChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>

                    {/* チャネル別成約率テーブル */}
                    <Card>
                        <h3 className="text-lg font-bold text-slate-900 mb-4">チャネル別パフォーマンス</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-200">
                                        <th className="text-left py-3 px-4 text-sm font-semibold text-slate-600">チャネル</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">新規数</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">契約数</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">成約率</th>
                                        <th className="text-left py-3 px-4 text-sm font-semibold text-slate-600">進捗</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {aggregatedData.byChannel.map((ch, index) => (
                                        <tr key={ch.name} className="border-b border-slate-100 hover:bg-slate-50">
                                            <td className="py-3 px-4">
                                                <div className="flex items-center">
                                                    <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: ch.color }}></div>
                                                    <span className="font-medium text-slate-900">{ch.name}</span>
                                                </div>
                                            </td>
                                            <td className="text-right py-3 px-4 text-slate-700">{ch.new}人</td>
                                            <td className="text-right py-3 px-4 text-slate-700">{ch.contract}人</td>
                                            <td className="text-right py-3 px-4">
                                                <span className={`font-semibold ${parseFloat(ch.rate) >= 50 ? 'text-green-600' : parseFloat(ch.rate) >= 30 ? 'text-yellow-600' : 'text-red-500'}`}>
                                                    {ch.rate}%
                                                </span>
                                            </td>
                                            <td className="py-3 px-4">
                                                <div className="w-full bg-slate-200 rounded-full h-2">
                                                    <div
                                                        className="h-2 rounded-full transition-all"
                                                        style={{ width: `${Math.min(parseFloat(ch.rate), 100)}%`, backgroundColor: ch.color }}
                                                    ></div>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {/* 店舗別サマリ */}
                    {aggregatedData.byStore.length > 1 && (
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">店舗別サマリ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {aggregatedData.byStore.map((store, index) => (
                                    <div key={store.store} className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                        <h4 className="font-semibold text-slate-900 mb-3 flex items-center">
                                            <Icon name="building-2" size={18} className="mr-2 text-sise-500" />
                                            {store.store}
                                        </h4>
                                        <div className="grid grid-cols-3 gap-4 text-center">
                                            <div>
                                                <p className="text-2xl font-bold text-sise-600">{store.new}</p>
                                                <p className="text-xs text-slate-500">新規</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-bold text-green-600">{store.contract}</p>
                                                <p className="text-xs text-slate-500">契約</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-bold text-orange-600">{store.treatments}</p>
                                                <p className="text-xs text-slate-500">施術</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // ========================================
        // 日報一覧ビュー
        // ========================================

        const DailyReportListView = ({ reportData }) => {
            const [filterStore, setFilterStore] = useState('all');
            const [sortOrder, setSortOrder] = useState('desc');

            const filteredReports = useMemo(() => {
                let reports = reportData.reports || [];
                if (filterStore !== 'all') {
                    reports = reports.filter(r => r.store === filterStore);
                }
                return reports.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });
            }, [reportData.reports, filterStore, sortOrder]);

            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-xl font-bold text-slate-900">日報一覧</h2>
                        <div className="flex items-center gap-3">
                            <select
                                value={filterStore}
                                onChange={(e) => setFilterStore(e.target.value)}
                                className="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:border-sise-500 outline-none"
                            >
                                <option value="all">全店舗</option>
                                {stores.map(s => (
                                    <option key={s.id} value={s.name}>{s.name}</option>
                                ))}
                            </select>
                            <button
                                onClick={() => setSortOrder(sortOrder === 'desc' ? 'asc' : 'desc')}
                                className="flex items-center px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50"
                            >
                                <Icon name={sortOrder === 'desc' ? 'arrow-down' : 'arrow-up'} size={16} className="mr-1" />
                                {sortOrder === 'desc' ? '新しい順' : '古い順'}
                            </button>
                        </div>
                    </div>

                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-200 bg-slate-50">
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">日時</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">店舗</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">HPB<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">Meta<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">紹介<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">割引<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">既存<br/>施術</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">業務</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">準備</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredReports.slice(0, 50).map((report, index) => (
                                        <tr key={index} className="border-b border-slate-100 hover:bg-slate-50">
                                            <td className="py-3 px-3 text-slate-700">
                                                {new Date(report.timestamp).toLocaleDateString('ja-JP', {
                                                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                                })}
                                            </td>
                                            <td className="py-3 px-3">
                                                <span className="px-2 py-1 bg-sise-100 text-sise-700 rounded text-xs font-medium">
                                                    {report.store}
                                                </span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-orange-600">{report.hpbNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.hpbContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-blue-600">{report.metaNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.metaContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-emerald-600">{report.referralNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.referralContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-purple-600">{report.discountNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.discountContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2 font-semibold text-slate-700">
                                                {report.existingTreatments}
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                {report.dailyTasksCompleted ? (
                                                    <span className="text-green-500"><Icon name="check-circle" size={18} /></span>
                                                ) : (
                                                    <span className="text-red-400"><Icon name="x-circle" size={18} /></span>
                                                )}
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                {report.tomorrowPrepCompleted ? (
                                                    <span className="text-green-500"><Icon name="check-circle" size={18} /></span>
                                                ) : (
                                                    <span className="text-red-400"><Icon name="x-circle" size={18} /></span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredReports.length > 50 && (
                            <div className="text-center py-4 text-sm text-slate-500">
                                最新50件を表示中（全{filteredReports.length}件）
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        // ========================================
        // 会員管理ビュー（Square連携）
        // ========================================

        const MemberManagementView = ({ selectedStore, setSelectedStore }) => {
            const [isRefreshing, setIsRefreshing] = useState(false);

            // 選択された店舗のSquareデータを取得
            const selectedStoreObj = stores.find(s => s.name === selectedStore);
            const { memberData, refreshSquareData } = useSquareData(selectedStore === 'all' ? null : selectedStoreObj?.id);
            const { allStoresData } = useAllStoresSquareData();

            // 全店舗のSquareデータを集計
            const aggregatedMemberData = useMemo(() => {
                if (selectedStore === 'all') {
                    const totalData = {
                        totalMembers: 0,
                        activeMembers: 0,
                        newMembersThisMonth: 0,
                        churnedMembers: 0,
                        expectedRevenue: 0,
                    };

                    Object.values(allStoresData).forEach(storeData => {
                        totalData.totalMembers += storeData.totalMembers || 0;
                        totalData.activeMembers += storeData.activeMembers || 0;
                        totalData.newMembersThisMonth += storeData.newMembersThisMonth || 0;
                        totalData.churnedMembers += storeData.churnedMembers || 0;
                        totalData.expectedRevenue += storeData.expectedRevenue || 0;
                    });

                    totalData.churnRate = totalData.totalMembers > 0
                        ? (totalData.churnedMembers / totalData.totalMembers * 100)
                        : 0;

                    return totalData;
                }
                return memberData;
            }, [selectedStore, memberData, allStoresData]);

            const handleRefresh = async () => {
                setIsRefreshing(true);
                await refreshSquareData();
                setIsRefreshing(false);
            };

            // 月額単価（設定可能にする）
            const monthlyPrice = 10000;

            // LTV計算（平均継続月数を仮定）
            const avgRetentionMonths = aggregatedMemberData.churnRate > 0 ? Math.round(100 / aggregatedMemberData.churnRate) : 24;
            const estimatedLTV = monthlyPrice * avgRetentionMonths;

            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-slate-900">会員管理</h2>
                            <p className="text-sm text-slate-500 mt-1">Square連携データ</p>
                        </div>
                        <div className="flex items-center gap-3">
                            <select
                                value={selectedStore}
                                onChange={(e) => setSelectedStore(e.target.value)}
                                className="px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                            >
                                <option value="all">全店舗</option>
                                {stores.map(s => (
                                    <option key={s.id} value={s.name}>{s.name}</option>
                                ))}
                            </select>
                            <button
                                onClick={handleRefresh}
                                disabled={isRefreshing}
                                className="flex items-center px-4 py-2 bg-sise-500 hover:bg-sise-600 text-white rounded-lg font-medium shadow-sm transition-colors disabled:opacity-50"
                            >
                                <Icon name={isRefreshing ? "loader" : "refresh-cw"} size={18} className={`mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                                {isRefreshing ? '更新中...' : 'データ更新'}
                            </button>
                        </div>
                    </div>

                    {memberData.error && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p className="text-red-700 text-sm">
                                <Icon name="alert-circle" size={16} className="inline mr-2" />
                                エラー: {memberData.error}
                            </p>
                        </div>
                    )}

                    {/* 会員サマリ */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <Card className="bg-gradient-to-br from-sise-50 to-sise-100 border-sise-200">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-sise-700">アクティブ会員</span>
                                <Icon name="users" size={20} className="text-sise-500" />
                            </div>
                            <p className="text-3xl font-bold text-sise-900">{aggregatedMemberData.activeMembers}</p>
                            <p className="text-xs text-sise-600 mt-1">累計: {aggregatedMemberData.totalMembers}人</p>
                        </Card>

                        <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-green-700">月間想定売上</span>
                                <Icon name="trending-up" size={20} className="text-green-500" />
                            </div>
                            <p className="text-3xl font-bold text-green-900">{formatCurrency(aggregatedMemberData.expectedRevenue)}</p>
                            <p className="text-xs text-green-600 mt-1">@{formatCurrency(monthlyPrice)}/月</p>
                        </Card>

                        <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-blue-700">今月の新規入会</span>
                                <Icon name="user-plus" size={20} className="text-blue-500" />
                            </div>
                            <p className="text-3xl font-bold text-blue-900">{aggregatedMemberData.newMembersThisMonth}</p>
                            <p className="text-xs text-blue-600 mt-1">新規獲得</p>
                        </Card>

                        <Card className={`bg-gradient-to-br ${aggregatedMemberData.churnRate > 5 ? 'from-red-50 to-red-100 border-red-200' : 'from-slate-50 to-slate-100 border-slate-200'}`}>
                            <div className="flex items-center justify-between mb-2">
                                <span className={`text-sm font-medium ${aggregatedMemberData.churnRate > 5 ? 'text-red-700' : 'text-slate-700'}`}>退会率</span>
                                <Icon name="user-minus" size={20} className={aggregatedMemberData.churnRate > 5 ? 'text-red-500' : 'text-slate-500'} />
                            </div>
                            <p className={`text-3xl font-bold ${aggregatedMemberData.churnRate > 5 ? 'text-red-900' : 'text-slate-900'}`}>
                                {formatPercent(aggregatedMemberData.churnRate)}
                            </p>
                            <p className={`text-xs mt-1 ${aggregatedMemberData.churnRate > 5 ? 'text-red-600' : 'text-slate-600'}`}>
                                退会者: {aggregatedMemberData.churnedMembers}人
                            </p>
                        </Card>
                    </div>

                    {/* 分析カード */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">収益分析</h3>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">月額単価</span>
                                    <span className="font-bold text-slate-900">{formatCurrency(monthlyPrice)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">年間想定売上</span>
                                    <span className="font-bold text-green-600">{formatCurrency(aggregatedMemberData.expectedRevenue * 12)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">平均継続期間</span>
                                    <span className="font-bold text-slate-900">約{avgRetentionMonths}ヶ月</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-sise-50 rounded-lg border border-sise-200">
                                    <span className="text-sise-700 font-medium">推定LTV</span>
                                    <span className="font-bold text-sise-900">{formatCurrency(estimatedLTV)}</span>
                                </div>
                            </div>
                        </Card>

                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">KPIトレンド</h3>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-slate-600">会員維持率</span>
                                        <span className="font-semibold text-green-600">{formatPercent(100 - aggregatedMemberData.churnRate)}</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-2">
                                        <div
                                            className="bg-green-500 h-2 rounded-full transition-all"
                                            style={{ width: `${100 - aggregatedMemberData.churnRate}%` }}
                                        ></div>
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-slate-600">目標会員数達成率</span>
                                        <span className="font-semibold text-sise-600">{formatPercent(aggregatedMemberData.activeMembers / 200 * 100)}</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-2">
                                        <div
                                            className="bg-sise-500 h-2 rounded-full transition-all"
                                            style={{ width: `${Math.min(aggregatedMemberData.activeMembers / 200 * 100, 100)}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">目標: 200人</p>
                                </div>
                            </div>
                        </Card>
                    </div>

                    {/* 設定情報 */}
                    <Card className="bg-slate-50 border-slate-300">
                        <div className="flex items-start">
                            <Icon name="info" size={20} className="text-sise-500 mr-3 mt-0.5" />
                            <div>
                                <h4 className="font-semibold text-slate-900 mb-2">Square API連携について</h4>
                                <p className="text-sm text-slate-600 mb-2">
                                    このダッシュボードはSquare APIと連携して会員データを取得します。
                                    実際のデータを表示するには、以下の設定が必要です：
                                </p>
                                <ul className="text-sm text-slate-600 list-disc list-inside space-y-1">
                                    <li>Square Developer Accountでアプリを作成</li>
                                    <li>Customers API、Subscriptions APIの権限を付与</li>
                                    <li>アクセストークンとロケーションIDを設定</li>
                                </ul>
                                <p className="text-xs text-slate-500 mt-3">
                                    現在はデモモードで動作しています。
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // ========================================
        // 設定ビュー
        // ========================================

        const SettingsView = () => {
            const [googleFormUrl, setGoogleFormUrl] = useState(GOOGLE_FORM_SHEET_URL);
            const [squareToken, setSquareToken] = useState('');
            const [squareLocationId, setSquareLocationId] = useState('');
            const [monthlyPrice, setMonthlyPrice] = useState(10000);

            return (
                <div className="space-y-6">
                    <h2 className="text-xl font-bold text-slate-900">設定</h2>

                    <Card>
                        <h3 className="text-lg font-semibold text-slate-900 mb-4">Googleフォーム連携</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Google Apps Script Web App URL
                                </label>
                                <input
                                    type="url"
                                    value={googleFormUrl}
                                    onChange={(e) => setGoogleFormUrl(e.target.value)}
                                    className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                    placeholder="https://script.google.com/macros/s/..."
                                />
                                <p className="text-xs text-slate-500 mt-1">
                                    Googleフォームの回答を取得するGASのデプロイURLを入力してください
                                </p>
                            </div>
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-lg font-semibold text-slate-900 mb-4">Square API連携</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    アクセストークン
                                </label>
                                <input
                                    type="password"
                                    value={squareToken}
                                    onChange={(e) => setSquareToken(e.target.value)}
                                    className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                    placeholder="sq0atp-..."
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    ロケーションID
                                </label>
                                <input
                                    type="text"
                                    value={squareLocationId}
                                    onChange={(e) => setSquareLocationId(e.target.value)}
                                    className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                    placeholder="L..."
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    サブスク月額（円）
                                </label>
                                <input
                                    type="number"
                                    value={monthlyPrice}
                                    onChange={(e) => setMonthlyPrice(Number(e.target.value))}
                                    className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                />
                            </div>
                        </div>
                    </Card>

                    <Card className="bg-amber-50 border-amber-200">
                        <div className="flex items-start">
                            <Icon name="alert-triangle" size={20} className="text-amber-500 mr-3 mt-0.5" />
                            <div>
                                <h4 className="font-semibold text-amber-900 mb-1">注意</h4>
                                <p className="text-sm text-amber-700">
                                    このページで入力した設定は、ブラウザをリロードするとリセットされます。
                                    本番環境では、HTMLファイル内の定数を直接編集してください。
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // ========================================
        // メインアプリケーション
        // ========================================

        const App = () => {
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedStore, setSelectedStore] = useState('all');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(false);

            // 日報データ取得
            const { reportData, refreshReportData } = useDailyReportData();
            // 全店舗のSquareデータを取得
            const { allStoresData, refreshAllStoresData } = useAllStoresSquareData();

            // ダークモード切り替え
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);

            const navItems = [
                { id: 'dashboard', label: 'ダッシュボード', icon: 'layout-dashboard' },
                { id: 'reports', label: '日報一覧', icon: 'clipboard-list' },
                { id: 'members', label: '会員管理', icon: 'users' },
                { id: 'settings', label: '設定', icon: 'settings' },
            ];

            const renderView = () => {
                switch (currentView) {
                    case 'dashboard':
                        return <DashboardView
                            reportData={reportData}
                            selectedStore={selectedStore}
                            setSelectedStore={setSelectedStore}
                        />;
                    case 'reports':
                        return <DailyReportListView reportData={reportData} />;
                    case 'members':
                        return <MemberManagementView selectedStore={selectedStore} setSelectedStore={setSelectedStore} />;
                    case 'settings':
                        return <SettingsView />;
                    default:
                        return <DashboardView
                            reportData={reportData}
                            selectedStore={selectedStore}
                            setSelectedStore={setSelectedStore}
                        />;
                }
            };

            return (
                <div className="min-h-screen bg-slate-50">
                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm border-b border-slate-200 safe-top">
                        <div className="flex items-center justify-between px-4 h-16">
                            <div className="flex items-center">
                                <button
                                    onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                    className="lg:hidden p-2 rounded-lg hover:bg-slate-100 mr-2"
                                >
                                    <Icon name="menu" size={24} />
                                </button>
                                <div className="flex items-center">
                                    <div className="w-10 h-10 bg-gradient-to-br from-sise-400 to-sise-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-md">
                                        S
                                    </div>
                                    <div className="ml-3">
                                        <h1 className="text-lg font-bold text-slate-900">si'se</h1>
                                        <p className="text-xs text-slate-500 -mt-0.5">整体院ダッシュボード</p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => { refreshReportData(); refreshAllStoresData(); }}
                                    className="p-2 rounded-lg hover:bg-slate-100 text-slate-600"
                                    title="データ更新"
                                >
                                    <Icon name="refresh-cw" size={20} />
                                </button>
                                <button
                                    onClick={() => setIsDarkMode(!isDarkMode)}
                                    className="p-2 rounded-lg hover:bg-slate-100 text-slate-600"
                                    title="ダークモード切り替え"
                                >
                                    <Icon name={isDarkMode ? 'sun' : 'moon'} size={20} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Sidebar Overlay (Mobile) */}
                    {isSidebarOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-40 lg:hidden"
                            onClick={() => setIsSidebarOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`fixed top-16 left-0 bottom-0 w-64 bg-white border-r border-slate-200 z-40 transform transition-transform duration-300 lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <nav className="p-4 space-y-1">
                            {navItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => {
                                        setCurrentView(item.id);
                                        setIsSidebarOpen(false);
                                    }}
                                    className={`w-full flex items-center px-4 py-3 rounded-lg text-left font-medium transition-colors ${
                                        currentView === item.id
                                            ? 'bg-sise-50 text-sise-700 border-l-4 border-sise-500'
                                            : 'text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <Icon name={item.icon} size={20} className="mr-3" />
                                    {item.label}
                                </button>
                            ))}
                        </nav>

                        {/* データ更新時刻 */}
                        <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-200 bg-slate-50">
                            <p className="text-xs text-slate-500">
                                最終更新: {reportData.lastUpdated
                                    ? reportData.lastUpdated.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
                                    : '-'
                                }
                            </p>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="pt-16 lg:pl-64 min-h-screen">
                        <div className="p-4 lg:p-6 max-w-7xl mx-auto safe-bottom">
                            {memberData.loading || reportData.loading ? (
                                <div className="flex items-center justify-center h-64">
                                    <div className="text-center">
                                        <div className="w-12 h-12 border-4 border-sise-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                                        <p className="text-slate-600">データを読み込み中...</p>
                                    </div>
                                </div>
                            ) : (
                                renderView()
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // アプリケーションのレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
