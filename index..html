<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LuxeMetrics - é«˜ç´šã‚¨ã‚¹ãƒ†ã‚µãƒ­ãƒ³çµŒå–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts Dependencies -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <!-- Recharts (Chart Library) - Pinned version for stability -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config for Tailwind (Luxury Gold Theme) -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode with class strategy
            theme: {
                extend: {
                    colors: {
                        gold: {
                            50: '#fbf9f1',
                            100: '#f5f0db',
                            200: '#ede0b3',
                            300: '#e3cc83',
                            400: '#d9b656',
                            500: '#d4af37', // Brand Primary
                            600: '#b48e26',
                            700: '#906d1f',
                            800: '#775820',
                            900: '#624920',
                        },
                        brown: {
                            50: '#f7f5f3',
                            800: '#4a3b32', // Brand Text
                            900: '#2d241e',
                        },
                        accent: {
                            500: '#c084fc', // Subtle accent for charts
                        }
                    },
                    fontFamily: {
                        sans: ['"Yu Mincho"', '"Hiragino Mincho ProN"', '"MS PMincho"', 'serif'], // Serif for luxury feel
                        ui: ['"Helvetica Neue"', 'Arial', 'sans-serif'], // UI font
                    }
                }
            }
        }
    </script>
    <style>
        /* Base Styles */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background-color: #f7f5f3; /* brown-50 */
            color: #4a3b32; /* brown-800 */
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior-y: contain;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode Styles - Optimized for Eye Comfort and Visibility */
        .dark body {
            background-color: #1a1a1a;
            color: #e5e5e5;
        }

        /* Background Colors - Softer and More Visible */
        .dark .bg-brown-50,
        .dark .bg-\[#f9f8f4\] {
            background-color: #1a1a1a !important;
        }

        .dark .bg-white {
            background-color: #2d2d2d !important;
        }

        .dark .bg-gray-50 {
            background-color: #2a2a2a !important;
        }

        .dark .bg-gray-100 {
            background-color: #333333 !important;
        }

        .dark .bg-gray-200 {
            background-color: #3d3d3d !important;
        }

        /* Text Colors - High Contrast for Readability */
        .dark .text-brown-800 {
            color: #f0f0f0 !important;
        }

        .dark .text-gray-900 {
            color: #f5f5f5 !important;
        }

        .dark .text-gray-800 {
            color: #e8e8e8 !important;
        }

        .dark .text-gray-700 {
            color: #d8d8d8 !important;
        }

        .dark .text-gray-600 {
            color: #c0c0c0 !important;
        }

        .dark .text-gray-500 {
            color: #a8a8a8 !important;
        }

        .dark .text-gray-400 {
            color: #909090 !important;
        }

        .dark .text-gray-300 {
            color: #787878 !important;
        }

        /* Border Colors - Clear and Visible */
        .dark .border-gray-100 {
            border-color: #3d3d3d !important;
        }

        .dark .border-gray-200 {
            border-color: #4a4a4a !important;
        }

        .dark .border-gray-300 {
            border-color: #555555 !important;
        }

        .dark .border-gold-100 {
            border-color: #6a5228 !important;
        }

        .dark .border-gold-200 {
            border-color: #8a6a38 !important;
        }

        .dark .divide-gray-100 > * + * {
            border-color: #3d3d3d !important;
        }

        /* Gold Accent Colors - Brighter and More Vibrant */
        .dark .bg-gold-50 {
            background-color: #3a3020 !important;
        }

        .dark .bg-gold-100 {
            background-color: #4a3d28 !important;
        }

        .dark .text-gold-600 {
            color: #f0c955 !important;
        }

        .dark .text-gold-500 {
            color: #f5d45e !important;
        }

        /* Form Inputs - Clear and Readable */
        .dark input,
        .dark select,
        .dark textarea {
            background-color: #333333 !important;
            border-color: #555555 !important;
            color: #e8e8e8 !important;
        }

        .dark input:focus,
        .dark select:focus,
        .dark textarea:focus {
            background-color: #3a3a3a !important;
            border-color: #d4af37 !important;
        }

        .dark input::placeholder,
        .dark textarea::placeholder {
            color: #808080 !important;
        }

        /* Hover States - Visible Feedback */
        .dark .hover\:bg-gray-100:hover {
            background-color: #333333 !important;
        }

        .dark .hover\:bg-gray-50:hover {
            background-color: #2a2a2a !important;
        }

        .dark .hover\:bg-white:hover {
            background-color: #353535 !important;
        }

        .dark .hover\:bg-gold-50:hover {
            background-color: #4a3d28 !important;
        }

        /* Charts and Data Visualization */
        .dark .recharts-cartesian-grid-horizontal line,
        .dark .recharts-cartesian-grid-vertical line {
            stroke: #444444 !important;
        }

        .dark .recharts-text {
            fill: #c0c0c0 !important;
        }

        .dark .recharts-tooltip-wrapper {
            background-color: #2d2d2d !important;
        }

        /* Color Variants for Data Display - More Vibrant */
        .dark .bg-blue-50 {
            background-color: #263548 !important;
        }

        .dark .bg-blue-100 {
            background-color: #2f4158 !important;
        }

        .dark .bg-purple-50 {
            background-color: #3a2848 !important;
        }

        .dark .bg-purple-100 {
            background-color: #483458 !important;
        }

        .dark .bg-emerald-50 {
            background-color: #264232 !important;
        }

        .dark .bg-emerald-100 {
            background-color: #2f5040 !important;
        }

        .dark .bg-amber-50 {
            background-color: #423528 !important;
        }

        .dark .bg-amber-100 {
            background-color: #524335 !important;
        }

        .dark .bg-rose-50 {
            background-color: #422630 !important;
        }

        .dark .bg-rose-100 {
            background-color: #52323e !important;
        }

        .dark .bg-orange-50 {
            background-color: #422f26 !important;
        }

        .dark .bg-orange-100 {
            background-color: #523d32 !important;
        }

        .dark .bg-yellow-50 {
            background-color: #423c26 !important;
        }

        .dark .bg-yellow-100 {
            background-color: #524a32 !important;
        }

        .dark .text-blue-700 {
            color: #7db3ff !important;
        }

        .dark .text-purple-700 {
            color: #c8a6ff !important;
        }

        .dark .text-emerald-700 {
            color: #7de4b8 !important;
        }

        .dark .text-amber-700 {
            color: #ffc85d !important;
        }

        .dark .text-rose-700 {
            color: #ff9fb3 !important;
        }

        /* Border Colors for Data Cards - More Visible */
        .dark .border-blue-200 {
            border-color: #3a5580 !important;
        }

        .dark .border-blue-300 {
            border-color: #4a70a0 !important;
        }

        .dark .border-purple-200 {
            border-color: #553a80 !important;
        }

        .dark .border-purple-300 {
            border-color: #704aa0 !important;
        }

        .dark .border-emerald-200 {
            border-color: #3a8058 !important;
        }

        .dark .border-emerald-300 {
            border-color: #4aa070 !important;
        }

        .dark .border-amber-200 {
            border-color: #806a3a !important;
        }

        .dark .border-amber-300 {
            border-color: #a08a4a !important;
        }

        .dark .border-rose-200 {
            border-color: #803a50 !important;
        }

        .dark .border-rose-300 {
            border-color: #a04a68 !important;
        }

        .dark .border-orange-200 {
            border-color: #805a3a !important;
        }

        .dark .border-orange-300 {
            border-color: #a0754a !important;
        }

        .dark .border-yellow-200 {
            border-color: #80753a !important;
        }

        .dark .border-yellow-300 {
            border-color: #a0954a !important;
        }

        /* Shadows - Softer and More Visible */
        .dark .shadow-sm {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4) !important;
        }

        .dark .shadow {
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.3), 0 1px 2px -1px rgba(0, 0, 0, 0.3) !important;
        }

        .dark .shadow-md {
            box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.35), 0 2px 4px -2px rgba(0, 0, 0, 0.35) !important;
        }

        .dark .shadow-lg {
            box-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.4), 0 4px 8px -4px rgba(0, 0, 0, 0.4) !important;
        }

        .dark .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }

        /* Backdrop and Overlays */
        .dark .bg-black\/50 {
            background-color: rgba(0, 0, 0, 0.85) !important;
        }

        .dark .bg-white\/20 {
            background-color: rgba(255, 255, 255, 0.12) !important;
        }

        .dark .bg-white\/95 {
            background-color: rgba(45, 45, 45, 0.95) !important;
        }

        /* Header and Navigation */
        .dark header {
            background-color: rgba(45, 45, 45, 0.95) !important;
            border-bottom-color: #4a4a4a !important;
        }

        /* Icons - Better Visibility */
        .dark svg {
            opacity: 1;
        }

        /* Additional Card Styles for Better Separation */
        .dark .bg-gradient-to-br {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Gradient Backgrounds - More Vibrant in Dark Mode */
        .dark .from-gold-50 {
            --tw-gradient-from: #4a3d28 !important;
        }

        .dark .to-gold-100 {
            --tw-gradient-to: #5a4d38 !important;
        }

        .dark .from-blue-50 {
            --tw-gradient-from: #2f4158 !important;
        }

        .dark .to-blue-100 {
            --tw-gradient-to: #3f5168 !important;
        }

        .dark .from-rose-50 {
            --tw-gradient-from: #52323e !important;
        }

        .dark .to-rose-100 {
            --tw-gradient-to: #62424e !important;
        }

        .dark .from-amber-50 {
            --tw-gradient-from: #524335 !important;
        }

        .dark .to-amber-100 {
            --tw-gradient-to: #625345 !important;
        }

        .dark .from-emerald-50 {
            --tw-gradient-from: #2f5040 !important;
        }

        .dark .to-emerald-100 {
            --tw-gradient-to: #3f6050 !important;
        }

        .dark .from-gray-50 {
            --tw-gradient-from: #2a2a2a !important;
        }

        .dark .to-gray-100 {
            --tw-gradient-to: #3a3a3a !important;
        }

        /* Alert/Notification Cards */
        .dark .from-rose-600 {
            --tw-gradient-from: #a04a68 !important;
        }

        .dark .to-rose-700 {
            --tw-gradient-to: #b05a78 !important;
        }

        .dark .from-emerald-600 {
            --tw-gradient-from: #4aa070 !important;
        }

        .dark .to-emerald-700 {
            --tw-gradient-to: #5ab080 !important;
        }

        /* Button Styles - Better Visibility */
        .dark .bg-gold-500 {
            background-color: #c9a847 !important;
        }

        .dark .hover\:bg-gold-600:hover {
            background-color: #d9b857 !important;
        }

        .dark .bg-gold-600 {
            background-color: #d9b857 !important;
        }

        .dark .hover\:bg-gold-700:hover {
            background-color: #e9c867 !important;
        }

        .dark .bg-emerald-500 {
            background-color: #4aba80 !important;
        }

        .dark .hover\:bg-emerald-600:hover {
            background-color: #5aca90 !important;
        }

        .dark .bg-blue-500 {
            background-color: #5a9aff !important;
        }

        .dark .hover\:bg-blue-600:hover {
            background-color: #6aaaff !important;
        }

        .dark .hover\:bg-blue-50:hover {
            background-color: #3f5168 !important;
        }

        .dark .bg-rose-500 {
            background-color: #ff6a8a !important;
        }

        .dark .hover\:bg-rose-600:hover {
            background-color: #ff7a9a !important;
        }

        /* Table and List Styles */
        .dark table thead {
            background-color: #3a3a3a !important;
        }

        .dark table tbody tr:hover {
            background-color: #353535 !important;
        }

        /* Progress Bars */
        .dark .bg-emerald-500,
        .dark .bg-gold-500 {
            opacity: 0.9;
        }

        h1, h2, h3, .serif {
            font-family: "Yu Mincho", "Hiragino Mincho ProN", "MS PMincho", serif;
        }

        /* Mobile Typography & Layout */
        @media (max-width: 768px) {
            body {
                font-size: 16px; /* Prevent zoom on input focus */
                line-height: 1.6;
            }

            input, select, textarea {
                font-size: 16px !important; /* Prevent iOS zoom */
            }

            /* Larger touch targets */
            button, a, input[type="button"], input[type="submit"], select {
                min-height: 48px;
            }

            /* Improve scroll performance */
            * {
                -webkit-overflow-scrolling: touch;
            }

            /* Enhanced Mobile Typography */
            .mobile-title {
                font-size: 1.375rem !important; /* 22px */
                font-weight: 700 !important;
                line-height: 1.3 !important;
                letter-spacing: -0.01em !important;
            }

            .mobile-subtitle {
                font-size: 0.9375rem !important; /* 15px */
                line-height: 1.5 !important;
                font-weight: 500 !important;
            }

            .mobile-metric {
                font-size: 2.25rem !important; /* 36px */
                font-weight: 800 !important;
                line-height: 1.1 !important;
                letter-spacing: -0.02em !important;
            }

            .mobile-label {
                font-size: 0.8125rem !important; /* 13px */
                font-weight: 600 !important;
                line-height: 1.4 !important;
            }

            .mobile-body {
                font-size: 0.9375rem !important; /* 15px */
                line-height: 1.6 !important;
            }

            /* Mobile Card Spacing */
            .mobile-card {
                padding: 1rem !important;
                margin-bottom: 0.875rem !important;
                border-radius: 12px !important;
            }

            /* Compact Header */
            .mobile-header {
                height: 56px !important;
                padding: 0 0.75rem !important;
            }

            /* Button Optimization */
            .mobile-btn {
                padding: 0.875rem 1rem !important;
                font-size: 1rem !important;
                font-weight: 600 !important;
                border-radius: 10px !important;
                min-height: 48px !important;
            }

            /* Tab Optimization */
            .mobile-tab {
                padding: 0.625rem 0.875rem !important;
                font-size: 0.875rem !important;
                font-weight: 600 !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 4px;
        }

        /* Range Input */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        input[type=range]:focus {
            outline: none;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        /* Touch Feedback */
        .touch-feedback:active {
            transform: scale(0.97);
            transition: transform 0.1s ease-in-out;
        }

        /* Loading Skeleton */
        @keyframes skeleton-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .skeleton {
            animation: skeleton-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e5e7eb;
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Safe Area Support */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Performance: Hardware Acceleration */
        .hw-accelerate {
            transform: translateZ(0);
            will-change: transform;
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            body {
                color: #000;
            }
            button {
                border: 2px solid currentColor;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- Loading Indicator -->
        <div id="loading-indicator" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f7f5f3;">
            <div style="text-align: center;">
                <div style="width: 50px; height: 50px; border: 5px solid #d4af37; border-top: 5px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #4a3b32; font-size: 16px; font-family: sans-serif;">èª­ã¿è¾¼ã¿ä¸­...</p>
                <p style="color: #999; font-size: 12px; font-family: sans-serif; margin-top: 10px;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
            </div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </div>

    <!-- Dependency Check and Error Display -->
    <script>
        // Check if all required dependencies are loaded
        window.addEventListener('DOMContentLoaded', function() {
            const rootDiv = document.getElementById('root');
            const dependencies = {
                'React': typeof window.React !== 'undefined',
                'ReactDOM': typeof window.ReactDOM !== 'undefined',
                'Babel': typeof window.Babel !== 'undefined',
                'Recharts': typeof window.Recharts !== 'undefined',
                'Tailwind': typeof window.tailwind !== 'undefined',
                'lucide': typeof window.lucide !== 'undefined'
            };

            const missing = Object.keys(dependencies).filter(key => !dependencies[key]);

            if (missing.length > 0) {
                console.error('Missing dependencies:', missing);
                rootDiv.innerHTML = `
                    <div style="padding: 40px; font-family: sans-serif; background: #fff3cd; border: 2px solid #ffc107; margin: 20px; border-radius: 8px;">
                        <h1 style="color: #856404;">âš ï¸ ä¾å­˜é–¢ä¿‚ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</h1>
                        <p style="color: #856404;">ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“:</p>
                        <ul style="color: #856404; font-family: monospace;">
                            ${missing.map(m => `<li>${m}</li>`).join('')}
                        </ul>
                        <p style="color: #856404; margin-top: 20px;">
                            <strong>è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :</strong><br/>
                            1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒåˆ‡ã‚Œã¦ã„ã‚‹<br/>
                            2. CDNã‚µãƒ¼ãƒ“ã‚¹ãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã‚‹<br/>
                            3. ãƒ–ãƒ©ã‚¦ã‚¶ã®æ‹¡å¼µæ©Ÿèƒ½ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹<br/>
                            <br/>
                            <strong>å¯¾å‡¦æ–¹æ³•:</strong><br/>
                            - ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ï¼ˆCtrl+R ã¾ãŸã¯ Cmd+Rï¼‰<br/>
                            - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„<br/>
                            - åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹ã«ã—ã¦ãã ã•ã„
                        </p>
                    </div>
                `;
            } else {
                console.log('All dependencies loaded successfully:', dependencies);
            }
        });
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        // Recharts might be undefined if script fails, handle gracefully
        const RechartsLib = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, AreaChart, Area } = RechartsLib;

        // --- Mock Data Generators ---

        // åº—èˆ—ãƒã‚¹ã‚¿
        const stores = [
            { id: 1, name: "æ–°å®¿åº—", code: "shinjuku" },
            { id: 2, name: "æ–°å®¿å—å£åº—", code: "shinjuku_south" }
        ];

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒã‚¹ã‚¿
        const menus = [
            { id: 1, name: "å‰¥é›¢ã‚ã‚Šãƒãƒ¼ãƒ–ãƒ”ãƒ¼ãƒªãƒ³ã‚°(é¡”)", price: 18000, cost: 3000, availableStores: [1, 2] },
            { id: 2, name: "å‰¥é›¢ãªã—ãƒãƒ¼ãƒ–ãƒ”ãƒ¼ãƒªãƒ³ã‚°(é¡”)", price: 15000, cost: 2500, availableStores: [1, 2] },
            { id: 3, name: "å‰¥é›¢ãªã—ãƒãƒ¼ãƒ–ãƒ”ãƒ¼ãƒªãƒ³ã‚°(ãƒœãƒ‡ã‚£)", price: 20000, cost: 3500, availableStores: [1, 2] },
            { id: 4, name: "ã‚ˆã‚‚ãè’¸ã—", price: 8000, cost: 1500, availableStores: [2] }, // æ–°å®¿å—å£åº—ã®ã¿
            { id: 5, name: "ã‚»ãƒ«ãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°", price: 5000, cost: 800, availableStores: [2] } // æ–°å®¿å—å£åº—ã®ã¿
        ];

        // å…¨è§’æ•°å­—ã‚’åŠè§’æ•°å­—ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const convertToHalfWidth = (str) => {
            if (!str) return str;
            return str.replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
        };

        // æ•°å€¤å…¥åŠ›ç”¨ã®å¤‰æ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        const normalizeNumberInput = (value) => {
            const halfWidth = convertToHalfWidth(String(value));
            return halfWidth.replace(/[^0-9.-]/g, ''); // æ•°å­—ã€ãƒã‚¤ãƒŠã‚¹ã€å°æ•°ç‚¹ã®ã¿è¨±å¯
        };

        // åˆæœŸã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ - è‡ªç”±ã«ç·¨é›†å¯èƒ½ï¼‰
        const initialStaffData = [
            {
                id: 1,
                name: 'ç”°ä¸­ç¾å’²',
                employmentType: 'æ­£ç¤¾å“¡',
                role: 'åº—é•·',
                storeId: 1,
                availableMenus: [1, 2, 3],
                sales: 850000,
                target: 1000000,
                nomination: 25,
                retention: 75,
                reviewScore: 4.8
            },
            {
                id: 2,
                name: 'ä½è—¤èŠ±å­',
                employmentType: 'æ­£ç¤¾å“¡',
                role: 'ã‚¹ã‚¿ãƒƒãƒ•',
                storeId: 1,
                availableMenus: [1, 2],
                sales: 620000,
                target: 800000,
                nomination: 18,
                retention: 68,
                reviewScore: 4.5
            },
            {
                id: 3,
                name: 'éˆ´æœ¨å½©é¦™',
                employmentType: 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ',
                role: 'ã‚¹ã‚¿ãƒƒãƒ•',
                storeId: 2,
                availableMenus: [2, 4, 5],
                sales: 480000,
                target: 600000,
                nomination: 12,
                retention: 65,
                reviewScore: 4.3
            }
        ];
        // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿æ§‹é€ : { id, name, employmentType, role, storeId, availableMenus, sales, target, nomination, retention, reviewScore }

        // å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ - è‡ªç”±ã«ç·¨é›†å¯èƒ½ï¼‰
        const initialTicketMasterData = [
            { id: 1, name: '5å›åˆ¸', sessions: 5, price: 85000, validMonths: 6, description: 'ãŠå¾—ãª5å›ã‚»ãƒƒãƒˆ' },
            { id: 2, name: '10å›åˆ¸', sessions: 10, price: 160000, validMonths: 12, description: '10å›ã‚»ãƒƒãƒˆãƒ»1å¹´é–“æœ‰åŠ¹' }
        ];
        // å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼æ§‹é€ : { id, name, sessions, price, validMonths, description }

        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ - è‡ªç”±ã«ç·¨é›†å¯èƒ½ï¼‰
        const initialCustomerData = [
            {
                id: 1,
                name: 'å±±ç”°å¤ªéƒ',
                phone: '090-1234-5678',
                email: 'yamada@example.com',
                purchaseDate: '2025-12-01',
                ticketMasterId: 1,
                remainingSessions: 3,
                expiryDate: '2026-06-01',
                storeId: 1
            },
            {
                id: 2,
                name: 'é«˜æ©‹æ„›',
                phone: '080-9876-5432',
                email: 'takahashi@example.com',
                purchaseDate: '2025-11-15',
                ticketMasterId: 2,
                remainingSessions: 7,
                expiryDate: '2026-11-15',
                storeId: 1
            },
            {
                id: 3,
                name: 'ä½è—¤å¥',
                phone: '090-5555-1234',
                email: 'sato@example.com',
                purchaseDate: '2025-12-20',
                ticketMasterId: 1,
                remainingSessions: 1,
                expiryDate: '2026-02-15', // æœ‰åŠ¹æœŸé™é–“è¿‘
                storeId: 2
            },
            {
                id: 4,
                name: 'ç”°ä¸­ç¾é¦™',
                phone: '080-7777-9999',
                email: 'tanaka@example.com',
                purchaseDate: '2025-12-25',
                ticketMasterId: 1,
                remainingSessions: 4,
                expiryDate: '2026-01-31', // æœ‰åŠ¹æœŸé™é–“è¿‘
                storeId: 1
            }
        ];
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿æ§‹é€ : { id, name, phone, email, purchaseDate, ticketMasterId, remainingSessions, expiryDate, storeId }

        // åª’ä½“åˆ¥ãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ - è‡ªç”±ã«ç·¨é›†å¯èƒ½ï¼‰
        const initialMediaSourcesData = [
            { id: 1, name: 'ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼', newVisits: 45, repeatRate: 35, cpa: 8500, sales: 680000, adCost: 382500 },
            { id: 2, name: 'Instagram', newVisits: 28, repeatRate: 52, cpa: 3200, sales: 420000, adCost: 89600 },
            { id: 3, name: 'ç´¹ä»‹', newVisits: 15, repeatRate: 78, cpa: 0, sales: 320000, adCost: 0 }
        ];
        // åª’ä½“ãƒ‡ãƒ¼ã‚¿æ§‹é€ : { id, name, newVisits, repeatRate, cpa, sales, adCost }

        // æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ - è‡ªç”±ã«ç·¨é›†å¯èƒ½ï¼‰
        const initialDailySalesData = [
            {
                date: '2026-01-15',
                storeId: 1,
                staffId: 1,
                storeName: 'æ–°å®¿åº—',
                spotSales: 120000,
                ticketSales: 85000,
                ticketUsage: 54000,
                product: 28000,
                accountingSales: 287000,
                cashIn: 233000
            },
            {
                date: '2026-01-16',
                storeId: 1,
                staffId: 2,
                storeName: 'æ–°å®¿åº—',
                spotSales: 95000,
                ticketSales: 0,
                ticketUsage: 72000,
                product: 15000,
                accountingSales: 182000,
                cashIn: 110000
            },
            {
                date: '2026-01-15',
                storeId: 2,
                staffId: 3,
                storeName: 'æ–°å®¿å—å£åº—',
                spotSales: 78000,
                ticketSales: 160000,
                ticketUsage: 40000,
                product: 22000,
                accountingSales: 300000,
                cashIn: 260000
            }
        ];
        // æ—¥æ¬¡å£²ä¸Šæ§‹é€ : { date, storeId, staffId, storeName, spotSales, ticketSales, ticketUsage, product, accountingSales, cashIn }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ - è‡ªç”±ã«ç·¨é›†å¯èƒ½ï¼‰
        const initialMenuSalesData = [
            { menuId: 1, menuName: 'å‰¥é›¢ã‚ã‚Šãƒãƒ¼ãƒ–ãƒ”ãƒ¼ãƒªãƒ³ã‚°(é¡”)', count: 8, sales: 144000, date: '2026-01-15', storeId: 1, staffId: 1 },
            { menuId: 2, menuName: 'å‰¥é›¢ãªã—ãƒãƒ¼ãƒ–ãƒ”ãƒ¼ãƒªãƒ³ã‚°(é¡”)', count: 12, sales: 180000, date: '2026-01-15', storeId: 1, staffId: 2 },
            { menuId: 4, menuName: 'ã‚ˆã‚‚ãè’¸ã—', count: 6, sales: 48000, date: '2026-01-15', storeId: 2, staffId: 3 },
            { menuId: 5, menuName: 'ã‚»ãƒ«ãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°', count: 10, sales: 50000, date: '2026-01-16', storeId: 2, staffId: 3 }
        ];
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å£²ä¸Šæ§‹é€ : { menuId, menuName, count, sales, date, storeId, staffId }

        // --- Google Apps Scripté€£æºé–¢æ•° ---

        // GASã®Webã‚¢ãƒ—ãƒªURLã‚’è¨­å®šï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«å®Ÿéš›ã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxmSKXpHDEVbHeKEIHrtk_DoQfXIsMXBExfa7CzhpkizuC_wf-UY5YqXn0Ctc4u6lbq/exec';

        /**
         * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
         */
        const saveToSpreadsheet = async (action, data) => {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // GASã®åˆ¶é™ã«ã‚ˆã‚Šå¿…è¦
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });

                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’èª­ã¿å–ã‚Œãªã„ãŸã‚ã€æˆåŠŸã¨ä»®å®š
                console.log('ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†:', action);
                return { success: true, message: 'ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸ' };
            } catch (error) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                return { success: false, message: error.toString() };
            }
        };

        /**
         * æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
         */
        const saveDailySalesData = (dailySalesData) => {
            return saveToSpreadsheet('saveDailySales', { salesData: dailySalesData });
        };

        /**
         * ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
         */
        const saveMenuSalesData = (menuSalesData) => {
            return saveToSpreadsheet('saveMenuSales', { menuData: menuSalesData });
        };

        /**
         * ã‚¹ã‚¿ãƒƒãƒ•å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
         */
        const saveStaffPerformanceData = (staffData) => {
            return saveToSpreadsheet('saveStaffPerformance', { staffData: staffData });
        };

        // --- Helper Components ---

        const Icon = ({ name, size = 20, color = "currentColor", className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
        };

        const Card = ({ children, className = "", mobileOptimized = false }) => (
            <div className={`bg-white rounded-lg shadow-sm border border-gold-200 ${mobileOptimized ? 'mobile-card' : 'p-6'} ${className}`}>
                {children}
            </div>
        );

        const KpiCard = ({ title, value, subValue, trend, icon, color = "bg-gold-500", mobileOptimized = false }) => (
            <Card className={`hover:shadow-md transition-shadow relative overflow-hidden ${mobileOptimized ? 'touch-feedback' : ''}`} mobileOptimized={mobileOptimized}>
                {!mobileOptimized && (
                    <div className="absolute top-0 right-0 p-4 opacity-10">
                        <Icon name={icon} size={64} className="text-gold-900" />
                    </div>
                )}
                <div className={`flex justify-between items-start relative z-10 ${mobileOptimized ? 'mb-3' : 'mb-4'}`}>
                    <div className={`rounded-lg ${color} text-white shadow-md ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                        <Icon name={icon} size={mobileOptimized ? 20 : 24} />
                    </div>
                    {trend && (
                        <span className={`font-medium ${trend > 0 ? 'text-emerald-600' : 'text-rose-500'} flex items-center bg-white/80 px-2 py-1 rounded-full ${mobileOptimized ? 'text-xs' : 'text-sm'}`}>
                            {trend > 0 ? '+' : ''}{trend}% 
                            <Icon name={trend > 0 ? 'trending-up' : 'trending-down'} size={14} className="ml-1" />
                        </span>
                    )}
                </div>
                <h3 className={`text-gray-600 font-medium serif relative z-10 ${mobileOptimized ? 'mobile-label' : 'text-sm'}`}>{title}</h3>
                <div className={`flex items-baseline relative z-10 ${mobileOptimized ? 'mt-2' : 'mt-1'}`}>
                    <span className={`font-bold text-brown-800 ${mobileOptimized ? 'mobile-metric' : 'text-2xl'}`}>{value}</span>
                </div>
                <p className={`text-gray-500 relative z-10 ${mobileOptimized ? 'mobile-subtitle mt-1.5' : 'text-xs text-gray-400 mt-1'}`}>{subValue}</p>
            </Card>
        );

        // --- Main Sections ---

        const DashboardView = ({ staffList, dailySalesData, menuSalesData, mediaSourcesData = [], customerList = [], onNavigate, mobileOptimized = false, storeData = [] }) => {
            const [viewMode, setViewMode] = useState('all'); // 'all', 'store_1', 'store_2', 'staff_{id}'
            const [selectedStaffId, setSelectedStaffId] = useState(null);
            const [periodMode, setPeriodMode] = useState('month'); // 'month', '3months', '6months', 'year', 'specific'
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const today = new Date();
                return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            });

            // ãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚¯ãƒ©ã‚¹
            const cardGridClass = mobileOptimized ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2 xl:grid-cols-4';
            const cardPadding = mobileOptimized ? 'mobile-card' : 'p-6';
            const fontSize = {
                title: mobileOptimized ? 'mobile-title' : 'text-lg',
                subtitle: mobileOptimized ? 'mobile-subtitle' : 'text-sm',
                metric: mobileOptimized ? 'mobile-metric' : 'text-3xl',
                label: mobileOptimized ? 'mobile-label' : 'text-sm',
                body: mobileOptimized ? 'mobile-body' : 'text-base',
            };
            const buttonClass = mobileOptimized ? 'mobile-btn touch-feedback' : '';
            const tabClass = mobileOptimized ? 'mobile-tab touch-feedback' : '';

            // å®‰å…¨ãªé…åˆ—ãƒã‚§ãƒƒã‚¯
            const safeCustomerList = Array.isArray(customerList) ? customerList : [];
            const safeStaffList = Array.isArray(staffList) ? staffList : [];
            const safeDailySalesData = Array.isArray(dailySalesData) ? dailySalesData : [];
            const safeStoreData = Array.isArray(storeData) && storeData.length > 0 ? storeData : stores;

            // æœˆã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
            const changeMonth = (offset) => {
                const [year, month] = selectedMonth.split('-').map(Number);
                const date = new Date(year, month - 1 + offset, 1);
                setSelectedMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
            };

            // æœŸé–“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸå£²ä¸Šãƒ‡ãƒ¼ã‚¿
            const periodFilteredSales = useMemo(() => {
                if (safeDailySalesData.length === 0) return [];

                if (periodMode === 'specific') {
                    // ç‰¹å®šæœˆãƒ¢ãƒ¼ãƒ‰ï¼šé¸æŠã•ã‚ŒãŸæœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
                    const [year, month] = selectedMonth.split('-').map(Number);
                    return safeDailySalesData.filter(d => {
                        if (!d.date) return false;
                        const saleDate = new Date(d.date);
                        return saleDate.getFullYear() === year && (saleDate.getMonth() + 1) === month;
                    });
                } else {
                    // æœŸé–“ãƒ¢ãƒ¼ãƒ‰ï¼šéå»ã®æœŸé–“
                    const today = new Date();
                    const filterDate = new Date();

                    switch(periodMode) {
                        case 'month':
                            filterDate.setMonth(today.getMonth() - 1);
                            break;
                        case '3months':
                            filterDate.setMonth(today.getMonth() - 3);
                            break;
                        case '6months':
                            filterDate.setMonth(today.getMonth() - 6);
                            break;
                        case 'year':
                            filterDate.setFullYear(today.getFullYear() - 1);
                            break;
                        default:
                            filterDate.setMonth(today.getMonth() - 1);
                    }

                    return safeDailySalesData.filter(d => {
                        const saleDate = new Date(d.date);
                        return saleDate >= filterDate;
                    });
                }
            }, [safeDailySalesData, periodMode, selectedMonth]);

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸå£²ä¸Šãƒ‡ãƒ¼ã‚¿
            const filteredDailySales = useMemo(() => {
                if (!periodFilteredSales || periodFilteredSales.length === 0) return [];
                if (viewMode === 'all') return periodFilteredSales;

                // å‹•çš„ãªåº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (viewMode.startsWith('store_')) {
                    const storeId = parseInt(viewMode.replace('store_', ''));
                    return periodFilteredSales.filter(d => d.storeId === storeId);
                }

                if (viewMode === 'staff' && selectedStaffId) {
                    return periodFilteredSales.filter(d => d.staffId === selectedStaffId);
                }

                return periodFilteredSales;
            }, [periodFilteredSales, viewMode, selectedStaffId]);

            // æœˆæ¬¡é›†è¨ˆãƒ‡ãƒ¼ã‚¿
            const monthlyData = useMemo(() => {
                if (!periodFilteredSales || periodFilteredSales.length === 0) return [];

                const monthMap = {};
                periodFilteredSales.forEach(entry => {
                    const date = new Date(entry.date);
                    const monthKey = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthMap[monthKey]) {
                        monthMap[monthKey] = {
                            month: monthKey,
                            accountingSales: 0,
                            cashIn: 0,
                            ticketSales: 0,
                            ticketUsage: 0,
                            spotSales: 0,
                            product: 0
                        };
                    }

                    monthMap[monthKey].accountingSales += entry.accountingSales || 0;
                    monthMap[monthKey].cashIn += entry.cashIn || 0;
                    monthMap[monthKey].ticketSales += entry.ticketSales || 0;
                    monthMap[monthKey].ticketUsage += entry.ticketUsage || 0;
                    monthMap[monthKey].spotSales += entry.spotSales || 0;
                    monthMap[monthKey].product += entry.product || 0;
                });

                return Object.values(monthMap).sort((a, b) => a.month.localeCompare(b.month));
            }, [periodFilteredSales]);

            const filteredStaffList = useMemo(() => {
                if (viewMode === 'all' || viewMode === 'staff') return staffList;
                if (viewMode === 'store_1') return staffList.filter(s => s.storeId === 1);
                if (viewMode === 'store_2') return staffList.filter(s => s.storeId === 2);
                return staffList;
            }, [staffList, viewMode]);

            // åˆè¨ˆè¨ˆç®—
            const totalAccountingSales = filteredDailySales.reduce((acc, curr) => acc + (curr.accountingSales || 0), 0);
            const totalCashIn = filteredDailySales.reduce((acc, curr) => acc + (curr.cashIn || 0), 0);
            const totalTicketUsage = filteredDailySales.reduce((acc, curr) => acc + (curr.ticketUsage || 0), 0);
            const totalTicketSales = filteredDailySales.reduce((acc, curr) => acc + (curr.ticketSales || 0), 0);

            // æœ‰åŠ¹æœŸé™ãŒè¿‘ã„é¡§å®¢ã‚’è¨ˆç®—ï¼ˆ30æ—¥ä»¥å†…ï¼‰
            const expiringCustomers = useMemo(() => {
                const today = new Date();
                const thirtyDaysLater = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

                return safeCustomerList.filter(customer => {
                    if (!customer.expiryDate) return false;
                    const expiryDate = new Date(customer.expiryDate);
                    return expiryDate >= today && expiryDate <= thirtyDaysLater && customer.remainingSessions > 0;
                });
            }, [safeCustomerList]);

            if (!window.Recharts) return <div>Loading Charts... (If this persists, please refresh)</div>;

            // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®è¡¨ç¤º
            const hasData = (Array.isArray(safeStaffList) && safeStaffList.length > 0) || safeDailySalesData.length > 0;

            if (!hasData) {
                return (
                    <div className="flex flex-col items-center justify-center py-20">
                        <div className="bg-white rounded-xl p-12 shadow-lg border border-gold-200 text-center max-w-2xl">
                            <div className="w-20 h-20 bg-gold-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="sparkles" size={40} className="text-gold-600" />
                            </div>
                            <h2 className="text-2xl font-bold text-brown-800 mb-4 serif">ã‚¨ã‚¹ãƒ†ã‚µãƒ­ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ã‚ˆã†ã“ãï¼</h2>
                            <p className="text-gray-600 mb-8 leading-relaxed">
                                ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br/>
                                ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½¿ã„å§‹ã‚ã¾ã—ã‚‡ã†ã€‚
                            </p>
                            <div className="text-left space-y-4 bg-gold-50 rounded-lg p-6 mb-8">
                                <div className="flex items-start">
                                    <span className="bg-gold-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 flex-shrink-0">1</span>
                                    <div>
                                        <p className="font-bold text-brown-800">ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç™»éŒ²</p>
                                        <p className="text-sm text-gray-600">å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                                    </div>
                                </div>
                                <div className="flex items-start">
                                    <span className="bg-gold-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 flex-shrink-0">2</span>
                                    <div>
                                        <p className="font-bold text-brown-800">å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼ã‚’è¨­å®š</p>
                                        <p className="text-sm text-gray-600">ã€Œé¡§å®¢ãƒ»å›æ•°åˆ¸ç®¡ç†ã€ã‹ã‚‰å›æ•°åˆ¸ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                                    </div>
                                </div>
                                <div className="flex items-start">
                                    <span className="bg-gold-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 flex-shrink-0">3</span>
                                    <div>
                                        <p className="font-bold text-brown-800">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</p>
                                        <p className="text-sm text-gray-600">å³ä¸Šã®ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã§ãã¾ã™</p>
                                    </div>
                                </div>
                            </div>
                            <p className="text-xs text-gray-500">
                                ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€å³ä¸Šã®ã€Œèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã§å–å¾—ã§ãã¾ã™
                            </p>
                        </div>
                    </div>
                );
            }

            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            const ViewTab = ({ id, label }) => (
                <button
                    onClick={() => setViewMode(id)}
                    className={`font-medium rounded-lg transition-all ${tabClass} ${
                        viewMode === id
                            ? 'bg-gold-500 text-white shadow-md'
                            : 'bg-white text-gray-600 hover:bg-gold-50 border border-gray-200'
                    } ${mobileOptimized ? 'px-3.5 py-2.5 text-sm font-semibold' : 'px-6 py-2.5 text-sm'}`}
                >
                    {label}
                </button>
            );

            const PeriodTab = ({ id, label }) => (
                <button
                    onClick={() => setPeriodMode(id)}
                    className={`font-medium rounded transition-all ${tabClass} ${
                        periodMode === id
                            ? 'bg-blue-500 text-white shadow'
                            : 'bg-white text-gray-600 hover:bg-blue-50 border border-gray-200'
                    } ${mobileOptimized ? 'px-3.5 py-2.5 text-sm font-semibold' : 'px-4 py-2 text-sm'}`}
                >
                    {label}
                </button>
            );

            return (
                <div className={mobileOptimized ? 'space-y-4' : 'space-y-6'}>
                    {/* åº—èˆ—/ã‚¹ã‚¿ãƒƒãƒ•åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */}
                    <div className={`bg-white rounded-lg shadow-sm border border-gold-200 ${mobileOptimized ? 'p-3' : 'p-4'}`}>
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <h3 className={`font-bold text-gray-600 serif ${fontSize.subtitle}`}>è¡¨ç¤ºåˆ‡æ›¿</h3>
                            <div className={`flex gap-2 items-center ${mobileOptimized ? 'flex-wrap' : ''}`}>
                                <ViewTab id="all" label="å…¨åº—èˆ—åˆè¨ˆ" />
                                {safeStoreData.map(store => (
                                    <ViewTab key={store.id} id={`store_${store.id}`} label={store.name} />
                                ))}
                                <ViewTab id="staff" label="ã‚¹ã‚¿ãƒƒãƒ•åˆ¥" />
                                {viewMode === 'staff' && (
                                    <select
                                        value={selectedStaffId || ''}
                                        onChange={(e) => setSelectedStaffId(Number(e.target.value))}
                                        className="ml-2 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:border-gold-500 outline-none bg-white"
                                    >
                                        <option value="">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ</option>
                                        {safeStaffList.map(staff => {
                                            const staffStore = safeStoreData.find(s => s.id === staff.storeId);
                                            return (
                                                <option key={staff.id} value={staff.id}>
                                                    {staff.name} ({staffStore ? staffStore.name : 'åº—èˆ—ä¸æ˜'})
                                                </option>
                                            );
                                        })}
                                    </select>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* æœŸé–“é¸æŠã‚¿ãƒ– */}
                    <div className={`bg-white rounded-lg shadow-sm border border-blue-200 ${mobileOptimized ? 'p-3' : 'p-4'}`}>
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <h3 className={`font-bold text-gray-600 serif ${fontSize.subtitle}`}>è¡¨ç¤ºæœŸé–“</h3>
                            <div className="flex items-center gap-4 flex-wrap">
                                <div className={`flex gap-2 ${mobileOptimized ? 'flex-wrap' : ''}`}>
                                    <PeriodTab id="specific" label="æœˆé¸æŠ" />
                                    <PeriodTab id="month" label="ä»Šæœˆ" />
                                    <PeriodTab id="3months" label="éå»3ãƒ¶æœˆ" />
                                    <PeriodTab id="6months" label="éå»6ãƒ¶æœˆ" />
                                    <PeriodTab id="year" label="éå»1å¹´" />
                                </div>
                                {periodMode === 'specific' && (
                                    <div className="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                                        <button
                                            onClick={() => changeMonth(-1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="å‰æœˆ"
                                        >
                                            <Icon name="chevron-left" size={18} />
                                        </button>
                                        <input
                                            type="month"
                                            value={selectedMonth}
                                            onChange={(e) => setSelectedMonth(e.target.value)}
                                            className="px-2 py-1 border border-blue-300 rounded text-sm focus:outline-none focus:border-blue-500 bg-white"
                                        />
                                        <button
                                            onClick={() => changeMonth(1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="æ¬¡æœˆ"
                                        >
                                            <Icon name="chevron-right" size={18} />
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Top KPI Cards - Split Sales Types */}
                    <div className={`grid gap-4 ${cardGridClass}`}>
                        <KpiCard
                            title="ä¼šè¨ˆä¸Šå£²ä¸Š (å½¹å‹™æ¶ˆåŒ–è¾¼)"
                            value={`Â¥${totalAccountingSales.toLocaleString()}`}
                            subValue={`æ¶ˆåŒ–é¡: Â¥${totalTicketUsage.toLocaleString()}`}
                            trend={5.2}
                            icon="file-text"
                            color="bg-gold-600"
                            mobileOptimized={mobileOptimized}
                        />
                        <KpiCard
                            title="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ (å…¥é‡‘ç·é¡)"
                            value={`Â¥${totalCashIn.toLocaleString()}`}
                            subValue={`å›æ•°åˆ¸è²©å£²: Â¥${totalTicketSales.toLocaleString()}`}
                            trend={12.8}
                            icon="coins"
                            color="bg-emerald-600"
                            mobileOptimized={mobileOptimized}
                        />
                        <KpiCard
                            title="å›æ•°åˆ¸æœªæ¶ˆåŒ–æ®‹é«˜"
                            value="Â¥4,250,000"
                            subValue="å‰æœˆæ¯” +Â¥50,000 (è² å‚µå¢—)"
                            trend={-1.2}
                            icon="layers"
                            color="bg-brown-800"
                            mobileOptimized={mobileOptimized}
                        />
                        <KpiCard
                            title="å¹³å‡ãƒªãƒ”ãƒ¼ãƒˆç‡"
                            value="72.4%"
                            subValue="æ–°è¦å®šç€ç‡: 45%"
                            trend={2.1}
                            icon="repeat"
                            color="bg-rose-500"
                            mobileOptimized={mobileOptimized}
                        />
                    </div>

                    <div className={`grid gap-6 ${mobileOptimized ? 'grid-cols-1' : 'grid-cols-1 lg:grid-cols-3'}`}>
                        {/* Main Chart: Sales Breakdown */}
                        <div className={mobileOptimized ? '' : 'lg:col-span-2'}>
                            <Card mobileOptimized={mobileOptimized}>
                                <div className={`flex justify-between items-center ${mobileOptimized ? 'mb-3' : 'mb-6'}`}>
                                    <div>
                                        <h2 className={`font-bold text-brown-800 serif ${fontSize.title}`}>å£²ä¸Šæ§‹é€ åˆ†æ</h2>
                                        {!mobileOptimized && (
                                            <p className={`text-gray-500 ${fontSize.subtitle}`}>æœˆæ¬¡æ¨ç§»ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³(ç¾é‡‘)ã¨ä¼šè¨ˆä¸Šå£²ä¸Š(PL)ã®ä¹–é›¢ã‚’ç¢ºèª</p>
                                        )}
                                    </div>
                                </div>
                                <ResponsiveContainer width="100%" height={mobileOptimized ? 220 : 280}>
                                    <BarChart data={monthlyData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                        <XAxis dataKey="month" tick={{fontSize: mobileOptimized ? 9 : 10}} angle={-45} textAnchor="end" height={60} />
                                        <YAxis tick={{fontSize: mobileOptimized ? 9 : 10}} tickFormatter={(val) => `Â¥${val/10000}ä¸‡`} />
                                        <Tooltip
                                            formatter={(value) => `Â¥${value.toLocaleString()}`}
                                            contentStyle={{
                                                backgroundColor: '#fff',
                                                borderColor: '#d4af37',
                                                fontSize: mobileOptimized ? '13px' : '14px',
                                                padding: mobileOptimized ? '6px 10px' : '8px 12px'
                                            }}
                                        />
                                        <Legend wrapperStyle={{fontSize: mobileOptimized ? '11px' : '12px'}} />
                                        <Bar dataKey="spotSales" name="éƒ½åº¦æ‰•ã„" stackId="a" fill="#d4af37" />
                                        <Bar dataKey="product" name="ç‰©è²©" stackId="a" fill="#b48e26" />
                                        <Bar dataKey="ticketUsage" name="å›æ•°åˆ¸æ¶ˆåŒ–(å£²ä¸Š)" stackId="a" fill="#4a3b32" />
                                        <Bar dataKey="ticketSales" name="å›æ•°åˆ¸è²©å£²(å…¥é‡‘)" fill="#10b981" radius={[4, 4, 0, 0]} opacity={0.3} />
                                    </BarChart>
                                </ResponsiveContainer>

                                {/* å£²ä¸Šæ§‹é€ ã®è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« */}
                                <div className={`border-t border-gray-200 ${mobileOptimized ? 'mt-4 pt-4' : 'mt-6 pt-6'}`}>
                                    <h3 className={`font-bold text-brown-800 mb-4 ${mobileOptimized ? 'text-sm' : 'text-base'}`}>æœŸé–“åˆè¨ˆã®å†…è¨³</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {/* éƒ½åº¦æ‰•ã„ */}
                                        <div className="bg-gradient-to-br from-gold-50 to-gold-100 border border-gold-200 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#d4af37] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">éƒ½åº¦æ‰•ã„</span>
                                            </div>
                                            <p className="text-xl font-bold text-brown-800 mb-1">
                                                Â¥{filteredDailySales.reduce((sum, d) => sum + (d.spotSales || 0), 0).toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {totalAccountingSales > 0 ?
                                                    `${Math.round((filteredDailySales.reduce((sum, d) => sum + (d.spotSales || 0), 0) / totalAccountingSales) * 100)}%` :
                                                    '0%'
                                                } of ä¼šè¨ˆä¸Šå£²ä¸Š
                                            </p>
                                        </div>

                                        {/* ç‰©è²© */}
                                        <div className="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#b48e26] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">ç‰©è²©</span>
                                            </div>
                                            <p className="text-xl font-bold text-brown-800 mb-1">
                                                Â¥{filteredDailySales.reduce((sum, d) => sum + (d.product || 0), 0).toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {totalAccountingSales > 0 ?
                                                    `${Math.round((filteredDailySales.reduce((sum, d) => sum + (d.product || 0), 0) / totalAccountingSales) * 100)}%` :
                                                    '0%'
                                                } of ä¼šè¨ˆä¸Šå£²ä¸Š
                                            </p>
                                        </div>

                                        {/* å›æ•°åˆ¸æ¶ˆåŒ– */}
                                        <div className="bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-300 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#4a3b32] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">å›æ•°åˆ¸æ¶ˆåŒ–</span>
                                            </div>
                                            <p className="text-xl font-bold text-brown-800 mb-1">
                                                Â¥{totalTicketUsage.toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {totalAccountingSales > 0 ?
                                                    `${Math.round((totalTicketUsage / totalAccountingSales) * 100)}%` :
                                                    '0%'
                                                } of ä¼šè¨ˆä¸Šå£²ä¸Š
                                            </p>
                                        </div>

                                        {/* å›æ•°åˆ¸è²©å£² */}
                                        <div className="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#10b981] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">å›æ•°åˆ¸è²©å£²</span>
                                            </div>
                                            <p className="text-xl font-bold text-emerald-700 mb-1">
                                                Â¥{totalTicketSales.toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                ç¾é‡‘åå…¥ï¼ˆå£²ä¸Šå¤–ï¼‰
                                            </p>
                                        </div>
                                    </div>

                                    {/* åˆè¨ˆã‚µãƒãƒªãƒ¼ */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                        <div className="bg-gradient-to-br from-rose-50 to-rose-100 border-2 border-rose-300 rounded-lg p-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs text-gray-600 font-medium mb-1">ä¼šè¨ˆä¸Šå£²ä¸Šï¼ˆPLï¼‰</p>
                                                    <p className="text-2xl font-bold text-brown-800">Â¥{totalAccountingSales.toLocaleString()}</p>
                                                </div>
                                                <Icon name="file-text" size={28} className="text-rose-300" />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">
                                                éƒ½åº¦æ‰•ã„ + ç‰©è²© + å›æ•°åˆ¸æ¶ˆåŒ–
                                            </p>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-lg p-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs text-gray-600 font-medium mb-1">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ï¼ˆç¾é‡‘ï¼‰</p>
                                                    <p className="text-2xl font-bold text-blue-700">Â¥{totalCashIn.toLocaleString()}</p>
                                                </div>
                                                <Icon name="dollar-sign" size={28} className="text-blue-300" />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">
                                                éƒ½åº¦æ‰•ã„ + ç‰©è²© + å›æ•°åˆ¸è²©å£²
                                            </p>
                                        </div>
                                    </div>

                                    {/* ä¹–é›¢èª¬æ˜ */}
                                    {totalAccountingSales !== totalCashIn && (
                                        <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                            <div className="flex items-start">
                                                <Icon name="info" size={16} className="text-amber-600 mr-2 mt-0.5 flex-shrink-0" />
                                                <div className="text-xs text-gray-700">
                                                    <p className="font-bold text-amber-800 mb-1">å£²ä¸Šã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ã®ä¹–é›¢ã«ã¤ã„ã¦</p>
                                                    <p>
                                                        <span className="font-bold">å·®é¡: Â¥{Math.abs(totalAccountingSales - totalCashIn).toLocaleString()}</span>
                                                        {totalCashIn > totalAccountingSales ? ' ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ãŒå¤šã„' : ' ä¼šè¨ˆä¸Šå£²ä¸ŠãŒå¤šã„'}
                                                    </p>
                                                    <p className="mt-1 text-gray-600">
                                                        å›æ•°åˆ¸è²©å£²ã¯ç¾é‡‘åå…¥ã§ã™ãŒã€ä¼šè¨ˆä¸Šã¯å‰å—é‡‘ï¼ˆè² å‚µï¼‰ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚
                                                        å›æ•°åˆ¸æ¶ˆåŒ–æ™‚ã«å£²ä¸Šã¨ã—ã¦è¨ˆä¸Šã•ã‚Œã‚‹ãŸã‚ã€PLã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã«å·®ãŒç”Ÿã˜ã¾ã™ã€‚
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </Card>
                        </div>

                        {/* Side Widgets */}
                        <div className="space-y-6">
                            {/* Media Performance Mini */}
                            <Card>
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">åª’ä½“åˆ¥ æ–°è¦é›†å®¢çŠ¶æ³</h3>
                                <div className="space-y-4">
                                    {(mediaSourcesData || []).slice(0, 3).map(media => (
                                        <div key={media.id} className="flex flex-col">
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="font-medium text-gray-700">{media.name}</span>
                                                <span className="font-bold text-gold-600">{media.newVisits}äºº</span>
                                            </div>
                                            <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                                <div 
                                                    className="h-full bg-gold-500" 
                                                    style={{width: `${(media.newVisits / 50) * 100}%`}}
                                                ></div>
                                            </div>
                                            <div className="flex justify-between text-xs text-gray-400 mt-1">
                                                <span>CPA: Â¥{media.cpa.toLocaleString()}</span>
                                                <span>å®šç€ç‡: {media.repeatRate}%</span>
                                            </div>
                                        </div>
                                    ))}
                                    <button
                                        onClick={() => onNavigate && onNavigate('sales')}
                                        className="w-full mt-2 text-xs text-gold-600 hover:text-gold-700 text-center py-2 border border-gold-200 rounded hover:bg-gold-50 transition-colors"
                                    >
                                        å…¨ã¦ã®åª’ä½“ã‚’è¦‹ã‚‹
                                    </button>
                                </div>
                            </Card>

                            {/* Ticket Alert */}
                            <div className={`p-6 rounded-lg shadow-lg ${expiringCustomers.length > 0 ? 'bg-gradient-to-br from-rose-600 to-rose-700' : 'bg-gradient-to-br from-emerald-600 to-emerald-700'} text-white`}>
                                <div className="flex items-center mb-3">
                                    <Icon name={expiringCustomers.length > 0 ? "alert-circle" : "check-circle"} size={20} className="text-white mr-2" />
                                    <h3 className="font-bold serif">æœ‰åŠ¹æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
                                </div>
                                {expiringCustomers.length > 0 ? (
                                    <>
                                        <p className="text-sm opacity-90 mb-4">
                                            30æ—¥ä»¥å†…ã«æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã‚‹å›æ•°åˆ¸ã‚’æŒã¤é¡§å®¢ãŒ <span className="font-bold text-white text-lg">{expiringCustomers.length}å</span> ã„ã¾ã™ã€‚
                                        </p>
                                        <div className="bg-white/20 rounded p-3 mb-4 max-h-32 overflow-y-auto">
                                            {expiringCustomers.map(customer => (
                                                <div key={customer.id} className="text-xs mb-2 last:mb-0 flex justify-between items-center">
                                                    <span>{customer.name}</span>
                                                    <span className="opacity-75">{customer.expiryDate} (æ®‹{customer.remainingSessions}å›)</span>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                ) : (
                                    <p className="text-sm opacity-90 mb-4">
                                        ç¾åœ¨ã€30æ—¥ä»¥å†…ã«æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã‚‹å›æ•°åˆ¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Monthly Trend Chart (when period > month) */}
                    {periodMode !== 'month' && monthlyData.length > 0 && (
                        <Card mobileOptimized={mobileOptimized}>
                            <div className={mobileOptimized ? 'mb-3' : 'mb-6'}>
                                <h2 className={`font-bold text-brown-800 serif ${fontSize.title}`}>æœˆæ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
                                {!mobileOptimized && (
                                    <p className="text-xs text-gray-500">é¸æŠæœŸé–“ã®æœˆã”ã¨ã®å£²ä¸Šæ¨ç§»ã‚’ç¢ºèª</p>
                                )}
                            </div>
                            <ResponsiveContainer width="100%" height={mobileOptimized ? 240 : 300}>
                                <LineChart data={monthlyData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                    <XAxis dataKey="month" tick={{fontSize: mobileOptimized ? 9 : 10}} />
                                    <YAxis tick={{fontSize: mobileOptimized ? 9 : 10}} tickFormatter={(val) => `Â¥${val/10000}ä¸‡`} />
                                    <Tooltip
                                        formatter={(value) => `Â¥${value.toLocaleString()}`}
                                        contentStyle={{
                                            backgroundColor: '#fff',
                                            borderColor: '#d4af37',
                                            fontSize: mobileOptimized ? '13px' : '14px',
                                            padding: mobileOptimized ? '6px 10px' : '8px 12px'
                                        }}
                                    />
                                    <Legend wrapperStyle={{fontSize: mobileOptimized ? '11px' : '12px'}} />
                                    <Line type="monotone" dataKey="accountingSales" name="ä¼šè¨ˆä¸Šå£²ä¸Š" stroke="#d4af37" strokeWidth={2} dot={{r: 4}} />
                                    <Line type="monotone" dataKey="cashIn" name="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³" stroke="#10b981" strokeWidth={2} dot={{r: 4}} />
                                    <Line type="monotone" dataKey="ticketSales" name="å›æ•°åˆ¸è²©å£²" stroke="#3b82f6" strokeWidth={2} dot={{r: 4}} />
                                </LineChart>
                            </ResponsiveContainer>

                            {/* Summary Statistics */}
                            <div className={`grid grid-cols-2 gap-3 ${mobileOptimized ? 'mt-4' : 'mt-6 md:grid-cols-4 gap-4'}`}>
                                <div className={`bg-gold-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>æœŸé–“åˆè¨ˆå£²ä¸Š</p>
                                    <p className={`font-bold text-gold-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>Â¥{monthlyData.reduce((sum, m) => sum + m.accountingSales, 0).toLocaleString()}</p>
                                </div>
                                <div className={`bg-emerald-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>æœŸé–“åˆè¨ˆå…¥é‡‘</p>
                                    <p className={`font-bold text-emerald-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>Â¥{monthlyData.reduce((sum, m) => sum + m.cashIn, 0).toLocaleString()}</p>
                                </div>
                                <div className={`bg-blue-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>æœˆå¹³å‡å£²ä¸Š</p>
                                    <p className={`font-bold text-blue-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>Â¥{Math.round(monthlyData.reduce((sum, m) => sum + m.accountingSales, 0) / monthlyData.length).toLocaleString()}</p>
                                </div>
                                <div className={`bg-rose-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>å¯¾è±¡æœŸé–“</p>
                                    <p className={`font-bold text-rose-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>{monthlyData.length}ãƒ¶æœˆ</p>
                                </div>
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // --- Media Analysis Section (New) ---
        const SalesAnalysisView = ({ dailySalesData, mediaSourcesData = [], onUpdateMediaSource }) => {
             if (!window.Recharts) return <div>Loading Charts...</div>;

            const [editingAdCostId, setEditingAdCostId] = useState(null);
            const [adCostInput, setAdCostInput] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const today = new Date();
                return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            });
            const [monthFilterEnabled, setMonthFilterEnabled] = useState(false);

            // æœˆã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
            const changeMonth = (offset) => {
                const [year, month] = selectedMonth.split('-').map(Number);
                const date = new Date(year, month - 1 + offset, 1);
                setSelectedMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
            };

            // ç©ºãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
            const hasData = (dailySalesData && dailySalesData.length > 0) || (mediaSourcesData && mediaSourcesData.length > 0);

            // åºƒå‘Šè²»ã®ç·¨é›†ã‚’é–‹å§‹
            const startEditAdCost = (media) => {
                setEditingAdCostId(media.id);
                setAdCostInput(String(media.adCost || 0));
            };

            // åºƒå‘Šè²»ã®ä¿å­˜
            const saveAdCost = (media) => {
                const processedValue = normalizeNumberInput(adCostInput);
                const newAdCost = processedValue === '' ? 0 : Number(processedValue);

                if (onUpdateMediaSource) {
                    onUpdateMediaSource(media.id, {
                        ...media,
                        adCost: newAdCost
                    });
                }

                setEditingAdCostId(null);
                setAdCostInput('');
            };

            // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            const cancelEditAdCost = () => {
                setEditingAdCostId(null);
                setAdCostInput('');
            };

            // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿
            const filteredDailySalesData = useMemo(() => {
                if (!dailySalesData || dailySalesData.length === 0) return [];

                if (monthFilterEnabled) {
                    const [year, month] = selectedMonth.split('-').map(Number);
                    return dailySalesData.filter(d => {
                        if (!d.date) return false;
                        const saleDate = new Date(d.date);
                        return saleDate.getFullYear() === year && (saleDate.getMonth() + 1) === month;
                    });
                }

                return dailySalesData;
            }, [dailySalesData, monthFilterEnabled, selectedMonth]);

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ï¼ˆdayãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼‰
            const formattedDailySalesData = useMemo(() => {
                if (!filteredDailySalesData || filteredDailySalesData.length === 0) return [];
                return filteredDailySalesData.map(entry => ({
                    ...entry,
                    day: entry.day || (entry.date ? new Date(entry.date).getDate() + 'æ—¥' : '')
                }));
            }, [filteredDailySalesData]);

            if (!hasData) {
                return (
                    <div className="flex flex-col items-center justify-center py-20">
                        <div className="bg-white rounded-xl p-12 shadow-lg border border-gold-200 text-center max-w-2xl">
                            <div className="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="trending-up" size={40} className="text-amber-600" />
                            </div>
                            <h2 className="text-2xl font-bold text-brown-800 mb-4 serif">å£²ä¸Šãƒ»åª’ä½“åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                            <p className="text-gray-600 mb-8 leading-relaxed">
                                å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã¨åª’ä½“ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è©³ç´°ãªåˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br/>
                                ã¾ãšã¯æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                            </p>
                            <div className="text-left space-y-4 bg-amber-50 rounded-lg p-6">
                                <div className="flex items-start">
                                    <Icon name="info" size={20} className="text-amber-600 mr-3 flex-shrink-0 mt-0.5" />
                                    <div>
                                        <p className="font-bold text-brown-800 mb-2">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›æ–¹æ³•</p>
                                        <ul className="text-sm text-gray-600 space-y-1 list-disc list-inside">
                                            <li>ã€Œå®Ÿç¸¾å…¥åŠ›ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ—¥æ¬¡å£²ä¸Šã‚’ç™»éŒ²</li>
                                            <li>åª’ä½“åˆ¥ã®é›†å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›</li>
                                            <li>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¦ç®¡ç†</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* æœˆé¸æŠã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
                    <div className="bg-white rounded-lg shadow-sm border border-blue-200 p-4">
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <h3 className="font-bold text-gray-600 serif text-sm">è¡¨ç¤ºæœŸé–“</h3>
                            <div className="flex items-center gap-4">
                                <label className="flex items-center cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={monthFilterEnabled}
                                        onChange={(e) => setMonthFilterEnabled(e.target.checked)}
                                        className="mr-2 accent-blue-500"
                                    />
                                    <span className="text-sm text-gray-700">æœˆæ¬¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</span>
                                </label>
                                {monthFilterEnabled && (
                                    <div className="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                                        <button
                                            onClick={() => changeMonth(-1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="å‰æœˆ"
                                        >
                                            <Icon name="chevron-left" size={18} />
                                        </button>
                                        <input
                                            type="month"
                                            value={selectedMonth}
                                            onChange={(e) => setSelectedMonth(e.target.value)}
                                            className="px-2 py-1 border border-blue-300 rounded text-sm focus:outline-none focus:border-blue-500 bg-white"
                                        />
                                        <button
                                            onClick={() => changeMonth(1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="æ¬¡æœˆ"
                                        >
                                            <Icon name="chevron-right" size={18} />
                                        </button>
                                        <span className="text-xs text-gray-600 ml-2">
                                            {filteredDailySalesData.length}ä»¶
                                        </span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Media Source Performance Table */}
                        <Card className="col-span-1">
                             <div className="flex justify-between items-center mb-6">
                                <h2 className="text-lg font-bold text-brown-800 serif">åª’ä½“åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ</h2>
                                {monthFilterEnabled && (
                                    <span className="text-xs text-gray-500 bg-blue-50 px-2 py-1 rounded">
                                        {selectedMonth.split('-')[0]}å¹´{selectedMonth.split('-')[1]}æœˆ
                                    </span>
                                )}
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="border-b border-gold-100 text-xs text-gray-500 uppercase">
                                            <th className="py-3 font-medium">åª’ä½“å</th>
                                            <th className="py-3 font-medium text-right">æ–°è¦æ•°</th>
                                            <th className="py-3 font-medium text-right">ç²å¾—å˜ä¾¡(CPA)</th>
                                            <th className="py-3 font-medium text-right">åºƒå‘Šè²»</th>
                                            <th className="py-3 font-medium text-right">ãƒªãƒ”ãƒ¼ãƒˆç‡</th>
                                            <th className="py-3 font-medium text-right">ç·å£²ä¸Šè²¢çŒ®</th>
                                            <th className="py-3 font-medium text-center">ROAS</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm divide-y divide-gray-50">
                                        {mediaSourcesData && mediaSourcesData.length > 0 ? (
                                            mediaSourcesData.map((media) => {
                                                const roas = media.adCost > 0 ? ((media.sales / media.adCost) * 100).toFixed(0) : '-';
                                                return (
                                                    <tr key={media.id} className="hover:bg-gold-50/50">
                                                        <td className="py-3 font-medium text-brown-800">{media.name}</td>
                                                        <td className="py-3 text-right">{media.newVisits}</td>
                                                        <td className="py-3 text-right">Â¥{media.cpa.toLocaleString()}</td>
                                                        <td className="py-3 text-right">
                                                            {editingAdCostId === media.id ? (
                                                                <div className="flex items-center justify-end gap-1">
                                                                    <input
                                                                        type="text"
                                                                        inputMode="numeric"
                                                                        value={adCostInput}
                                                                        onChange={(e) => setAdCostInput(e.target.value)}
                                                                        onKeyDown={(e) => {
                                                                            if (e.key === 'Enter') saveAdCost(media);
                                                                            if (e.key === 'Escape') cancelEditAdCost();
                                                                        }}
                                                                        className="w-24 px-2 py-1 border border-blue-400 rounded text-sm text-right focus:outline-none focus:border-blue-600"
                                                                        autoFocus
                                                                    />
                                                                    <button
                                                                        onClick={() => saveAdCost(media)}
                                                                        className="text-green-600 hover:text-green-700"
                                                                    >
                                                                        <Icon name="check" size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={cancelEditAdCost}
                                                                        className="text-red-600 hover:text-red-700"
                                                                    >
                                                                        <Icon name="x" size={14} />
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <button
                                                                    onClick={() => startEditAdCost(media)}
                                                                    className="text-blue-600 hover:text-blue-700 hover:underline"
                                                                >
                                                                    Â¥{(media.adCost || 0).toLocaleString()}
                                                                </button>
                                                            )}
                                                        </td>
                                                        <td className="py-3 text-right">
                                                            <span className={`px-2 py-1 rounded-full text-xs ${media.repeatRate >= 40 ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'}`}>
                                                                {media.repeatRate}%
                                                            </span>
                                                        </td>
                                                        <td className="py-3 text-right font-medium">Â¥{media.sales.toLocaleString()}</td>
                                                        <td className="py-3 text-center">
                                                            {roas !== '-' ? (
                                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                                                                    Number(roas) >= 300 ? 'bg-green-100 text-green-700' :
                                                                    Number(roas) >= 150 ? 'bg-yellow-100 text-yellow-700' :
                                                                    'bg-red-100 text-red-700'
                                                                }`}>
                                                                    {roas}%
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        ) : (
                                            <tr>
                                                <td colSpan="7" className="py-6 text-center text-gray-400 text-sm">
                                                    åª’ä½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-4 p-4 bg-gold-50 rounded text-xs text-brown-800 space-y-2">
                                <div>
                                    <strong>åºƒå‘Šè²»ã®å…¥åŠ›æ–¹æ³•:</strong> å„åª’ä½“ã®åºƒå‘Šè²»ï¼ˆé’è‰²ã®é‡‘é¡ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç·¨é›†ã§ãã¾ã™ã€‚æœˆé–“ã®åºƒå‘Šè²»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                                </div>
                                <div>
                                    <strong>ROAS (Return On Ad Spend):</strong> åºƒå‘Šè²»1å††ã‚ãŸã‚Šã®å£²ä¸Šã‚’ç¤ºã—ã¾ã™ã€‚300%ä»¥ä¸Š=å„ªç§€ã€150-300%=è‰¯å¥½ã€150%æœªæº€=æ”¹å–„å¿…è¦
                                </div>
                                <div>
                                    <strong>åˆ†æ:</strong> ç´¹ä»‹åª’ä½“ã¯åºƒå‘Šè²»ã‚¼ãƒ­ã§é«˜ã„ãƒªãƒ”ãƒ¼ãƒˆç‡ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚æœ‰æ–™åª’ä½“ã®ROASã‚’ç¢ºèªã—ã€è²»ç”¨å¯¾åŠ¹æœã®é«˜ã„åª’ä½“ã«äºˆç®—ã‚’é›†ä¸­ã•ã›ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
                                </div>
                            </div>
                        </Card>

                        {/* Sales Trend Chart */}
                         <Card className="col-span-1">
                            <h2 className="text-lg font-bold text-brown-800 mb-6 serif">å£²ä¸Šæ¨ç§»ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ vs å½¹å‹™æ¶ˆåŒ–ï¼‰</h2>
                             <ResponsiveContainer width="100%" height={300}>
                                <AreaChart data={formattedDailySalesData}>
                                    <defs>
                                        <linearGradient id="colorCash" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#10b981" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                        </linearGradient>
                                        <linearGradient id="colorSales" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#d4af37" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#d4af37" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <XAxis dataKey="day" tick={{fontSize: 10}} interval={5} />
                                    <YAxis tick={{fontSize: 10}} />
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <Tooltip />
                                    <Legend verticalAlign="top" height={36}/>
                                    <Area type="monotone" dataKey="cashIn" name="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³(ç¾é‡‘)" stroke="#10b981" fillOpacity={1} fill="url(#colorCash)" />
                                    <Area type="monotone" dataKey="accountingSales" name="ä¼šè¨ˆä¸Šå£²ä¸Š(æ¶ˆåŒ–)" stroke="#d4af37" fillOpacity={1} fill="url(#colorSales)" />
                                </AreaChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>
                </div>
            );
        };


        // --- Staff Management Section (Enhanced) ---

        const StaffManagementView = ({
            staffList,
            onUpdateStaff,
            onAddStaff,
            onDeleteStaff,
            exportToCSV
        }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);

            // Form State
            const [formData, setFormData] = useState({
                name: '',
                employmentType: 'æ­£ç¤¾å“¡', // é›‡ç”¨å½¢æ…‹
                role: 'ã‚¹ã‚¿ãƒƒãƒ•',
                storeId: 1,
                availableMenus: [], // æ–½è¡“å¯èƒ½ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã®é…åˆ—ï¼‰
                sales: 0,
                target: 0,
                nomination: 0,
                retention: 0,
                reviewScore: 0
            });

            const handleEditClick = (staff) => {
                setIsEditing(true);
                setEditingId(staff.id);
                setFormData({
                    name: staff.name || '',
                    employmentType: staff.employmentType || 'æ­£ç¤¾å“¡',
                    role: staff.role || 'ã‚¹ã‚¿ãƒƒãƒ•',
                    storeId: staff.storeId || 1,
                    availableMenus: Array.isArray(staff.availableMenus) ? staff.availableMenus : [],
                    sales: staff.sales || 0,
                    target: staff.target || 0,
                    nomination: staff.nomination || 0,
                    retention: staff.retention || 0,
                    reviewScore: staff.reviewScore || 0
                });
            };

            const handleAddClick = () => {
                setIsEditing(true);
                setEditingId(null); // New
                setFormData({
                    name: '',
                    employmentType: 'æ­£ç¤¾å“¡',
                    role: 'ã‚¹ã‚¿ãƒƒãƒ•',
                    storeId: 1,
                    availableMenus: [],
                    sales: 0,
                    target: 0,
                    nomination: 0,
                    retention: 0,
                    reviewScore: 0
                });
            };

            const handleDeleteClick = (staffId) => {
                setDeletingId(staffId);
                setShowDeleteConfirm(true);
            };

            const confirmDelete = () => {
                onDeleteStaff(deletingId);
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            const handleSave = () => {
                if (editingId) {
                    onUpdateStaff(editingId, formData);
                } else {
                    onAddStaff({ ...formData, id: Date.now() });
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name', 'role', 'employmentType'].includes(name);
                const isSelectNumber = name === 'storeId';

                setFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            isSelectNumber ? Number(value) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            return (
                <div className="space-y-6">
                    {/* Header Action */}
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-xl font-bold text-brown-800 serif">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ»åˆ†æ</h2>
                            <p className="text-sm text-gray-500">å€‹äººã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç®¡ç†ã¨è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®ç·¨é›†</p>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => exportToCSV(staffList, 'ã‚¹ã‚¿ãƒƒãƒ•å®Ÿç¸¾.csv')}
                                className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="download" size={16} className="mr-2" />
                                CSVå‡ºåŠ›
                            </button>
                            <button
                                onClick={handleAddClick}
                                className="bg-gold-500 hover:bg-gold-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="plus" size={16} className="mr-2" />
                                ã‚¹ã‚¿ãƒƒãƒ•æ–°è¦ç™»éŒ²
                            </button>
                        </div>
                    </div>

                    {/* Staff List Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        {!Array.isArray(staffList) || staffList.length === 0 ? (
                            <div className="col-span-full text-center py-12 text-gray-400">
                                <Icon name="users" size={48} className="mx-auto mb-4 opacity-30" />
                                <p className="text-sm">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                <p className="text-xs mt-2">ã€Œã‚¹ã‚¿ãƒƒãƒ•æ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p>
                            </div>
                        ) : (
                            staffList.map(staff => (
                                <div key={staff.id} className="bg-white border border-gold-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                    <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => handleEditClick(staff)}
                                            className="text-gray-300 hover:text-gold-500 p-1"
                                        >
                                            <Icon name="edit-2" size={16} />
                                        </button>
                                        <button
                                            onClick={() => handleDeleteClick(staff.id)}
                                            className="text-gray-300 hover:text-rose-500 p-1"
                                        >
                                            <Icon name="trash-2" size={16} />
                                        </button>
                                    </div>

                                    <div className="flex items-center mb-4">
                                        <div className="w-12 h-12 rounded-full bg-gold-50 border border-gold-200 flex items-center justify-center text-gold-700 font-bold text-lg">
                                            {staff.name ? staff.name.charAt(0) : '?'}
                                        </div>
                                        <div className="ml-3">
                                            <h3 className="font-bold text-brown-800">{staff.name}</h3>
                                            <p className="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-0.5 rounded mt-1">
                                                {staff.role} - {stores.find(s => s.id === staff.storeId)?.name || 'åº—èˆ—ä¸æ˜'}
                                            </p>
                                        </div>
                                    </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between text-sm items-end">
                                        <span className="text-gray-500 text-xs">å£²ä¸Šå®Ÿç¸¾</span>
                                        <span className="font-bold text-brown-800">Â¥{staff.sales.toLocaleString()}</span>
                                    </div>
                                    <div className="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                        <div
                                            className={`h-full ${staff.sales >= staff.target ? 'bg-emerald-500' : 'bg-gold-500'}`}
                                            style={{width: `${staff.target > 0 ? Math.min(100, (staff.sales/staff.target)*100) : 0}%`}}
                                        ></div>
                                    </div>
                                    <div className="flex justify-between text-xs text-gray-400">
                                        <span>ç›®æ¨™: Â¥{staff.target.toLocaleString()}</span>
                                        <span>{staff.target > 0 ? Math.round((staff.sales/staff.target)*100) : 0}%</span>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-2 pt-2 border-t border-gray-50 mt-2">
                                        <div className="text-center">
                                            <div className="text-xs text-gray-400">æŒ‡å</div>
                                            <div className="font-bold text-brown-800">{staff.nomination}</div>
                                        </div>
                                        <div className="text-center border-l border-gray-100">
                                            <div className="text-xs text-gray-400">ãƒªãƒ”ãƒ¼ãƒˆ</div>
                                            <div className="font-bold text-brown-800">{staff.retention}%</div>
                                        </div>
                                        <div className="text-center border-l border-gray-100">
                                            <div className="text-xs text-gray-400">å£ã‚³ãƒŸè©•ä¾¡</div>
                                            <div className="font-bold text-gold-600 flex justify-center items-center">
                                                {staff.reviewScore || 0}<Icon name="star" size={10} className="ml-0.5 fill-current" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-gray-100">
                                        <button
                                            onClick={() => {
                                                const staffUrl = `${window.location.origin}${window.location.pathname}?staffId=${staff.id}`;
                                                navigator.clipboard.writeText(staffUrl);
                                                alert(`ã‚¹ã‚¿ãƒƒãƒ•URL ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n${staffUrl}\n\nã“ã®URLã‚’ ${staff.name} ã•ã‚“ã«å…±æœ‰ã—ã¦ãã ã•ã„ã€‚`);
                                            }}
                                            className="w-full text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 rounded flex items-center justify-center transition-colors"
                                        >
                                            <Icon name="link" size={12} className="mr-1" />
                                            ã‚¹ã‚¿ãƒƒãƒ•URLã‚’ã‚³ãƒ”ãƒ¼
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ))
                        )}
                    </div>

                    {/* Edit Modal */}
                    {isEditing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md border border-gold-200">
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">
                                    {editingId ? 'ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ç·¨é›†' : 'æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">æ°å</label>
                                        <input name="name" value={formData.name} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="æ°å" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">é›‡ç”¨å½¢æ…‹</label>
                                            <select name="employmentType" value={formData.employmentType} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                                <option value="æ­£ç¤¾å“¡">æ­£ç¤¾å“¡</option>
                                                <option value="å¥‘ç´„ç¤¾å“¡">å¥‘ç´„ç¤¾å“¡</option>
                                                <option value="ã‚¢ãƒ«ãƒã‚¤ãƒˆ">ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
                                                <option value="æ¥­å‹™å§”è¨—">æ¥­å‹™å§”è¨—</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">å½¹è·</label>
                                            <select name="role" value={formData.role} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                                <option value="åº—é•·">åº—é•·</option>
                                                <option value="ã‚·ãƒ‹ã‚¢">ã‚·ãƒ‹ã‚¢</option>
                                                <option value="ã‚¹ã‚¿ãƒƒãƒ•">ã‚¹ã‚¿ãƒƒãƒ•</option>
                                                <option value="æ–°äºº">æ–°äºº</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">æ‰€å±åº—èˆ—</label>
                                        <select name="storeId" value={formData.storeId} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                            {stores.map(store => (
                                                <option key={store.id} value={store.id}>{store.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-2">æ–½è¡“å¯èƒ½ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼</label>
                                        <div className="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded p-3 bg-gray-50">
                                            {menus.filter(m => m.availableStores.includes(formData.storeId)).map(menu => (
                                                <label key={menu.id} className="flex items-center cursor-pointer hover:bg-white px-2 py-1 rounded transition-colors">
                                                    <input
                                                        type="checkbox"
                                                        checked={Array.isArray(formData.availableMenus) && formData.availableMenus.includes(menu.id)}
                                                        onChange={(e) => {
                                                            const currentMenus = Array.isArray(formData.availableMenus) ? formData.availableMenus : [];
                                                            const newMenus = e.target.checked
                                                                ? [...currentMenus, menu.id]
                                                                : currentMenus.filter(id => id !== menu.id);
                                                            setFormData(prev => ({ ...prev, availableMenus: newMenus }));
                                                        }}
                                                        className="mr-2 accent-gold-500"
                                                    />
                                                    <span className="text-sm text-gray-700">{menu.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={handleSave} className="px-4 py-2 text-sm bg-gold-500 hover:bg-gold-600 text-white rounded font-medium shadow-sm">ä¿å­˜ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border border-rose-200">
                                <div className="flex items-center mb-4">
                                    <Icon name="alert-triangle" size={24} className="text-rose-500 mr-3" />
                                    <h3 className="text-lg font-bold text-brown-800">å‰Šé™¤ã®ç¢ºèª</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">å‰Šé™¤ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Customer & Ticket Management View ---
        const CustomerTicketManagementView = ({
            ticketMasterList,
            customerList,
            onUpdateTicketMaster,
            onAddTicketMaster,
            onDeleteTicketMaster,
            onUpdateCustomer,
            onAddCustomer,
            onDeleteCustomer,
            exportToCSV
        }) => {
            const [activeView, setActiveView] = useState('master'); // 'master' or 'customers'
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);
            const [editingType, setEditingType] = useState('master'); // 'master' or 'customer'

            // Form State
            const [ticketFormData, setTicketFormData] = useState({
                name: '', sessions: 0, price: 0, validMonths: 0, description: ''
            });

            const [customerFormData, setCustomerFormData] = useState({
                name: '', phone: '', email: '', purchaseDate: '', ticketMasterId: '', remainingSessions: 0, expiryDate: '', storeId: 1
            });

            // Ticket Master Handlers
            const handleEditTicketMaster = (ticket) => {
                setIsEditing(true);
                setEditingId(ticket.id);
                setEditingType('master');
                setTicketFormData({ ...ticket });
            };

            const handleAddTicketMaster = () => {
                setIsEditing(true);
                setEditingId(null);
                setEditingType('master');
                setTicketFormData({
                    name: '', sessions: 5, price: 0, validMonths: 6, description: ''
                });
            };

            const handleDeleteTicketMaster = (id) => {
                setDeletingId(id);
                setEditingType('master');
                setShowDeleteConfirm(true);
            };

            // Customer Handlers
            const handleEditCustomer = (customer) => {
                setIsEditing(true);
                setEditingId(customer.id);
                setEditingType('customer');
                setCustomerFormData({ ...customer });
            };

            const handleAddCustomer = () => {
                setIsEditing(true);
                setEditingId(null);
                setEditingType('customer');
                const today = new Date().toISOString().split('T')[0];
                setCustomerFormData({
                    name: '', phone: '', email: '', purchaseDate: today, ticketMasterId: ticketMasterList[0]?.id || '', remainingSessions: 0, expiryDate: '', storeId: 1
                });
            };

            const handleDeleteCustomer = (id) => {
                setDeletingId(id);
                setEditingType('customer');
                setShowDeleteConfirm(true);
            };

            const confirmDelete = () => {
                if (editingType === 'master') {
                    onDeleteTicketMaster(deletingId);
                } else {
                    onDeleteCustomer(deletingId);
                }
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            const handleSave = () => {
                if (editingType === 'master') {
                    if (editingId) {
                        onUpdateTicketMaster(editingId, ticketFormData);
                    } else {
                        onAddTicketMaster({ ...ticketFormData, id: Date.now() });
                    }
                } else {
                    // é¸æŠã•ã‚ŒãŸå›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰æ®‹ã‚Šã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚’è¨­å®š
                    const selectedMaster = ticketMasterList.find(t => t.id === Number(customerFormData.ticketMasterId));
                    if (selectedMaster && !editingId) {
                        customerFormData.remainingSessions = selectedMaster.sessions;
                        // æœ‰åŠ¹æœŸé™ã‚’è¨ˆç®—
                        const purchaseDate = new Date(customerFormData.purchaseDate);
                        purchaseDate.setMonth(purchaseDate.getMonth() + selectedMaster.validMonths);
                        customerFormData.expiryDate = purchaseDate.toISOString().split('T')[0];
                    }

                    if (editingId) {
                        onUpdateCustomer(editingId, customerFormData);
                    } else {
                        onAddCustomer({ ...customerFormData, id: Date.now() });
                    }
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const handleTicketFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name', 'description'].includes(name);
                const processedValue = isTextField ? value : normalizeNumberInput(value);
                setTicketFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? processedValue : (processedValue === '' ? 0 : Number(processedValue))
                }));
            };

            const handleCustomerFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name', 'phone', 'email', 'purchaseDate', 'expiryDate'].includes(name);
                const isSelectNumber = ['ticketMasterId', 'storeId'].includes(name);

                setCustomerFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            isSelectNumber ? Number(value) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            return (
                <div className="space-y-6">
                    {/* Tab Navigation */}
                    <div className="flex justify-between items-center">
                        <div className="flex gap-2 bg-white rounded-lg p-1 border border-gold-200">
                            <button
                                onClick={() => setActiveView('master')}
                                className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                    activeView === 'master' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                                }`}
                            >
                                å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†
                            </button>
                            <button
                                onClick={() => setActiveView('customers')}
                                className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                    activeView === 'customers' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                                }`}
                            >
                                é¡§å®¢ãƒ»è³¼å…¥è€…ç®¡ç†
                            </button>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => exportToCSV(activeView === 'master' ? ticketMasterList : customerList, activeView === 'master' ? 'å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼.csv' : 'é¡§å®¢ãƒªã‚¹ãƒˆ.csv')}
                                className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="download" size={16} className="mr-2" />
                                CSVå‡ºåŠ›
                            </button>
                            <button
                                onClick={activeView === 'master' ? handleAddTicketMaster : handleAddCustomer}
                                className="bg-gold-500 hover:bg-gold-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="plus" size={16} className="mr-2" />
                                {activeView === 'master' ? 'å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼è¿½åŠ ' : 'é¡§å®¢è¿½åŠ '}
                            </button>
                        </div>
                    </div>

                    {/* Master Ticket List */}
                    {activeView === 'master' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {ticketMasterList.length === 0 ? (
                                <div className="col-span-full text-center py-12 text-gray-400">
                                    <Icon name="ticket" size={48} className="mx-auto mb-4 opacity-30" />
                                    <p className="text-sm">å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                    <p className="text-xs mt-2">ã€Œå›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p>
                                </div>
                            ) : (
                                ticketMasterList.map(ticket => (
                                    <div key={ticket.id} className="bg-white border border-gold-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                        <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button
                                                onClick={() => handleEditTicketMaster(ticket)}
                                                className="text-gray-300 hover:text-gold-500 p-1"
                                            >
                                                <Icon name="edit-2" size={16} />
                                            </button>
                                            <button
                                                onClick={() => handleDeleteTicketMaster(ticket.id)}
                                                className="text-gray-300 hover:text-rose-500 p-1"
                                            >
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>

                                        <div className="mb-4">
                                            <h3 className="font-bold text-brown-800 text-lg mb-1">{ticket.name}</h3>
                                            <p className="text-xs text-gray-500">{ticket.description}</p>
                                        </div>

                                        <div className="space-y-2 border-t border-gray-100 pt-3">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">å›æ•°</span>
                                                <span className="font-bold text-brown-800">{ticket.sessions}å›</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">ä¾¡æ ¼</span>
                                                <span className="font-bold text-gold-600">Â¥{ticket.price.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">æœ‰åŠ¹æœŸé™</span>
                                                <span className="font-bold text-brown-800">{ticket.validMonths}ãƒ¶æœˆ</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">1å›å˜ä¾¡</span>
                                                <span className="text-emerald-600">Â¥{Math.round(ticket.price / ticket.sessions).toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* Customer List */}
                    {activeView === 'customers' && (
                        <div className="bg-white rounded-xl border border-gold-100 overflow-hidden">
                            {!Array.isArray(customerList) || customerList.length === 0 ? (
                                <div className="text-center py-12 text-gray-400">
                                    <Icon name="users" size={48} className="mx-auto mb-4 opacity-30" />
                                    <p className="text-sm">é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                    <p className="text-xs mt-2">ã€Œé¡§å®¢è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gold-50 border-b border-gold-100">
                                            <tr className="text-left text-xs text-gray-500 uppercase">
                                                <th className="py-3 px-4 font-medium">æ°å</th>
                                                <th className="py-3 px-4 font-medium">é€£çµ¡å…ˆ</th>
                                                <th className="py-3 px-4 font-medium">å›æ•°åˆ¸</th>
                                                <th className="py-3 px-4 font-medium">æ®‹å›æ•°</th>
                                                <th className="py-3 px-4 font-medium">æœ‰åŠ¹æœŸé™</th>
                                                <th className="py-3 px-4 font-medium">åº—èˆ—</th>
                                                <th className="py-3 px-4 font-medium text-center">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {customerList.map(customer => {
                                                const ticket = ticketMasterList.find(t => t.id === customer.ticketMasterId);
                                                const store = stores.find(s => s.id === customer.storeId);
                                                const isExpired = customer.expiryDate ? new Date(customer.expiryDate) < new Date() : false;

                                                return (
                                                    <tr key={customer.id} className="hover:bg-gold-50/30 text-sm">
                                                        <td className="py-3 px-4 font-medium text-brown-800">{customer.name}</td>
                                                        <td className="py-3 px-4 text-gray-600">
                                                            <div>{customer.phone}</div>
                                                            <div className="text-xs text-gray-400">{customer.email}</div>
                                                        </td>
                                                        <td className="py-3 px-4 text-gray-600">{ticket?.name || 'ä¸æ˜'}</td>
                                                        <td className="py-3 px-4">
                                                            <span className={`font-bold ${customer.remainingSessions > 0 ? 'text-emerald-600' : 'text-gray-400'}`}>
                                                                {customer.remainingSessions}å›
                                                            </span>
                                                        </td>
                                                        <td className="py-3 px-4">
                                                            <span className={`text-xs px-2 py-1 rounded ${isExpired ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                                                {customer.expiryDate}
                                                            </span>
                                                        </td>
                                                        <td className="py-3 px-4 text-gray-600">{store?.name || 'ä¸æ˜'}</td>
                                                        <td className="py-3 px-4">
                                                            <div className="flex justify-center gap-2">
                                                                <button
                                                                    onClick={() => handleEditCustomer(customer)}
                                                                    className="text-gray-400 hover:text-gold-500 p-1"
                                                                >
                                                                    <Icon name="edit-2" size={16} />
                                                                </button>
                                                                <button
                                                                    onClick={() => handleDeleteCustomer(customer.id)}
                                                                    className="text-gray-400 hover:text-rose-500 p-1"
                                                                >
                                                                    <Icon name="trash-2" size={16} />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Edit Modal - Ticket Master */}
                    {isEditing && editingType === 'master' && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md border border-gold-200">
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">
                                    {editingId ? 'å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†' : 'å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼æ–°è¦ç™»éŒ²'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">å›æ•°åˆ¸å</label>
                                        <input name="name" value={ticketFormData.name} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="ä¾‹: 5å›åˆ¸" />
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">å›æ•°</label>
                                            <input type="text" inputMode="numeric" name="sessions" value={ticketFormData.sessions} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ä¾¡æ ¼(å††)</label>
                                            <input type="text" inputMode="numeric" name="price" value={ticketFormData.price} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">æœ‰åŠ¹(æœˆ)</label>
                                            <input type="text" inputMode="numeric" name="validMonths" value={ticketFormData.validMonths} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">èª¬æ˜</label>
                                        <textarea name="description" value={ticketFormData.description} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" rows="2" placeholder="å›æ•°åˆ¸ã®èª¬æ˜"></textarea>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={handleSave} className="px-4 py-2 text-sm bg-gold-500 hover:bg-gold-600 text-white rounded font-medium shadow-sm">ä¿å­˜ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Modal - Customer */}
                    {isEditing && editingType === 'customer' && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md border border-gold-200">
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">
                                    {editingId ? 'é¡§å®¢æƒ…å ±ç·¨é›†' : 'é¡§å®¢æ–°è¦ç™»éŒ²'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">æ°å</label>
                                        <input name="name" value={customerFormData.name} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="æ°å" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">é›»è©±ç•ªå·</label>
                                            <input name="phone" value={customerFormData.phone} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="090-1234-5678" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">åº—èˆ—</label>
                                            <select name="storeId" value={customerFormData.storeId} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                                {stores.map(store => (
                                                    <option key={store.id} value={store.id}>{store.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                        <input name="email" type="email" value={customerFormData.email} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="example@email.com" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">è³¼å…¥å›æ•°åˆ¸</label>
                                        <select name="ticketMasterId" value={customerFormData.ticketMasterId} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                            {ticketMasterList.map(ticket => (
                                                <option key={ticket.id} value={ticket.id}>{ticket.name} ({ticket.sessions}å› / Â¥{ticket.price.toLocaleString()})</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">è³¼å…¥æ—¥</label>
                                            <input name="purchaseDate" type="date" value={customerFormData.purchaseDate} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">æ®‹å›æ•°</label>
                                            <input name="remainingSessions" type="text" inputMode="numeric" value={customerFormData.remainingSessions} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={handleSave} className="px-4 py-2 text-sm bg-gold-500 hover:bg-gold-600 text-white rounded font-medium shadow-sm">ä¿å­˜ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border border-rose-200">
                                <div className="flex items-center mb-4">
                                    <Icon name="alert-triangle" size={24} className="text-rose-500 mr-3" />
                                    <h3 className="text-lg font-bold text-brown-800">å‰Šé™¤ã®ç¢ºèª</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    ã“ã®{editingType === 'master' ? 'å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼' : 'é¡§å®¢'}ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">å‰Šé™¤ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Menu Management View ---
        const MenuManagementView = ({ menuList, onUpdateMenu, onAddMenu, onDeleteMenu }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                price: 0,
                cost: 0,
                availableStores: []
            });

            const startEdit = (menu) => {
                setEditingId(menu.id);
                setFormData({
                    name: menu.name,
                    price: menu.price,
                    cost: menu.cost || 0,
                    availableStores: Array.isArray(menu.availableStores) ? menu.availableStores : []
                });
                setIsEditing(true);
            };

            const startAdd = () => {
                setEditingId(null);
                setFormData({
                    name: '',
                    price: 0,
                    cost: 0,
                    availableStores: []
                });
                setIsEditing(true);
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name'].includes(name);

                setFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value : (() => {
                        const processedValue = normalizeNumberInput(value);
                        return processedValue === '' ? 0 : Number(processedValue);
                    })()
                }));
            };

            const handleStoreToggle = (storeId) => {
                setFormData(prev => ({
                    ...prev,
                    availableStores: prev.availableStores.includes(storeId)
                        ? prev.availableStores.filter(id => id !== storeId)
                        : [...prev.availableStores, storeId]
                }));
            };

            const handleSubmit = () => {
                if (!formData.name.trim()) {
                    alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (editingId) {
                    onUpdateMenu(editingId, { ...formData, id: editingId });
                } else {
                    const newMenu = {
                        ...formData,
                        id: Date.now()
                    };
                    onAddMenu(newMenu);
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const confirmDelete = () => {
                if (deletingId) {
                    onDeleteMenu(deletingId);
                }
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-brown-800 serif">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</h2>
                            <p className="text-sm text-gray-600 mt-1">æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç™»éŒ²ãƒ»ç·¨é›†ãƒ»å‰Šé™¤</p>
                        </div>
                        <button
                            onClick={startAdd}
                            className="flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium shadow-sm transition-colors"
                        >
                            <Icon name="plus" size={18} className="mr-2" />
                            ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ–°è¦ç™»éŒ²
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {!Array.isArray(menuList) || menuList.length === 0 ? (
                            <div className="col-span-full text-center py-12 text-gray-400">
                                <Icon name="package" size={48} className="mx-auto mb-4 opacity-30" />
                                <p className="text-sm">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                <p className="text-xs mt-2">ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼æ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p>
                            </div>
                        ) : (
                            menuList.map(menu => (
                                <div key={menu.id} className="bg-white border border-purple-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                    <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => startEdit(menu)}
                                            className="text-gray-300 hover:text-blue-500 p-1"
                                        >
                                            <Icon name="edit-2" size={16} />
                                        </button>
                                        <button
                                            onClick={() => { setDeletingId(menu.id); setShowDeleteConfirm(true); }}
                                            className="text-gray-300 hover:text-rose-500 p-1"
                                        >
                                            <Icon name="trash-2" size={16} />
                                        </button>
                                    </div>

                                    <div className="mb-4">
                                        <div className="w-12 h-12 rounded-full bg-purple-50 border border-purple-200 flex items-center justify-center text-purple-700 mb-3">
                                            <Icon name="package" size={24} />
                                        </div>
                                        <h3 className="font-bold text-brown-800 text-lg mb-1">{menu.name}</h3>
                                        <p className="text-2xl font-bold text-purple-600">Â¥{menu.price.toLocaleString()}</p>

                                        {/* åŸä¾¡ãƒ»ç²—åˆ©è¡¨ç¤º */}
                                        {menu.cost !== undefined && menu.cost > 0 && (
                                            <div className="mt-3 pt-3 border-t border-purple-100 space-y-1">
                                                <div className="flex justify-between text-xs">
                                                    <span className="text-gray-500">åŸä¾¡</span>
                                                    <span className="text-gray-700">Â¥{menu.cost.toLocaleString()}</span>
                                                </div>
                                                <div className="flex justify-between text-xs">
                                                    <span className="text-gray-500">ç²—åˆ©</span>
                                                    <span className={`font-bold ${
                                                        ((menu.price - menu.cost) / menu.price * 100) >= 70 ? 'text-green-600' :
                                                        ((menu.price - menu.cost) / menu.price * 100) >= 50 ? 'text-yellow-600' :
                                                        'text-rose-600'
                                                    }`}>
                                                        Â¥{(menu.price - menu.cost).toLocaleString()}
                                                        ({Math.round((menu.price - menu.cost) / menu.price * 100)}%)
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="pt-3 border-t border-gray-100">
                                        <p className="text-xs text-gray-500 mb-2">æä¾›åº—èˆ—</p>
                                        <div className="flex flex-wrap gap-1">
                                            {(menu.availableStores || []).map(storeId => {
                                                const store = stores.find(s => s.id === storeId);
                                                return store ? (
                                                    <span key={storeId} className="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded">
                                                        {store.name}
                                                    </span>
                                                ) : null;
                                            })}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {/* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {isEditing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                                <h3 className="text-xl font-bold text-brown-800 mb-4 serif">
                                    {editingId ? 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç·¨é›†' : 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ–°è¦ç™»éŒ²'}
                                </h3>

                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</label>
                                        <input
                                            type="text"
                                            name="name"
                                            value={formData.name}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 outline-none"
                                            placeholder="ä¾‹: å‰¥é›¢ã‚ã‚Šãƒãƒ¼ãƒ–ãƒ”ãƒ¼ãƒªãƒ³ã‚°(é¡”)"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="price"
                                            value={formData.price}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">åŸä¾¡ï¼ˆå††ï¼‰</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="cost"
                                            value={formData.cost}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 outline-none"
                                        />
                                        {formData.price > 0 && formData.cost > 0 && (
                                            <p className="text-xs text-gray-600 mt-1">
                                                ç²—åˆ©: Â¥{(formData.price - formData.cost).toLocaleString()}
                                                ({Math.round((formData.price - formData.cost) / formData.price * 100)}%)
                                            </p>
                                        )}
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-2 block">æä¾›åº—èˆ—</label>
                                        <div className="space-y-2">
                                            {stores.map(store => (
                                                <label key={store.id} className="flex items-center space-x-2 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={formData.availableStores.includes(store.id)}
                                                        onChange={() => handleStoreToggle(store.id)}
                                                        className="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                                    />
                                                    <span className="text-sm text-gray-700">{store.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-end space-x-3 mt-6">
                                    <button
                                        onClick={() => setIsEditing(false)}
                                        className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg"
                                    >
                                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                    </button>
                                    <button
                                        onClick={handleSubmit}
                                        className="px-4 py-2 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium shadow-sm"
                                    >
                                        {editingId ? 'æ›´æ–°ã™ã‚‹' : 'ç™»éŒ²ã™ã‚‹'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-xl">
                                <div className="flex items-center space-x-3 mb-4">
                                    <div className="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center">
                                        <Icon name="alert-triangle" size={20} className="text-rose-600" />
                                    </div>
                                    <h3 className="text-lg font-bold text-brown-800">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">å‰Šé™¤ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Media Source Management View ---
        const MediaSourceManagementView = ({ mediaSourcesList, onUpdateMedia, onAddMedia, onDeleteMedia }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                newVisits: 0,
                repeatRate: 0,
                cpa: 0,
                sales: 0,
                adCost: 0
            });

            const startEdit = (media) => {
                setEditingId(media.id);
                setFormData({
                    name: media.name,
                    newVisits: media.newVisits || 0,
                    repeatRate: media.repeatRate || 0,
                    cpa: media.cpa || 0,
                    sales: media.sales || 0,
                    adCost: media.adCost || 0
                });
                setIsEditing(true);
            };

            const startAdd = () => {
                setEditingId(null);
                setFormData({
                    name: '',
                    newVisits: 0,
                    repeatRate: 0,
                    cpa: 0,
                    sales: 0,
                    adCost: 0
                });
                setIsEditing(true);
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name'].includes(name);

                setFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value : (() => {
                        const processedValue = normalizeNumberInput(value);
                        return processedValue === '' ? 0 : Number(processedValue);
                    })()
                }));
            };

            const handleSubmit = () => {
                if (!formData.name.trim()) {
                    alert('åª’ä½“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (editingId) {
                    onUpdateMedia(editingId, { ...formData, id: editingId });
                } else {
                    const newMedia = {
                        ...formData,
                        id: Date.now()
                    };
                    onAddMedia(newMedia);
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const confirmDelete = () => {
                if (deletingId) {
                    onDeleteMedia(deletingId);
                }
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-brown-800 serif">åª’ä½“ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</h2>
                            <p className="text-sm text-gray-600 mt-1">é›†å®¢åª’ä½“ã®ç™»éŒ²ãƒ»ç·¨é›†ãƒ»å‰Šé™¤</p>
                        </div>
                        <button
                            onClick={startAdd}
                            className="flex items-center px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium shadow-sm transition-colors"
                        >
                            <Icon name="plus" size={18} className="mr-2" />
                            åª’ä½“æ–°è¦ç™»éŒ²
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {!Array.isArray(mediaSourcesList) || mediaSourcesList.length === 0 ? (
                            <div className="col-span-full text-center py-12 text-gray-400">
                                <Icon name="megaphone" size={48} className="mx-auto mb-4 opacity-30" />
                                <p className="text-sm">åª’ä½“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                <p className="text-xs mt-2">ã€Œåª’ä½“æ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p>
                            </div>
                        ) : (
                            mediaSourcesList.map(media => {
                                const roas = media.adCost > 0 ? ((media.sales / media.adCost) * 100).toFixed(0) : '-';
                                return (
                                    <div key={media.id} className="bg-white border border-amber-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                        <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button
                                                onClick={() => startEdit(media)}
                                                className="text-gray-300 hover:text-blue-500 p-1"
                                            >
                                                <Icon name="edit-2" size={16} />
                                            </button>
                                            <button
                                                onClick={() => { setDeletingId(media.id); setShowDeleteConfirm(true); }}
                                                className="text-gray-300 hover:text-rose-500 p-1"
                                            >
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>

                                        <div className="mb-4">
                                            <div className="w-12 h-12 rounded-full bg-amber-50 border border-amber-200 flex items-center justify-center text-amber-700 mb-3">
                                                <Icon name="megaphone" size={24} />
                                            </div>
                                            <h3 className="font-bold text-brown-800 text-lg mb-1">{media.name}</h3>
                                        </div>

                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">æ–°è¦é›†å®¢æ•°</span>
                                                <span className="font-bold text-blue-600">{media.newVisits}äºº</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">ãƒªãƒ”ãƒ¼ãƒˆç‡</span>
                                                <span className="font-bold text-emerald-600">{media.repeatRate}%</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">ç²å¾—å˜ä¾¡(CPA)</span>
                                                <span className="font-bold">Â¥{media.cpa.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">åºƒå‘Šè²»</span>
                                                <span className="font-bold text-rose-600">Â¥{media.adCost.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">å£²ä¸Šè²¢çŒ®</span>
                                                <span className="font-bold text-purple-600">Â¥{media.sales.toLocaleString()}</span>
                                            </div>
                                            {roas !== '-' && (
                                                <div className="flex justify-between pt-2 border-t border-gray-100">
                                                    <span className="text-gray-500 font-semibold">ROAS</span>
                                                    <span className={`font-bold ${
                                                        Number(roas) >= 300 ? 'text-green-600' :
                                                        Number(roas) >= 150 ? 'text-yellow-600' :
                                                        'text-red-600'
                                                    }`}>
                                                        {roas}%
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {/* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {isEditing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold text-brown-800 mb-4 serif">
                                    {editingId ? 'åª’ä½“ç·¨é›†' : 'åª’ä½“æ–°è¦ç™»éŒ²'}
                                </h3>

                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">åª’ä½“å</label>
                                        <input
                                            type="text"
                                            name="name"
                                            value={formData.name}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                            placeholder="ä¾‹: ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">æ–°è¦é›†å®¢æ•°ï¼ˆäººï¼‰</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="newVisits"
                                            value={formData.newVisits}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">ãƒªãƒ”ãƒ¼ãƒˆç‡ï¼ˆ%ï¼‰</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="repeatRate"
                                            value={formData.repeatRate}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">ç²å¾—å˜ä¾¡ï¼ˆå††ï¼‰</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="cpa"
                                            value={formData.cpa}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">åºƒå‘Šè²»ï¼ˆå††ï¼‰</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="adCost"
                                            value={formData.adCost}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">å£²ä¸Šè²¢çŒ®ï¼ˆå††ï¼‰</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="sales"
                                            value={formData.sales}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="flex justify-end space-x-3 mt-6">
                                    <button
                                        onClick={() => setIsEditing(false)}
                                        className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg"
                                    >
                                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                    </button>
                                    <button
                                        onClick={handleSubmit}
                                        className="px-4 py-2 text-sm bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium shadow-sm"
                                    >
                                        {editingId ? 'æ›´æ–°ã™ã‚‹' : 'ç™»éŒ²ã™ã‚‹'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-xl">
                                <div className="flex items-center space-x-3 mb-4">
                                    <div className="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center">
                                        <Icon name="alert-triangle" size={20} className="text-rose-600" />
                                    </div>
                                    <h3 className="text-lg font-bold text-brown-800">åª’ä½“å‰Šé™¤</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    ã“ã®åª’ä½“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">å‰Šé™¤ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Menu Analysis View ---
        const MenuAnalysisView = ({ menuSalesData }) => {
            if (!window.Recharts) return <div>Loading Charts...</div>;

            const safeMenuSalesData = Array.isArray(menuSalesData) ? menuSalesData : [];
            const hasData = safeMenuSalesData.length > 0;

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„
            const aggregatedMenuData = useMemo(() => {
                if (!hasData) return [];

                const menuMap = {};
                safeMenuSalesData.forEach(entry => {
                    if (!menuMap[entry.menuId]) {
                        menuMap[entry.menuId] = {
                            menuId: entry.menuId,
                            menuName: entry.menuName,
                            count: 0,
                            sales: 0,
                            storeIds: new Set()
                        };
                    }
                    menuMap[entry.menuId].count += entry.count || 0;
                    menuMap[entry.menuId].sales += entry.sales || 0;
                    menuMap[entry.menuId].storeIds.add(entry.storeId);
                });

                return Object.values(menuMap).map(menu => ({
                    ...menu,
                    storeIds: Array.from(menu.storeIds)
                }));
            }, [safeMenuSalesData, hasData]);

            const totalMenuSales = hasData ? safeMenuSalesData.reduce((sum, m) => sum + (m.sales || 0), 0) : 0;
            const totalMenuCount = hasData ? safeMenuSalesData.reduce((sum, m) => sum + (m.count || 0), 0) : 0;
            const topMenu = aggregatedMenuData.length > 0 ? [...aggregatedMenuData].sort((a, b) => (b.count || 0) - (a.count || 0))[0] : null;

            if (!hasData) {
                return (
                    <div className="text-center py-12 text-gray-400">
                        <Icon name="package" size={48} className="mx-auto mb-4 opacity-30" />
                        <p className="text-lg font-bold text-brown-800">ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p className="text-sm mt-2">æ—¥æ¬¡å£²ä¸Šã®å…¥åŠ›ã‚’è¡Œã†ã¨ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥ã®åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šã‚«ãƒ¼ãƒ‰ */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <KpiCard
                            title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç·å£²ä¸Š"
                            value={`Â¥${totalMenuSales.toLocaleString()}`}
                            subValue={`ç·æ–½è¡“å›æ•°: ${totalMenuCount}å›`}
                            trend={null}
                            icon="shopping-bag"
                            color="bg-gold-600"
                        />
                        <KpiCard
                            title="å¹³å‡æ–½è¡“å˜ä¾¡"
                            value={totalMenuCount > 0 ? `Â¥${Math.round(totalMenuSales / totalMenuCount).toLocaleString()}` : 'Â¥0'}
                            subValue="å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¹³å‡"
                            trend={null}
                            icon="trending-up"
                            color="bg-emerald-600"
                        />
                        <KpiCard
                            title="äººæ°—No.1ãƒ¡ãƒ‹ãƒ¥ãƒ¼"
                            value={topMenu ? topMenu.menuName.substring(0, 10) : '-'}
                            subValue={topMenu ? `${topMenu.count}å›å®Ÿæ–½` : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}
                            trend={null}
                            icon="award"
                            color="bg-rose-500"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šãƒ†ãƒ¼ãƒ–ãƒ« */}
                        <Card>
                            <h2 className="text-lg font-bold text-brown-800 mb-6 serif">ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šè©³ç´°</h2>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="border-b border-gold-100 text-xs text-gray-500 uppercase">
                                            <th className="py-3 font-medium">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</th>
                                            <th className="py-3 font-medium text-right">å›æ•°</th>
                                            <th className="py-3 font-medium text-right">å£²ä¸Š</th>
                                            <th className="py-3 font-medium text-center">å¯¾å¿œåº—èˆ—</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm divide-y divide-gray-50">
                                        {aggregatedMenuData.map((menu) => (
                                            <tr key={menu.menuId} className="hover:bg-gold-50/50">
                                                <td className="py-3 font-medium text-brown-800">{menu.menuName}</td>
                                                <td className="py-3 text-right">{menu.count}å›</td>
                                                <td className="py-3 text-right font-bold">Â¥{menu.sales.toLocaleString()}</td>
                                                <td className="py-3 text-center">
                                                    <span className="text-xs px-2 py-1 bg-gray-100 rounded">
                                                        {menu.storeIds.length === 2 ? 'ä¸¡åº—èˆ—' : menu.storeIds.includes(1) ? 'æ–°å®¿åº—ã®ã¿' : 'æ–°å®¿å—å£åº—ã®ã¿'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>

                        {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šã‚°ãƒ©ãƒ• */}
                        <Card>
                            <h2 className="text-lg font-bold text-brown-800 mb-6 serif">ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šæ§‹æˆæ¯”</h2>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={aggregatedMenuData} layout="vertical">
                                    <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e5e7eb" />
                                    <XAxis type="number" tick={{fontSize: 10}} tickFormatter={(val) => `Â¥${val/10000}ä¸‡`} />
                                    <YAxis type="category" dataKey="menuName" tick={{fontSize: 9}} width={120} />
                                    <Tooltip
                                        formatter={(value) => `Â¥${value.toLocaleString()}`}
                                        contentStyle={{backgroundColor: '#fff', borderColor: '#d4af37'}}
                                    />
                                    <Bar dataKey="sales" name="å£²ä¸Š" fill="#d4af37" radius={[0, 4, 4, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>

                    {/* åº—èˆ—é™å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ³¨æ„æ›¸ã */}
                    <Card className="bg-gold-50 border-gold-300">
                        <div className="flex items-start">
                            <Icon name="info" size={20} className="text-gold-600 mr-3 mt-1" />
                            <div>
                                <h3 className="font-bold text-brown-800 mb-2">åº—èˆ—é™å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±</h3>
                                <p className="text-sm text-gray-700">
                                    ã€Œã‚ˆã‚‚ãè’¸ã—ã€ã¨ã€Œã‚»ãƒ«ãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°ã€ã¯<span className="font-bold text-gold-700">æ–°å®¿å—å£åº—ã§ã®ã¿</span>æä¾›ã—ã¦ã„ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã™ã€‚
                                    æ–°å®¿åº—ã§ã‚‚æä¾›ã‚’æ¤œè¨ã™ã‚‹å ´åˆã¯ã€è¨­å‚™æŠ•è³‡ã¨åç›Šæ€§ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- Performance Input View ---
        const PerformanceInputView = ({ dailySalesData, setDailySalesData, menuSalesData, setMenuSalesData, staffList = [] }) => {
            const [activeInputTab, setActiveInputTab] = useState('daily'); // 'daily' or 'menu'

            // æ—¥æ¬¡å£²ä¸Šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
            const [dailyForm, setDailyForm] = useState({
                date: new Date().toISOString().split('T')[0],
                storeId: 1,
                staffId: null, // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                spotSales: 0,
                ticketSales: 0,
                ticketUsage: 0,
                product: 0
            });

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å£²ä¸Šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
            const [menuForm, setMenuForm] = useState({
                date: new Date().toISOString().split('T')[0],
                menuId: 1,
                storeId: 1,
                staffId: null, // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                count: 0
            });

            const handleDailyFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['date'].includes(name);
                const isSelectNumber = ['staffId', 'storeId', 'menuId'].includes(name);

                setDailyForm(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            (name === 'staffId' && value === '') ? null :
                            isSelectNumber ? (value === '' ? null : Number(value)) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            const handleMenuFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['date'].includes(name);
                const isSelectNumber = ['staffId', 'storeId', 'menuId'].includes(name);

                setMenuForm(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            (name === 'staffId' && value === '') ? null :
                            isSelectNumber ? (value === '' ? null : Number(value)) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            const handleDailySalesSubmit = () => {
                const store = stores.find(s => s.id === dailyForm.storeId);
                if (!store) {
                    alert('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                const accountingSales = dailyForm.spotSales + dailyForm.ticketUsage + dailyForm.product;
                const cashIn = dailyForm.spotSales + dailyForm.ticketSales + dailyForm.product;

                const newEntry = {
                    day: new Date(dailyForm.date).getDate() + 'æ—¥',
                    date: dailyForm.date,
                    storeId: dailyForm.storeId,
                    storeName: store.name,
                    spotSales: dailyForm.spotSales,
                    ticketSales: dailyForm.ticketSales,
                    ticketUsage: dailyForm.ticketUsage,
                    product: dailyForm.product,
                    accountingSales,
                    cashIn,
                    storeData: [{
                        storeId: dailyForm.storeId,
                        storeName: store.name,
                        spotSales: dailyForm.spotSales,
                        ticketSales: dailyForm.ticketSales,
                        ticketUsage: dailyForm.ticketUsage,
                        product: dailyForm.product,
                        accountingSales,
                        cashIn
                    }]
                };

                setDailySalesData(prev => [...prev, newEntry]);

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                setDailyForm({
                    date: new Date().toISOString().split('T')[0],
                    storeId: 1,
                    spotSales: 0,
                    ticketSales: 0,
                    ticketUsage: 0,
                    product: 0
                });

                alert('æ—¥æ¬¡å£²ä¸Šã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
            };

            const handleMenuSalesSubmit = () => {
                const menu = menus.find(m => m.id === menuForm.menuId);
                const sales = menuForm.count * menu.price;

                const newEntry = {
                    id: Date.now(),
                    date: menuForm.date,
                    menuId: menuForm.menuId,
                    menuName: menu.name,
                    storeId: menuForm.storeId,
                    count: menuForm.count,
                    sales,
                    availableStores: menu.availableStores
                };

                setMenuSalesData(prev => [...prev, newEntry]);

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                setMenuForm({
                    date: new Date().toISOString().split('T')[0],
                    menuId: 1,
                    storeId: 1,
                    count: 0
                });

                alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å£²ä¸Šã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
            };

            return (
                <div className="space-y-6">
                    {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */}
                    <div className="flex gap-2 bg-white rounded-lg p-1 border border-gold-200 inline-flex">
                        <button
                            onClick={() => setActiveInputTab('daily')}
                            className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                activeInputTab === 'daily' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                            }`}
                        >
                            æ—¥æ¬¡å£²ä¸Šå…¥åŠ›
                        </button>
                        <button
                            onClick={() => setActiveInputTab('menu')}
                            className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                activeInputTab === 'menu' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                            }`}
                        >
                            ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šå…¥åŠ›
                        </button>
                    </div>

                    {/* æ—¥æ¬¡å£²ä¸Šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */}
                    {activeInputTab === 'daily' && (
                        <Card>
                            <h2 className="text-xl font-bold text-brown-800 mb-6 serif">æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">æ—¥ä»˜</label>
                                    <input
                                        type="date"
                                        name="date"
                                        value={dailyForm.date}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">åº—èˆ—</label>
                                    <select
                                        name="storeId"
                                        value={dailyForm.storeId}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        {stores.map(store => (
                                            <option key={store.id} value={store.id}>{store.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆä»»æ„ï¼‰</label>
                                    <select
                                        name="staffId"
                                        value={dailyForm.staffId || ''}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        <option value="">å…¨ä½“ï¼ˆã‚¹ã‚¿ãƒƒãƒ•æŒ‡å®šãªã—ï¼‰</option>
                                        {(staffList || []).filter(s => s.storeId === dailyForm.storeId).map(staff => (
                                            <option key={staff.id} value={staff.id}>{staff.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">éƒ½åº¦æ‰•ã„å£²ä¸Š (å††)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="spotSales"
                                        value={dailyForm.spotSales}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">å›æ•°åˆ¸è²©å£² (å††)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="ticketSales"
                                        value={dailyForm.ticketSales}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">å›æ•°åˆ¸æ¶ˆåŒ– (å††)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="ticketUsage"
                                        value={dailyForm.ticketUsage}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">ç‰©è²©å£²ä¸Š (å††)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="product"
                                        value={dailyForm.product}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button
                                    onClick={handleDailySalesSubmit}
                                    className="px-6 py-3 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-lg shadow-sm transition-colors"
                                >
                                    ç™»éŒ²ã™ã‚‹
                                </button>
                            </div>
                        </Card>
                    )}

                    {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */}
                    {activeInputTab === 'menu' && (
                        <Card>
                            <h2 className="text-xl font-bold text-brown-800 mb-6 serif">ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">æ—¥ä»˜</label>
                                    <input
                                        type="date"
                                        name="date"
                                        value={menuForm.date}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">åº—èˆ—</label>
                                    <select
                                        name="storeId"
                                        value={menuForm.storeId}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        {stores.map(store => (
                                            <option key={store.id} value={store.id}>{store.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</label>
                                    <select
                                        name="menuId"
                                        value={menuForm.menuId}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        {menus.filter(m => m.availableStores.includes(menuForm.storeId)).map(menu => (
                                            <option key={menu.id} value={menu.id}>
                                                {menu.name} (Â¥{menu.price.toLocaleString()})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆä»»æ„ï¼‰</label>
                                    <select
                                        name="staffId"
                                        value={menuForm.staffId || ''}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        <option value="">å…¨ä½“ï¼ˆã‚¹ã‚¿ãƒƒãƒ•æŒ‡å®šãªã—ï¼‰</option>
                                        {(staffList || []).filter(s => s.storeId === menuForm.storeId).map(staff => (
                                            <option key={staff.id} value={staff.id}>{staff.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">æ–½è¡“å›æ•°</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="count"
                                        value={menuForm.count}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                            </div>
                            <div className="mt-6 bg-gold-50 rounded-lg p-4">
                                <p className="text-sm text-gray-700">
                                    <strong>äºˆæƒ³å£²ä¸Š:</strong> Â¥{(menuForm.count * (menus.find(m => m.id === menuForm.menuId)?.price || 0)).toLocaleString()}
                                </p>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button
                                    onClick={handleMenuSalesSubmit}
                                    className="px-6 py-3 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-lg shadow-sm transition-colors"
                                >
                                    ç™»éŒ²ã™ã‚‹
                                </button>
                            </div>
                        </Card>
                    )}

                    {/* ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ */}
                    {activeInputTab === 'daily' && dailySalesData.length > 0 && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4">ç™»éŒ²æ¸ˆã¿æ—¥æ¬¡å£²ä¸Šï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gold-50 border-b border-gold-100">
                                        <tr className="text-left text-xs text-gray-500 uppercase">
                                            <th className="py-2 px-3">æ—¥ä»˜</th>
                                            <th className="py-2 px-3">åº—èˆ—</th>
                                            <th className="py-2 px-3 text-right">éƒ½åº¦æ‰•ã„</th>
                                            <th className="py-2 px-3 text-right">å›æ•°åˆ¸è²©å£²</th>
                                            <th className="py-2 px-3 text-right">å›æ•°åˆ¸æ¶ˆåŒ–</th>
                                            <th className="py-2 px-3 text-right">ç‰©è²©</th>
                                            <th className="py-2 px-3 text-right">åˆè¨ˆå£²ä¸Š</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {dailySalesData.slice(-10).reverse().map((item, index) => (
                                            <tr key={index} className="hover:bg-gold-50/30">
                                                <td className="py-2 px-3">{item.date || item.day}</td>
                                                <td className="py-2 px-3">{item.storeName}</td>
                                                <td className="py-2 px-3 text-right">Â¥{item.spotSales.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right">Â¥{item.ticketSales.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right">Â¥{item.ticketUsage.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right">Â¥{item.product.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right font-bold">Â¥{item.accountingSales.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    )}

                    {activeInputTab === 'menu' && menuSalesData.length > 0 && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4">ç™»éŒ²æ¸ˆã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼å£²ä¸Šï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gold-50 border-b border-gold-100">
                                        <tr className="text-left text-xs text-gray-500 uppercase">
                                            <th className="py-2 px-3">æ—¥ä»˜</th>
                                            <th className="py-2 px-3">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th>
                                            <th className="py-2 px-3 text-right">å›æ•°</th>
                                            <th className="py-2 px-3 text-right">å£²ä¸Š</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {(menuSalesData || []).slice(-10).reverse().map((item, index) => (
                                            <tr key={index} className="hover:bg-gold-50/30">
                                                <td className="py-2 px-3">{item.date}</td>
                                                <td className="py-2 px-3">{item.menuName}</td>
                                                <td className="py-2 px-3 text-right">{item.count}å›</td>
                                                <td className="py-2 px-3 text-right font-bold">Â¥{item.sales.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // --- Simulation View (Reused but Styled) ---
        // --- Calendar View Component ---
        const CalendarView = ({ dailySalesData, staffId = null }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);

            // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’å–å¾—
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
            const startingDayOfWeek = firstDay.getDay(); // 0 (æ—¥æ›œ) ~ 6 (åœŸæ›œ)
            const daysInMonth = lastDay.getDate();

            // æœˆã‚’å¤‰æ›´
            const changeMonth = (offset) => {
                setCurrentDate(new Date(year, month + offset, 1));
                setSelectedDate(null);
            };

            // æ—¥ä»˜ã‹ã‚‰å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆdateå½¢å¼: '2026-01-15'ã«å¯¾å¿œï¼‰
            const getSalesForDay = (day) => {
                if (!dailySalesData || dailySalesData.length === 0) return null;

                // ç¾åœ¨ã®å¹´æœˆã¨æ—¥ã‹ã‚‰æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
                const targetDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // ãã®æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å–å¾—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let dayData = dailySalesData.filter(d => {
                    if (!d.date) return false;
                    return d.date === targetDate;
                });

                // ã‚¹ã‚¿ãƒƒãƒ•IDã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼‰
                if (staffId) {
                    dayData = dayData.filter(d => d.staffId === staffId);
                }

                if (dayData.length === 0) return null;

                // åŒã˜æ—¥ã®è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚’åˆç®—
                const aggregated = {
                    date: targetDate,
                    spotSales: 0,
                    ticketSales: 0,
                    ticketUsage: 0,
                    product: 0,
                    accountingSales: 0,
                    cashIn: 0,
                    storeData: []
                };

                // åº—èˆ—åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                const storeMap = {};

                dayData.forEach(d => {
                    aggregated.spotSales += d.spotSales || 0;
                    aggregated.ticketSales += d.ticketSales || 0;
                    aggregated.ticketUsage += d.ticketUsage || 0;
                    aggregated.product += d.product || 0;
                    aggregated.accountingSales += d.accountingSales || 0;
                    aggregated.cashIn += d.cashIn || 0;

                    // åº—èˆ—åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                    if (d.storeId && d.storeName) {
                        if (!storeMap[d.storeId]) {
                            storeMap[d.storeId] = {
                                storeId: d.storeId,
                                storeName: d.storeName,
                                cashIn: 0,
                                accountingSales: 0
                            };
                        }
                        storeMap[d.storeId].cashIn += d.cashIn || 0;
                        storeMap[d.storeId].accountingSales += d.accountingSales || 0;
                    }
                });

                aggregated.storeData = Object.values(storeMap);

                return aggregated;
            };

            // å£²ä¸Šé¡ã«å¿œã˜ãŸè‰²ã‚’è¿”ã™
            const getSalesColor = (sales) => {
                if (!sales) return 'bg-gray-50 border-gray-200';
                if (sales.cashIn >= 250000) return 'bg-rose-50 border-rose-300';
                if (sales.cashIn >= 180000) return 'bg-orange-50 border-orange-300';
                if (sales.cashIn >= 120000) return 'bg-yellow-50 border-yellow-300';
                if (sales.cashIn >= 60000) return 'bg-blue-50 border-blue-300';
                return 'bg-gray-50 border-gray-200';
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ
            const calendarDays = [];

            // ç©ºç™½ã‚»ãƒ«ï¼ˆæœˆã®æœ€åˆã®æ›œæ—¥ã¾ã§ï¼‰
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarDays.push(<div key={`empty-${i}`} className="min-h-24"></div>);
            }

            // æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= daysInMonth; day++) {
                const salesData = getSalesForDay(day);
                const colorClass = getSalesColor(salesData);
                const isSelected = selectedDate === day;

                calendarDays.push(
                    <div
                        key={day}
                        onClick={() => setSelectedDate(day)}
                        className={`min-h-24 border-2 rounded-lg p-2 cursor-pointer transition-all ${colorClass} ${
                            isSelected ? 'ring-2 ring-gold-500 scale-105' : 'hover:shadow-md'
                        }`}
                    >
                        <div className="font-bold text-brown-800 text-sm mb-1">{day}</div>
                        {salesData ? (
                            <div className="space-y-1">
                                <div className="text-xs text-gray-600">
                                    Â¥{salesData.cashIn.toLocaleString()}
                                </div>
                                <div className="text-xs text-gray-500">
                                    {salesData.storeData && salesData.storeData.length > 0 ? (
                                        salesData.storeData.map((store, idx) => (
                                            <div key={idx}>{store.storeName}: Â¥{store.cashIn.toLocaleString()}</div>
                                        ))
                                    ) : null}
                                </div>
                            </div>
                        ) : (
                            <div className="text-xs text-gray-400">ä¼‘æ¥­</div>
                        )}
                    </div>
                );
            }

            const selectedDayData = selectedDate ? getSalesForDay(selectedDate) : null;

            return (
                <div className="space-y-6">
                    <Card>
                        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-brown-800 serif">
                                    {staffId ? 'ãƒã‚¤ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼' : 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼'}
                                </h2>
                                <p className="text-sm text-gray-500 mt-1">
                                    {staffId ? 'å€‹äººã®æœˆé–“å£²ä¸Šã‚’ç¢ºèª' : 'æœˆé–“å£²ä¸Šã‚’ä¸€ç›®ã§ç¢ºèª'}
                                </p>
                            </div>
                            <div className="flex items-center space-x-4">
                                <button
                                    onClick={() => changeMonth(-1)}
                                    className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                >
                                    <Icon name="chevron-left" size={20} />
                                </button>
                                <h3 className="text-xl font-bold text-brown-800 min-w-[160px] text-center">
                                    {year}å¹´{month + 1}æœˆ
                                </h3>
                                <button
                                    onClick={() => changeMonth(1)}
                                    className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                >
                                    <Icon name="chevron-right" size={20} />
                                </button>
                            </div>
                        </div>

                        {/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                        <div className="grid grid-cols-7 gap-2 mb-2">
                            {['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map(day => (
                                <div key={day} className="text-center font-bold text-sm text-gray-600 py-2">
                                    {day}
                                </div>
                            ))}
                        </div>

                        {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */}
                        <div className="grid grid-cols-7 gap-2">
                            {calendarDays}
                        </div>

                        {/* å‡¡ä¾‹ */}
                        <div className="mt-6 pt-6 border-t border-gray-200">
                            <p className="text-xs text-gray-600 mb-2 font-semibold">å£²ä¸Šãƒ¬ãƒ™ãƒ«</p>
                            <div className="flex flex-wrap gap-3 text-xs">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-gray-50 border border-gray-200"></div>
                                    <span className="text-gray-600">ä¼‘æ¥­</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-blue-50 border border-blue-300"></div>
                                    <span className="text-gray-600">~Â¥60k</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-yellow-50 border border-yellow-300"></div>
                                    <span className="text-gray-600">Â¥60k~Â¥120k</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-orange-50 border border-orange-300"></div>
                                    <span className="text-gray-600">Â¥120k~Â¥180k</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-rose-50 border border-rose-300"></div>
                                    <span className="text-gray-600">Â¥180k~</span>
                                </div>
                            </div>
                        </div>
                    </Card>

                    {/* é¸æŠã•ã‚ŒãŸæ—¥ã®è©³ç´° */}
                    {selectedDayData && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4">
                                {month + 1}æœˆ{selectedDate}æ—¥ã®è©³ç´°
                            </h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">éƒ½åº¦æ‰•ã„</p>
                                    <p className="text-xl font-bold text-blue-700">Â¥{selectedDayData.spotSales.toLocaleString()}</p>
                                </div>
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">å›æ•°åˆ¸è²©å£²</p>
                                    <p className="text-xl font-bold text-purple-700">Â¥{selectedDayData.ticketSales.toLocaleString()}</p>
                                </div>
                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">å›æ•°åˆ¸æ¶ˆåŒ–</p>
                                    <p className="text-xl font-bold text-emerald-700">Â¥{selectedDayData.ticketUsage.toLocaleString()}</p>
                                </div>
                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">ç‰©è²©</p>
                                    <p className="text-xl font-bold text-amber-700">Â¥{selectedDayData.product.toLocaleString()}</p>
                                </div>
                                <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">ä¼šè¨ˆä¸Šå£²ä¸Š</p>
                                    <p className="text-xl font-bold text-rose-700">Â¥{selectedDayData.accountingSales.toLocaleString()}</p>
                                </div>
                                <div className="bg-gold-50 border border-gold-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³</p>
                                    <p className="text-xl font-bold text-gold-600">Â¥{selectedDayData.cashIn.toLocaleString()}</p>
                                </div>
                            </div>

                            {/* åº—èˆ—åˆ¥ãƒ‡ãƒ¼ã‚¿ */}
                            {selectedDayData.storeData && selectedDayData.storeData.length > 0 && (
                                <div className="mt-6 pt-6 border-t border-gray-200">
                                    <h4 className="text-sm font-bold text-gray-700 mb-3">åº—èˆ—åˆ¥</h4>
                                    <div className="space-y-3">
                                        {selectedDayData.storeData.map((store, idx) => (
                                            <div key={idx} className="bg-gray-50 rounded-lg p-3">
                                                <p className="font-bold text-brown-800 mb-2">{store.storeName}</p>
                                                <div className="grid grid-cols-2 gap-2 text-xs">
                                                    <div>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³: Â¥{store.cashIn.toLocaleString()}</div>
                                                    <div>ä¼šè¨ˆä¸Šå£²ä¸Š: Â¥{store.accountingSales.toLocaleString()}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </Card>
                    )}
                </div>
            );
        };

        const SimulationView = ({ staffList, onUpdateStaff }) => {
            const [selectedStaffId, setSelectedStaffId] = useState(null);
            const [targetSales, setTargetSales] = useState(0);
            const [manualTarget, setManualTarget] = useState('');

            // æ–°è¦ãƒ»ãƒªãƒ”ãƒ¼ãƒˆé–¢é€£
            const [newCustomers, setNewCustomers] = useState(0);
            const [repeatCustomers, setRepeatCustomers] = useState(0);
            const [newCustomerPrice, setNewCustomerPrice] = useState(0);
            const [repeatCustomerPrice, setRepeatCustomerPrice] = useState(0);

            // é¸æŠã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•
            const selectedStaff = selectedStaffId ? staffList.find(s => s.id === selectedStaffId) : null;

            // å›æ•°åˆ¸é–¢é€£
            const [ticketPurchaseRate, setTicketPurchaseRate] = useState(0); // %
            const [ticketAvgPrice, setTicketAvgPrice] = useState(0);

            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ»ç‰©è²©
            const [optionRate, setOptionRate] = useState(0); // %
            const [optionAvgPrice, setOptionAvgPrice] = useState(0);
            const [productSalesPerMonth, setProductSalesPerMonth] = useState(0);

            // è¨ˆç®—
            const totalCustomers = newCustomers + repeatCustomers;
            const ticketPurchaseCount = Math.round((newCustomers * ticketPurchaseRate) / 100);
            const optionCount = Math.round((totalCustomers * optionRate) / 100);

            const newCustomerSales = newCustomers * newCustomerPrice;
            const repeatCustomerSales = repeatCustomers * repeatCustomerPrice;
            const ticketSales = ticketPurchaseCount * ticketAvgPrice;
            const optionSales = optionCount * optionAvgPrice;

            const projectedSales = newCustomerSales + repeatCustomerSales + optionSales + productSalesPerMonth;
            const displayTarget = manualTarget ? Number(manualTarget) : targetSales;
            const progress = Math.min(100, (projectedSales / displayTarget) * 100);
            const diff = projectedSales - displayTarget;

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-xl font-bold text-brown-800 mb-2 serif">è©³ç´°å£²ä¸Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                                <p className="text-sm text-gray-500">æ–°è¦ãƒ»ãƒªãƒ”ãƒ¼ãƒˆãƒ»å›æ•°åˆ¸ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ»ç‰©è²©ã‚’å«ã‚ãŸè©³ç´°ãªå£²ä¸Šäºˆæ¸¬</p>
                            </div>
                            <div className="w-64">
                                <label className="text-xs font-medium text-gray-700 mb-1 block">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ</label>
                                <select
                                    value={selectedStaffId || ''}
                                    onChange={(e) => setSelectedStaffId(e.target.value ? Number(e.target.value) : null)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-gold-500 outline-none bg-white"
                                >
                                    <option value="">å…¨ä½“ç›®æ¨™</option>
                                    {(staffList || []).map(staff => (
                                        <option key={staff.id} value={staff.id}>
                                            {staff.name} ({staff.role})
                                        </option>
                                    ))}
                                </select>
                                {selectedStaff && (
                                    <div className="mt-2 space-y-2">
                                        <div className="text-xs text-gray-600">
                                            <p>ç¾åœ¨ã®å£²ä¸Š: <span className="font-bold text-brown-800">Â¥{selectedStaff.sales.toLocaleString()}</span></p>
                                            <p>ç¾åœ¨ã®ç›®æ¨™: <span className="font-bold text-brown-800">Â¥{selectedStaff.target.toLocaleString()}</span></p>
                                        </div>
                                        <button
                                            onClick={() => {
                                                if (onUpdateStaff && selectedStaff) {
                                                    const newTarget = displayTarget || 0;
                                                    onUpdateStaff(selectedStaff.id, {
                                                        ...selectedStaff,
                                                        target: newTarget
                                                    });
                                                    alert(`${selectedStaff.name}ã®ç›®æ¨™ã‚’Â¥${newTarget.toLocaleString()}ã«è¨­å®šã—ã¾ã—ãŸ`);
                                                }
                                            }}
                                            className="w-full px-3 py-2 bg-gold-600 hover:bg-gold-700 text-white text-xs font-medium rounded-lg transition-colors shadow-sm"
                                        >
                                            ã“ã®ç›®æ¨™ã‚’{selectedStaff.name}ã«è¨­å®š
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* å·¦ã‚«ãƒ©ãƒ : ç›®æ¨™è¨­å®š */}
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">æœˆé–“ç›®æ¨™å£²ä¸Šï¼ˆæ‰‹å…¥åŠ›å¯ï¼‰</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">Â¥</span>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            value={manualTarget || targetSales}
                                            onChange={(e) => setManualTarget(normalizeNumberInput(e.target.value))}
                                            className="w-full pl-8 pr-4 py-2 text-xl font-bold text-brown-800 bg-gold-50 border border-gold-200 rounded-lg focus:border-gold-500 outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-blue-900 mb-3">æ–°è¦é¡§å®¢</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">æ–°è¦äººæ•°</label>
                                            <input type="text" inputMode="numeric" value={newCustomers} onChange={(e) => setNewCustomers(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">æ–°è¦å˜ä¾¡</label>
                                            <input type="text" inputMode="numeric" value={newCustomerPrice} onChange={(e) => setNewCustomerPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" />
                                        </div>
                                        <div className="pt-2 border-t border-blue-200 text-sm font-bold text-blue-900">
                                            å£²ä¸Š: Â¥{newCustomerSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-emerald-900 mb-3">ãƒªãƒ”ãƒ¼ãƒˆé¡§å®¢</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">ãƒªãƒ”ãƒ¼ãƒˆäººæ•°</label>
                                            <input type="text" inputMode="numeric" value={repeatCustomers} onChange={(e) => setRepeatCustomers(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-emerald-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">ãƒªãƒ”ãƒ¼ãƒˆå˜ä¾¡</label>
                                            <input type="text" inputMode="numeric" value={repeatCustomerPrice} onChange={(e) => setRepeatCustomerPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-emerald-500 outline-none" />
                                        </div>
                                        <div className="pt-2 border-t border-emerald-200 text-sm font-bold text-emerald-900">
                                            å£²ä¸Š: Â¥{repeatCustomerSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* ä¸­å¤®ã‚«ãƒ©ãƒ : å›æ•°åˆ¸ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */}
                            <div className="space-y-6">
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-purple-900 mb-3">å›æ•°åˆ¸è²©å£²</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">è³¼å…¥ç‡ï¼ˆæ–°è¦ã®%ï¼‰</label>
                                            <div className="flex items-center gap-2">
                                                <input type="range" min="0" max="100" value={ticketPurchaseRate} onChange={(e) => setTicketPurchaseRate(Number(e.target.value))} className="flex-1 accent-purple-500" />
                                                <span className="text-sm font-bold text-purple-900 w-12">{ticketPurchaseRate}%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">å›æ•°åˆ¸å¹³å‡ä¾¡æ ¼</label>
                                            <input type="text" inputMode="numeric" value={ticketAvgPrice} onChange={(e) => setTicketAvgPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-purple-500 outline-none" />
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            äºˆæƒ³è³¼å…¥ä»¶æ•°: {ticketPurchaseCount}ä»¶
                                        </div>
                                        <div className="pt-2 border-t border-purple-200 text-sm font-bold text-purple-900">
                                            å£²ä¸Š: Â¥{ticketSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-amber-900 mb-3">ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ </h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">è¿½åŠ ç‡ï¼ˆå…¨ä½“ã®%ï¼‰</label>
                                            <div className="flex items-center gap-2">
                                                <input type="range" min="0" max="100" value={optionRate} onChange={(e) => setOptionRate(Number(e.target.value))} className="flex-1 accent-amber-500" />
                                                <span className="text-sm font-bold text-amber-900 w-12">{optionRate}%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¹³å‡ä¾¡æ ¼</label>
                                            <input type="text" inputMode="numeric" value={optionAvgPrice} onChange={(e) => setOptionAvgPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-amber-500 outline-none" />
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            äºˆæƒ³è¿½åŠ ä»¶æ•°: {optionCount}ä»¶
                                        </div>
                                        <div className="pt-2 border-t border-amber-200 text-sm font-bold text-amber-900">
                                            å£²ä¸Š: Â¥{optionSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-rose-900 mb-3">ç‰©è²©å£²ä¸Š</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">æœˆé–“ç‰©è²©å£²ä¸Š</label>
                                            <input type="text" inputMode="numeric" value={productSalesPerMonth} onChange={(e) => setProductSalesPerMonth(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-rose-500 outline-none" />
                                        </div>
                                        <div className="pt-2 border-t border-rose-200 text-sm font-bold text-rose-900">
                                            å£²ä¸Š: Â¥{productSalesPerMonth.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* å³ã‚«ãƒ©ãƒ : çµæœè¡¨ç¤º */}
                            <div className="space-y-6">
                                <div className="relative bg-gradient-to-br from-brown-900 to-brown-800 rounded-xl p-6 text-white overflow-hidden">
                                    <div className="absolute top-0 right-0 w-48 h-48 bg-gold-500 opacity-10 rounded-full blur-3xl -mr-12 -mt-12"></div>
                                    <div className="relative z-10">
                                        <h3 className="text-gold-200 font-medium mb-1 text-sm">äºˆæ¸¬æœˆé–“å£²ä¸Š</h3>
                                        <div className="text-4xl font-bold mb-4">Â¥{projectedSales.toLocaleString()}</div>

                                        <div className="w-full bg-white/20 rounded-full h-2 mb-4">
                                            <div
                                                className={`h-full rounded-full transition-all duration-500 ${diff >= 0 ? 'bg-gold-400' : 'bg-white/50'}`}
                                                style={{width: `${progress}%`}}
                                            ></div>
                                        </div>

                                        {diff < 0 ? (
                                            <div className="bg-white/10 backdrop-blur rounded p-3 border border-white/10">
                                                <p className="text-sm font-bold text-rose-300 mb-1 flex items-center"><Icon name="alert-triangle" size={14} className="mr-2"/> ç›®æ¨™æœªé”æˆ</p>
                                                <p className="text-xs text-gray-300">ä¸è¶³é¡: Â¥{Math.abs(diff).toLocaleString()}</p>
                                            </div>
                                        ) : (
                                            <div className="bg-white/10 backdrop-blur rounded p-3 border border-white/10">
                                                <p className="text-sm font-bold text-emerald-300 mb-1 flex items-center"><Icon name="check" size={14} className="mr-2"/> ç›®æ¨™é”æˆ</p>
                                                <p className="text-xs text-gray-300">ä½™å‰°: +Â¥{diff.toLocaleString()}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white border border-gold-200 rounded-xl p-5">
                                    <h4 className="font-bold text-brown-800 mb-4 text-sm">å£²ä¸Šå†…è¨³</h4>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">æ–°è¦é¡§å®¢å£²ä¸Š</span>
                                            <span className="font-bold text-blue-700">Â¥{newCustomerSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">ãƒªãƒ”ãƒ¼ãƒˆå£²ä¸Š</span>
                                            <span className="font-bold text-emerald-700">Â¥{repeatCustomerSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">å›æ•°åˆ¸å£²ä¸Š</span>
                                            <span className="font-bold text-purple-700">Â¥{ticketSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">ã‚ªãƒ—ã‚·ãƒ§ãƒ³å£²ä¸Š</span>
                                            <span className="font-bold text-amber-700">Â¥{optionSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">ç‰©è²©å£²ä¸Š</span>
                                            <span className="font-bold text-rose-700">Â¥{productSalesPerMonth.toLocaleString()}</span>
                                        </div>
                                        <div className="pt-3 mt-3 border-t border-gray-200 flex justify-between items-center">
                                            <span className="font-bold text-brown-800">åˆè¨ˆ</span>
                                            <span className="font-bold text-xl text-gold-600">Â¥{projectedSales.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gold-50 border border-gold-200 rounded-lg p-4">
                                    <h4 className="font-bold text-brown-800 mb-3 text-sm">ã‚µãƒãƒªãƒ¼</h4>
                                    <div className="space-y-1 text-xs text-gray-700">
                                        <p>â€¢ ç·æ¥å®¢äºˆæ¸¬: {totalCustomers}äºº</p>
                                        <p>â€¢ å®¢å˜ä¾¡å¹³å‡: Â¥{Math.round(projectedSales / totalCustomers).toLocaleString()}</p>
                                        <p>â€¢ å›æ•°åˆ¸è³¼å…¥äºˆæ¸¬: {ticketPurchaseCount}ä»¶</p>
                                        <p>â€¢ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ äºˆæ¸¬: {optionCount}ä»¶</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };


        // --- Master Data Management View ---
        const MasterDataManagementView = ({ onSelectMaster }) => {
            const masterOptions = [
                {
                    id: 'staff',
                    icon: 'users',
                    title: 'ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†',
                    description: 'ã‚¹ã‚¿ãƒƒãƒ•ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤',
                    bgColor: 'bg-blue-50',
                    borderColor: 'border-blue-200',
                    hoverBorder: 'hover:border-blue-400',
                    iconBg: 'bg-blue-100',
                    iconBgHover: 'group-hover:bg-blue-200',
                    iconColor: 'text-blue-600',
                    chevronColor: 'text-blue-400',
                    chevronHover: 'group-hover:text-blue-600'
                },
                {
                    id: 'menus',
                    icon: 'package',
                    title: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†',
                    description: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤',
                    bgColor: 'bg-purple-50',
                    borderColor: 'border-purple-200',
                    hoverBorder: 'hover:border-purple-400',
                    iconBg: 'bg-purple-100',
                    iconBgHover: 'group-hover:bg-purple-200',
                    iconColor: 'text-purple-600',
                    chevronColor: 'text-purple-400',
                    chevronHover: 'group-hover:text-purple-600'
                },
                {
                    id: 'customers',
                    icon: 'heart',
                    title: 'é¡§å®¢ãƒ»å›æ•°åˆ¸ç®¡ç†',
                    description: 'é¡§å®¢æƒ…å ±ã¨å›æ•°åˆ¸ã®ç®¡ç†',
                    bgColor: 'bg-rose-50',
                    borderColor: 'border-rose-200',
                    hoverBorder: 'hover:border-rose-400',
                    iconBg: 'bg-rose-100',
                    iconBgHover: 'group-hover:bg-rose-200',
                    iconColor: 'text-rose-600',
                    chevronColor: 'text-rose-400',
                    chevronHover: 'group-hover:text-rose-600'
                },
                {
                    id: 'media',
                    icon: 'megaphone',
                    title: 'åª’ä½“ãƒã‚¹ã‚¿ãƒ¼',
                    description: 'é›†å®¢åª’ä½“ã®è¿½åŠ ãƒ»ç·¨é›†',
                    bgColor: 'bg-amber-50',
                    borderColor: 'border-amber-200',
                    hoverBorder: 'hover:border-amber-400',
                    iconBg: 'bg-amber-100',
                    iconBgHover: 'group-hover:bg-amber-200',
                    iconColor: 'text-amber-600',
                    chevronColor: 'text-amber-400',
                    chevronHover: 'group-hover:text-amber-600'
                },
            ];

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="mb-6">
                            <h2 className="text-2xl font-bold text-brown-800 serif mb-2">ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                            <p className="text-sm text-gray-600">åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²ãƒ»ç·¨é›†ã‚’è¡Œã„ã¾ã™</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {masterOptions.map(option => (
                                <button
                                    key={option.id}
                                    onClick={() => onSelectMaster(option.id)}
                                    className={`group p-6 rounded-xl border-2 transition-all duration-200 text-left hover:shadow-lg hover:scale-[1.02] ${option.bgColor} ${option.borderColor} ${option.hoverBorder}`}
                                >
                                    <div className="flex items-start space-x-4">
                                        <div className={`p-3 rounded-lg ${option.iconBg} ${option.iconBgHover} transition-colors`}>
                                            <Icon name={option.icon} size={24} className={option.iconColor} />
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-lg font-bold text-brown-800 mb-1 group-hover:text-brown-900">
                                                {option.title}
                                            </h3>
                                            <p className="text-sm text-gray-600">{option.description}</p>
                                        </div>
                                        <Icon name="chevron-right" size={20} className={`${option.chevronColor} ${option.chevronHover} transition-colors`} />
                                    </div>
                                </button>
                            ))}
                        </div>

                        <div className="mt-8 p-4 bg-gold-50 rounded-lg border border-gold-200">
                            <div className="flex items-start space-x-3">
                                <Icon name="info" size={20} className="text-gold-600 flex-shrink-0 mt-0.5" />
                                <div className="text-sm text-brown-800">
                                    <p className="font-bold mb-2">ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦</p>
                                    <ul className="space-y-1 text-gray-600">
                                        <li>â€¢ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯å®Ÿç¸¾å…¥åŠ›ã‚„åˆ†æã®åŸºç¤ã¨ãªã‚‹é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã§ã™</li>
                                        <li>â€¢ å¤‰æ›´å†…å®¹ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã™ã‚‹ã“ã¨ã§æ°¸ç¶šåŒ–ã•ã‚Œã¾ã™</li>
                                        <li>â€¢ å‰Šé™¤ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };


        // --- App Layout & Navigation ---

        const Layout = () => {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ã‚¿ãƒƒãƒ•IDã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const staffIdFromUrl = urlParams.get('staffId');
            const isStaffMode = staffIdFromUrl !== null;
            const currentStaffId = isStaffMode ? Number(staffIdFromUrl) : null;

            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [mobileOptimized, setMobileOptimized] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [selectedMaster, setSelectedMaster] = useState(null);
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('darkMode');
                return saved ? JSON.parse(saved) : false;
            });
            const [staffList, setStaffList] = useState(initialStaffData);
            const [menuList, setMenuList] = useState(menus);
            const [ticketMasterList, setTicketMasterList] = useState(initialTicketMasterData);
            const [customerList, setCustomerList] = useState(initialCustomerData);
            const [mediaSourcesList, setMediaSourcesList] = useState(initialMediaSourcesData);
            const [dailySalesData, setDailySalesData] = useState(initialDailySalesData);
            const [menuSalesData, setMenuSalesData] = useState(initialMenuSalesData);
            const [isSaving, setIsSaving] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            const currentDate = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });

            // ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å–å¾—
            const currentStaff = isStaffMode ? staffList.find(s => s.id === currentStaffId) : null;

            // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿é¸æŠæ™‚ã®å‡¦ç†
            const handleSelectMaster = (masterId) => {
                setSelectedMaster(masterId);
                setActiveTab(masterId); // staff, menus, customers, media
                setMobileMenuOpen(false); // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            };

            // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†é–¢æ•°
            const updateStaff = (id, newData) => {
                setStaffList(prev => prev.map(staff => staff.id === id ? newData : staff));
            };

            const addStaff = (newData) => {
                setStaffList(prev => [...prev, newData]);
            };

            const deleteStaff = (id) => {
                setStaffList(prev => prev.filter(staff => staff.id !== id));
            };

            // å›æ•°åˆ¸ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†é–¢æ•°
            const updateTicketMaster = (id, newData) => {
                setTicketMasterList(prev => prev.map(ticket => ticket.id === id ? newData : ticket));
            };

            const addTicketMaster = (newData) => {
                setTicketMasterList(prev => [...prev, newData]);
            };

            const deleteTicketMaster = (id) => {
                setTicketMasterList(prev => prev.filter(ticket => ticket.id !== id));
            };

            // é¡§å®¢ç®¡ç†é–¢æ•°
            const updateCustomer = (id, newData) => {
                setCustomerList(prev => prev.map(customer => customer.id === id ? newData : customer));
            };

            const addCustomer = (newData) => {
                setCustomerList(prev => [...prev, newData]);
            };

            const deleteCustomer = (id) => {
                setCustomerList(prev => prev.filter(customer => customer.id !== id));
            };

            // åª’ä½“ã‚½ãƒ¼ã‚¹ç®¡ç†é–¢æ•°
            const updateMediaSource = (id, newData) => {
                setMediaSourcesList(prev => prev.map(media => media.id === id ? newData : media));
            };

            const addMediaSource = (newData) => {
                setMediaSourcesList(prev => [...prev, newData]);
            };

            const deleteMediaSource = (id) => {
                setMediaSourcesList(prev => prev.filter(media => media.id !== id));
            };

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†é–¢æ•°
            const updateMenu = (id, newData) => {
                setMenuList(prev => prev.map(menu => menu.id === id ? newData : menu));
            };

            const addMenu = (newData) => {
                setMenuList(prev => [...prev, newData]);
            };

            const deleteMenu = (id) => {
                setMenuList(prev => prev.filter(menu => menu.id !== id));
            };

            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
            const handleExportToCSV = (data, filename) => {
                if (!data || data.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—
                const headers = Object.keys(data[0]);

                // CSVã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
                let csv = '\uFEFF'; // UTF-8 BOMï¼ˆExcelã§æ–‡å­—åŒ–ã‘é˜²æ­¢ï¼‰
                csv += headers.join(',') + '\n';

                data.forEach(row => {
                    const values = headers.map(header => {
                        let value = row[header];

                        // é…åˆ—ã®å ´åˆã¯JSONæ–‡å­—åˆ—ã«å¤‰æ›
                        if (Array.isArray(value)) {
                            value = JSON.stringify(value);
                        }

                        // null/undefinedã®å ´åˆã¯ç©ºæ–‡å­—
                        if (value === null || value === undefined) {
                            value = '';
                        }

                        // æ–‡å­—åˆ—ã®å ´åˆã€ã‚«ãƒ³ãƒã‚„æ”¹è¡Œã‚’å«ã‚€å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
                        value = String(value);
                        if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                            value = '"' + value.replace(/"/g, '""') + '"';
                        }

                        return value;
                    });
                    csv += values.join(',') + '\n';
                });

                // Blobã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const handleSaveToSpreadsheet = async () => {
                setIsSaving(true);
                setSaveMessage('');

                try {
                    await saveToSpreadsheet('saveAllData', {
                        staffData: staffList,
                        ticketData: ticketMasterList,
                        customerData: customerList,
                        menuData: menuList,
                        mediaData: mediaSourcesList,
                        dailySalesData: dailySalesData,
                        menuSalesData: menuSalesData
                    });

                    setSaveMessage('âœ“ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸ');
                    setTimeout(() => setSaveMessage(''), 3000);
                } catch (error) {
                    setSaveMessage('âœ— ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }

                setIsSaving(false);
            };

            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            const handleLoadFromSpreadsheet = async () => {
                setIsLoading(true);
                setSaveMessage('');

                // GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL_HERE') {
                    setSaveMessage('âœ— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚index.htmlã®GAS_WEB_APP_URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    setIsLoading(false);
                    return;
                }

                try {
                    const response = await fetch(GAS_WEB_APP_URL + '?action=getAllData', {
                        method: 'GET'
                    });

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
                    if (!response.ok) {
                        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                        if (result.data.staff) {
                            setStaffList(result.data.staff);
                        }
                        if (result.data.ticketMasters) {
                            setTicketMasterList(result.data.ticketMasters);
                        }
                        if (result.data.customers) {
                            setCustomerList(result.data.customers);
                        }
                        if (result.data.menus) {
                            setMenuList(result.data.menus);
                        }
                        if (result.data.mediaSources) {
                            setMediaSourcesList(result.data.mediaSources);
                        }

                        setSaveMessage('âœ“ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                        setTimeout(() => setSaveMessage(''), 3000);
                    } else {
                        const errorMsg = result.error || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        setSaveMessage('âœ— ' + errorMsg);
                        console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', result);
                    }
                } catch (error) {
                    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                    let errorMessage = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ';

                    if (error.message.includes('Failed to fetch')) {
                        errorMessage += 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (error.message.includes('JSON')) {
                        errorMessage += 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚¨ãƒ©ãƒ¼ã€‚GASã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        errorMessage += error.message;
                    }

                    setSaveMessage('âœ— ' + errorMessage);
                }

                setIsLoading(false);
            };

            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            const toggleDarkMode = () => {
                setDarkMode(prev => {
                    const newMode = !prev;
                    localStorage.setItem('darkMode', JSON.stringify(newMode));
                    return newMode;
                });
            };

            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰é©ç”¨
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—ï¼ˆå…¨ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
            useEffect(() => {
                // GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                if (GAS_WEB_APP_URL && GAS_WEB_APP_URL !== 'YOUR_GAS_WEB_APP_URL_HERE') {
                    handleLoadFromSpreadsheet();
                }
            }, []); // åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚ã®ã¿å®Ÿè¡Œ

            const NavItem = ({ id, icon, label }) => (
                <button
                    onClick={() => {
                        setActiveTab(id);
                        setSelectedMaster(null);
                        if (mobileOptimized) setMobileMenuOpen(false);
                    }}
                    className={`w-full flex items-center space-x-3 px-4 my-1 rounded-lg transition-all duration-200 border-l-4 ${
                        activeTab === id
                        ? 'border-gold-500 bg-gold-50 text-brown-800 font-bold shadow-sm'
                        : 'border-transparent text-gray-500 hover:text-brown-800 hover:bg-white'
                    } ${mobileOptimized ? 'py-4 text-base touch-feedback' : 'py-3'}`}
                >
                    <Icon name={icon} size={mobileOptimized ? 24 : 20} className={activeTab === id ? 'text-gold-600' : 'text-gray-400'} />
                    {(sidebarOpen || mobileOptimized) && <span className={activeTab === id ? 'serif font-semibold' : ''}>{label}</span>}
                </button>
            );

            return (
                <div className="flex h-screen bg-brown-50 font-sans text-brown-900 overflow-hidden">
                    {/* Mobile Overlay */}
                    {mobileOptimized && mobileMenuOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-30 lg:hidden"
                            onClick={() => setMobileMenuOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <div className={`
                        ${mobileOptimized ? (
                            mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
                        ) : (
                            sidebarOpen ? 'w-64' : 'w-20'
                        )}
                        ${mobileOptimized ? 'fixed inset-y-0 left-0 w-64 z-40' : 'relative'}
                        bg-white border-r border-gold-200 flex flex-col transition-all duration-300 shadow-xl
                    `}>
                        <div className="h-20 flex items-center justify-center border-b border-gold-100 bg-white">
                            {sidebarOpen ? (
                                <h1 className="text-2xl font-bold text-brown-800 flex items-center serif tracking-wider">
                                    <span className="text-gold-500 mr-2 text-3xl">âœ¦</span> LuxeMetrics
                                </h1>
                            ) : (
                                <span className="text-gold-500 text-3xl">âœ¦</span>
                            )}
                        </div>

                        <div className="flex-1 py-6 px-2 space-y-1">
                            {isStaffMode ? (
                                <>
                                    <NavItem id="dashboard" icon="layout-dashboard" label="ãƒã‚¤ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" />
                                    <NavItem id="input" icon="edit" label="å®Ÿç¸¾å…¥åŠ›" />
                                    <NavItem id="calendar" icon="calendar" label="ãƒã‚¤ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼" />
                                </>
                            ) : (
                                <>
                                    <NavItem id="dashboard" icon="layout-dashboard" label="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" />
                                    <NavItem id="input" icon="edit" label="å®Ÿç¸¾å…¥åŠ›" />
                                    <NavItem id="simulation" icon="target" label="ç›®æ¨™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³" />
                                    <NavItem id="calendar" icon="calendar" label="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼" />
                                    <NavItem id="sales" icon="bar-chart-2" label="å£²ä¸Šãƒ»åª’ä½“åˆ†æ" />
                                    <NavItem id="menus" icon="package" label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥åˆ†æ" />
                                    <NavItem id="staff" icon="users" label="ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†" />
                                    <NavItem id="customers" icon="heart" label="é¡§å®¢ãƒ»å›æ•°åˆ¸ç®¡ç†" />
                                </>
                            )}
                        </div>

                        <div className={`border-t border-gold-100 bg-gold-50/50 ${mobileOptimized ? 'p-3' : 'p-4'}`}>
                             <button
                                onClick={() => {
                                    setActiveTab('master');
                                    setSelectedMaster(null);
                                    if (mobileOptimized) setMobileMenuOpen(false);
                                }}
                                className={`w-full flex items-center space-x-3 px-4 rounded-lg transition-colors ${
                                    activeTab === 'master' ? 'bg-gold-200 text-brown-800 font-bold' : 'text-gray-500 hover:bg-white hover:text-brown-800'
                                } ${mobileOptimized ? 'py-4 text-base font-semibold touch-feedback' : 'py-3'} ${(!sidebarOpen && !mobileOptimized) && 'justify-center'}`}
                            >
                                <Icon name="database" size={mobileOptimized ? 24 : 20} />
                                {(sidebarOpen || mobileOptimized) && <span>ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿</span>}
                            </button>
                            {!mobileOptimized && (
                                <button
                                    onClick={() => setSidebarOpen(!sidebarOpen)}
                                    className="mt-2 w-full flex items-center justify-center p-2 text-gold-400 hover:text-gold-600"
                                >
                                    <Icon name={sidebarOpen ? "chevrons-left" : "chevrons-right"} size={20} />
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col overflow-hidden relative bg-[#f9f8f4]">
                        {/* Topbar */}
                        <header className={`bg-white/95 backdrop-blur-md border-b border-gold-100 flex justify-between items-center shadow-sm z-10 sticky top-0 safe-top hw-accelerate ${
                            mobileOptimized ? 'mobile-header' : 'h-20 px-8'
                        }`}>
                            <div className="flex items-center space-x-3">
                                {mobileOptimized && (
                                    <button
                                        onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                                        className="p-2.5 rounded-lg hover:bg-gold-50 transition-colors touch-feedback"
                                        aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã"
                                    >
                                        <Icon name="menu" size={24} className="text-brown-800" />
                                    </button>
                                )}
                                <div>
                                    <h2 className={`font-bold text-brown-800 serif ${mobileOptimized ? 'text-sm' : 'text-xl'}`}>
                                        {activeTab === 'dashboard' && (isStaffMode ? (mobileOptimized ? 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰' : 'My Dashboard') : (mobileOptimized ? 'çµŒå–¶ã‚µãƒãƒªãƒ¼' : 'Executive Summary'))}
                                        {activeTab === 'input' && (mobileOptimized ? 'å®Ÿç¸¾å…¥åŠ›' : 'Performance Input')}
                                        {activeTab === 'simulation' && (mobileOptimized ? 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³' : 'Strategy Simulation')}
                                        {activeTab === 'sales' && (mobileOptimized ? 'å£²ä¸Šåˆ†æ' : 'Sales & Marketing Analytics')}
                                        {activeTab === 'menus' && (mobileOptimized ? 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ†æ' : 'Menu Performance Analysis')}
                                        {activeTab === 'staff' && (mobileOptimized ? 'ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†' : 'Staff Performance & Management')}
                                        {activeTab === 'customers' && (mobileOptimized ? 'é¡§å®¢ç®¡ç†' : 'Customer & Ticket Management')}
                                        {activeTab === 'master' && (mobileOptimized ? 'ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†' : 'Master Data Management')}
                                    </h2>
                                    {!mobileOptimized && (
                                        <p className="text-xs text-gold-600 font-medium tracking-widest uppercase mt-1">
                                            {activeTab === 'dashboard' && (isStaffMode ? 'ãƒã‚¤ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰' : 'çµŒå–¶ã‚µãƒãƒªãƒ¼')}
                                            {activeTab === 'input' && 'å®Ÿç¸¾å…¥åŠ›'}
                                            {activeTab === 'simulation' && 'çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'}
                                            {activeTab === 'sales' && 'å£²ä¸Šè©³ç´°ãƒ»åª’ä½“åˆ†æ'}
                                            {activeTab === 'menus' && 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥åˆ†æ'}
                                            {activeTab === 'staff' && 'ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ»ç·¨é›†'}
                                            {activeTab === 'customers' && 'é¡§å®¢ãƒªã‚¹ãƒˆãƒ»å›æ•°åˆ¸ç®¡ç†'}
                                            {activeTab === 'master' && 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†'}
                                        </p>
                                    )}
                                </div>
                            </div>
                            <div className={`flex items-center ${mobileOptimized ? 'space-x-2' : 'space-x-6'}`}>
                                {/* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ */}
                                <div className="flex flex-col items-end">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={handleLoadFromSpreadsheet}
                                            disabled={isLoading}
                                            className={`flex items-center bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg shadow-sm transition-colors touch-feedback ${
                                                mobileOptimized ? 'px-2.5 py-2.5' : 'px-4 py-2 text-sm'
                                            }`}
                                            aria-label="ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€"
                                        >
                                            <Icon name={isLoading ? "loader" : "download"} size={mobileOptimized ? 16 : 16} className={`${isLoading ? 'animate-spin' : ''} ${mobileOptimized ? '' : 'mr-2'}`} />
                                            {!mobileOptimized && (isLoading ? 'èª­è¾¼ä¸­...' : 'èª­ã¿è¾¼ã¿')}
                                        </button>
                                        <button
                                            onClick={handleSaveToSpreadsheet}
                                            disabled={isSaving}
                                            className={`flex items-center bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-400 text-white font-medium rounded-lg shadow-sm transition-colors touch-feedback ${
                                                mobileOptimized ? 'px-2.5 py-2.5' : 'px-4 py-2 text-sm'
                                            }`}
                                            aria-label="ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹"
                                        >
                                            <Icon name={isSaving ? "loader" : "save"} size={mobileOptimized ? 16 : 16} className={`${isSaving ? 'animate-spin' : ''} ${mobileOptimized ? '' : 'mr-2'}`} />
                                            {!mobileOptimized && (isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜')}
                                        </button>
                                    </div>
                                    {saveMessage && (
                                        <span className={`text-xs mt-1 ${saveMessage.includes('âœ“') ? 'text-emerald-600' : 'text-rose-600'}`}>
                                            {saveMessage}
                                        </span>
                                    )}
                                </div>
                                {!mobileOptimized && <div className="h-8 w-px bg-gold-200"></div>}
                                {/* Dark Mode Toggle */}
                                <button
                                    onClick={toggleDarkMode}
                                    className={`flex items-center rounded-lg font-semibold transition-all touch-feedback ${
                                        mobileOptimized
                                            ? 'bg-gray-700 text-yellow-300 shadow-md px-2.5 py-2.5'
                                            : 'bg-white text-gray-600 border border-gray-300 hover:bg-gray-50 px-3 py-2 text-sm'
                                    }`}
                                    title={darkMode ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿'}
                                    aria-label={darkMode ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿'}
                                >
                                    <Icon name={darkMode ? "sun" : "moon"} size={mobileOptimized ? 20 : 16} className={mobileOptimized ? '' : 'mr-2'} />
                                    {!mobileOptimized && <span className="hidden lg:inline">{darkMode ? 'Light' : 'Dark'}</span>}
                                </button>
                                {!mobileOptimized && <div className="h-8 w-px bg-gold-200"></div>}
                                {/* Mobile/PC Toggle */}
                                <button
                                    onClick={() => setMobileOptimized(!mobileOptimized)}
                                    className={`flex items-center rounded-lg font-semibold transition-all touch-feedback ${
                                        mobileOptimized
                                            ? 'bg-purple-600 text-white shadow-md px-2.5 py-2.5'
                                            : 'bg-white text-gray-600 border border-gray-300 hover:bg-purple-50 px-3 py-2 text-sm'
                                    }`}
                                    title={mobileOptimized ? 'PCè¡¨ç¤ºã«åˆ‡æ›¿' : 'ã‚¹ãƒãƒ›è¡¨ç¤ºã«åˆ‡æ›¿'}
                                    aria-label={mobileOptimized ? 'PCè¡¨ç¤ºã«åˆ‡æ›¿' : 'ã‚¹ãƒãƒ›è¡¨ç¤ºã«åˆ‡æ›¿'}
                                >
                                    <Icon name={mobileOptimized ? "smartphone" : "monitor"} size={mobileOptimized ? 20 : 16} className={mobileOptimized ? '' : 'mr-2'} />
                                    {!mobileOptimized && <span className="hidden lg:inline">{mobileOptimized ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'PC'}</span>}
                                </button>
                                {!mobileOptimized && (
                                    <>
                                        <div className="h-8 w-px bg-gold-200"></div>
                                        <div className="text-right hidden md:block">
                                            <p className="text-sm font-bold text-brown-800">{currentDate}</p>
                                            <p className="text-xs text-gray-400">Tokyo, Japan</p>
                                        </div>
                                        <div className="h-8 w-px bg-gold-200"></div>
                                        <div className="flex items-center space-x-3">
                                            <div className="w-10 h-10 rounded-full bg-brown-800 border-2 border-gold-300 flex items-center justify-center text-gold-100 text-sm font-serif">
                                                {isStaffMode && currentStaff ? currentStaff.name.charAt(0) : 'OP'}
                                            </div>
                                            <div className="hidden md:block">
                                                <p className="text-sm font-bold text-brown-800">
                                                    {isStaffMode && currentStaff ? currentStaff.name : 'ã‚ªãƒ¼ãƒŠãƒ¼æ§˜'}
                                                </p>
                                                <p className="text-xs text-gold-600">
                                                    {isStaffMode && currentStaff ? currentStaff.role : 'Administrator'}
                                                </p>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        </header>

                        {/* Content Area */}
                        <main className={`flex-1 overflow-y-auto transition-all safe-bottom ${mobileOptimized ? 'p-3 pt-4' : 'p-8'}`}>
                            <div className={`mx-auto ${mobileOptimized ? 'max-w-full pb-6' : 'max-w-7xl pb-10'}`}>
                                {activeTab === 'dashboard' && (
                                    isStaffMode && currentStaff ? (
                                        // ã‚¹ã‚¿ãƒƒãƒ•ãƒ¢ãƒ¼ãƒ‰: è‡ªåˆ†ã®æˆç¸¾ã¨åº—èˆ—ç›®æ¨™ã®ã¿è¡¨ç¤º
                                        <div className="space-y-6">
                                            <Card>
                                                <h2 className="text-2xl font-bold text-brown-800 mb-6 serif">ã‚ãªãŸã®å®Ÿç¸¾</h2>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">ä»Šæœˆã®å£²ä¸Šå®Ÿç¸¾</p>
                                                        <p className="text-3xl font-bold text-gold-600">Â¥{currentStaff.sales.toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">å£²ä¸Šç›®æ¨™</p>
                                                        <p className="text-3xl font-bold text-brown-800">Â¥{currentStaff.target.toLocaleString()}</p>
                                                    </div>
                                                </div>
                                                <div className="mt-4">
                                                    <p className="text-sm text-gray-500 mb-2">é”æˆç‡</p>
                                                    <div className="w-full bg-gray-200 rounded-full h-4">
                                                        <div className={`h-4 rounded-full ${currentStaff.sales >= currentStaff.target ? 'bg-emerald-500' : 'bg-gold-500'}`}
                                                            style={{width: `${currentStaff.target > 0 ? Math.min(100, (currentStaff.sales / currentStaff.target) * 100) : 0}%`}}></div>
                                                    </div>
                                                    <p className="text-right text-sm font-bold text-gray-700 mt-1">
                                                        {currentStaff.target > 0 ? Math.round((currentStaff.sales / currentStaff.target) * 100) : 0}%
                                                    </p>
                                                </div>
                                                <div className="grid grid-cols-3 gap-4 mt-6 pt-6 border-t border-gray-200">
                                                    <div className="text-center">
                                                        <p className="text-sm text-gray-500">æŒ‡åæ•°</p>
                                                        <p className="text-2xl font-bold text-brown-800">{currentStaff.nomination}</p>
                                                    </div>
                                                    <div className="text-center border-l border-gray-200">
                                                        <p className="text-sm text-gray-500">ãƒªãƒ”ãƒ¼ãƒˆç‡</p>
                                                        <p className="text-2xl font-bold text-emerald-600">{currentStaff.retention}%</p>
                                                    </div>
                                                    <div className="text-center border-l border-gray-200">
                                                        <p className="text-sm text-gray-500">å£ã‚³ãƒŸè©•ä¾¡</p>
                                                        <p className="text-2xl font-bold text-gold-600">{currentStaff.reviewScore || 0}</p>
                                                    </div>
                                                </div>
                                            </Card>

                                            <Card>
                                                <h2 className="text-xl font-bold text-brown-800 mb-4 serif">åº—èˆ—å…¨ä½“ã®ç›®æ¨™</h2>
                                                <div className="space-y-4">
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">ä»Šæœˆã®åº—èˆ—ç›®æ¨™</p>
                                                        <p className="text-2xl font-bold text-brown-800">
                                                            Â¥{staffList.filter(s => s.storeId === currentStaff.storeId).reduce((sum, s) => sum + s.target, 0).toLocaleString()}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">ç¾åœ¨ã®å®Ÿç¸¾</p>
                                                        <p className="text-2xl font-bold text-gold-600">
                                                            Â¥{staffList.filter(s => s.storeId === currentStaff.storeId).reduce((sum, s) => sum + s.sales, 0).toLocaleString()}
                                                        </p>
                                                    </div>
                                                </div>
                                            </Card>

                                            <div className="bg-gold-50 border border-gold-200 rounded-lg p-6">
                                                <h3 className="font-bold text-brown-800 mb-2">ğŸ’¡ ã‚¹ã‚¿ãƒƒãƒ•URLã«ã¤ã„ã¦</h3>
                                                <p className="text-sm text-gray-700">
                                                    ã“ã®ãƒšãƒ¼ã‚¸ã¯ã‚ãªãŸå°‚ç”¨ã®URLã§ã™ã€‚ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã®è©³ç´°æƒ…å ±ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚<br/>
                                                    ã€Œå®Ÿç¸¾å…¥åŠ›ã€ã‹ã‚‰æ—¥ã€…ã®å£²ä¸Šã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ï¼
                                                </p>
                                            </div>
                                        </div>
                                    ) : (
                                        <DashboardView
                                            staffList={staffList}
                                            dailySalesData={dailySalesData}
                                            menuSalesData={menuSalesData}
                                            mediaSourcesData={mediaSourcesList}
                                            customerList={customerList}
                                            onNavigate={setActiveTab}
                                            mobileOptimized={mobileOptimized}
                                            storeData={[
                                                { id: 1, name: 'æ–°å®¿åº—' },
                                                { id: 2, name: 'æ–°å®¿å—å£åº—' }
                                            ]}
                                        />
                                    )
                                )}
                                {activeTab === 'input' && <PerformanceInputView
                                    dailySalesData={dailySalesData}
                                    setDailySalesData={setDailySalesData}
                                    menuSalesData={menuSalesData}
                                    setMenuSalesData={setMenuSalesData}
                                    staffList={staffList}
                                />}
                                {!isStaffMode && activeTab === 'staff' && <StaffManagementView staffList={staffList} onUpdateStaff={updateStaff} onAddStaff={addStaff} onDeleteStaff={deleteStaff} exportToCSV={handleExportToCSV} />}
                                {!isStaffMode && activeTab === 'simulation' && <SimulationView staffList={staffList} onUpdateStaff={updateStaff} />}
                                {!isStaffMode && activeTab === 'master' && !selectedMaster && (
                                    <MasterDataManagementView onSelectMaster={handleSelectMaster} />
                                )}
                                {!isStaffMode && activeTab === 'sales' && (
                                    <SalesAnalysisView
                                        dailySalesData={dailySalesData}
                                        mediaSourcesData={mediaSourcesList}
                                        onUpdateMediaSource={updateMediaSource}
                                    />
                                )}
                                {!isStaffMode && activeTab === 'menus' && selectedMaster === 'menus' && (
                                    <MenuManagementView
                                        menuList={menuList}
                                        onUpdateMenu={updateMenu}
                                        onAddMenu={addMenu}
                                        onDeleteMenu={deleteMenu}
                                    />
                                )}
                                {activeTab === 'calendar' && <CalendarView dailySalesData={dailySalesData} staffId={isStaffMode ? currentStaffId : null} />}
                                {!isStaffMode && activeTab === 'menus' && !selectedMaster && <MenuAnalysisView menuSalesData={menuSalesData} />}
                                {!isStaffMode && activeTab === 'media' && (
                                    <MediaSourceManagementView
                                        mediaSourcesList={mediaSourcesList}
                                        onUpdateMedia={updateMediaSource}
                                        onAddMedia={addMediaSource}
                                        onDeleteMedia={deleteMediaSource}
                                    />
                                )}
                                {!isStaffMode && activeTab === 'customers' && (
                                    <CustomerTicketManagementView
                                        ticketMasterList={ticketMasterList}
                                        customerList={customerList}
                                        onUpdateTicketMaster={updateTicketMaster}
                                        onAddTicketMaster={addTicketMaster}
                                        onDeleteTicketMaster={deleteTicketMaster}
                                        onUpdateCustomer={updateCustomer}
                                        onAddCustomer={addCustomer}
                                        exportToCSV={handleExportToCSV}
                                        onDeleteCustomer={deleteCustomer}
                                    />
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        // Global error handler for uncaught errors
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Wait for dependencies before rendering
        function initializeApp() {
            console.log('Initializing app...');
            console.log('React available:', typeof React !== 'undefined');
            console.log('ReactDOM available:', typeof ReactDOM !== 'undefined');
            console.log('Recharts available:', typeof window.Recharts !== 'undefined');

            try {
                const rootElement = document.getElementById('root');
                if (!rootElement) {
                    throw new Error('Root element not found');
                }

                console.log('Creating React root...');
                const root = ReactDOM.createRoot(rootElement);

                console.log('Rendering Layout component...');
                root.render(<Layout />);

                console.log('App rendered successfully');
            } catch (error) {
                console.error('ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                console.error('Error stack:', error.stack);

                const rootElement = document.getElementById('root');
                if (rootElement) {
                    rootElement.innerHTML = `
                        <div style="padding: 40px; font-family: sans-serif; background: #fee; border: 2px solid #f00; margin: 20px; border-radius: 8px;">
                            <h1 style="color: red;">ğŸ”´ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼</h1>
                            <p style="color: #c00;"><strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong></p>
                            <pre style="background: #f5f5f5; padding: 20px; overflow: auto; border: 1px solid #ccc; border-radius: 4px;">${error.toString()}</pre>
                            <p style="color: #c00;"><strong>ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:</strong></p>
                            <pre style="background: #f5f5f5; padding: 20px; overflow: auto; border: 1px solid #ccc; border-radius: 4px; max-height: 300px;">${error.stack || 'ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ãªã—'}</pre>
                            <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px;">
                                <p style="color: #856404; margin: 0;"><strong>ğŸ’¡ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:</strong></p>
                                <ul style="color: #856404; margin: 10px 0;">
                                    <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ã‚­ãƒ¼ï¼‰ã‚’é–‹ã„ã¦è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª</li>
                                    <li>ãƒšãƒ¼ã‚¸ã‚’å®Œå…¨ã«ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆCtrl+Shift+R ã¾ãŸã¯ Cmd+Shift+Rï¼‰</li>
                                    <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢</li>
                                    <li>åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦ã™ï¼ˆChromeã€Firefoxã€Safariãªã©ï¼‰</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Timeout to detect if app initialization is stuck
        let appInitialized = false;
        setTimeout(function() {
            if (!appInitialized) {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator && loadingIndicator.parentElement) {
                    console.warn('App initialization timeout - dependencies may not have loaded');
                    loadingIndicator.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="color: #d4af37; margin-bottom: 20px;">â³ èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™</h2>
                            <p style="color: #4a3b32; margin-bottom: 10px;">ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ãŒé€šå¸¸ã‚ˆã‚Šé…ããªã£ã¦ã„ã¾ã™ã€‚</p>
                            <p style="color: #999; font-size: 14px; margin-bottom: 20px;">ä»¥ä¸‹ã‚’ãŠè©¦ã—ãã ã•ã„:</p>
                            <ul style="list-style: none; padding: 0; color: #666; text-align: left; max-width: 400px; margin: 0 auto;">
                                <li style="margin: 10px 0;">âœ“ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª</li>
                                <li style="margin: 10px 0;">âœ“ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆF5ã‚­ãƒ¼ï¼‰</li>
                                <li style="margin: 10px 0;">âœ“ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª</li>
                            </ul>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #d4af37; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                            </button>
                        </div>
                    `;
                }
            }
        }, 10000); // 10 seconds timeout

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeApp();
                appInitialized = true;
            });
        } else {
            initializeApp();
            appInitialized = true;
        }
    </script>
</body>
</html>
