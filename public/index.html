<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>si'se - 整体院経営ダッシュボード</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts Dependencies -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config for Tailwind (si'se Theme - Sage Green) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        sise: {
                            50: '#f1f8f4',
                            100: '#dff0e6',
                            200: '#c1e1cf',
                            300: '#94ccac',
                            400: '#63b185',
                            500: '#3f9968', // Brand Primary - Sage Green
                            600: '#2f7d53',
                            700: '#276444',
                            800: '#225038',
                            900: '#1d422f',
                        },
                        accent: {
                            50: '#fefce8',
                            100: '#fef9c3',
                            400: '#facc15',
                            500: '#eab308', // Warm Gold accent
                            600: '#ca8a04',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', '"Hiragino Sans"', 'sans-serif'],
                        display: ['"Noto Sans JP"', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(16px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'slide-in-right': {
                            '0%': { opacity: '0', transform: 'translateX(-20px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        'scale-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        'count-up': {
                            '0%': { opacity: '0', transform: 'translateY(8px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.5s ease-out forwards',
                        'fade-in': 'fade-in 0.4s ease-out forwards',
                        'slide-in-right': 'slide-in-right 0.4s ease-out forwards',
                        'scale-in': 'scale-in 0.3s ease-out forwards',
                        'count-up': 'count-up 0.6s ease-out forwards',
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background-color: #f6f9f7;
            color: #1e293b;
            font-family: "Noto Sans JP", "Hiragino Sans", sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Dark Mode Styles */
        .dark body {
            background-color: #0c1a12;
            color: #e2e8f0;
        }

        .dark .bg-white {
            background-color: #162420 !important;
        }

        .dark .bg-slate-50 {
            background-color: #0c1a12 !important;
        }

        .dark .text-slate-900 {
            color: #f1f5f9 !important;
        }

        .dark .text-slate-700 {
            color: #cbd5e1 !important;
        }

        .dark .text-slate-600 {
            color: #94a3b8 !important;
        }

        .dark .border-slate-200 {
            border-color: #1e3a2c !important;
        }

        .dark .border-sise-200 {
            border-color: #276444 !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1e1cf;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94ccac;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(63, 153, 104, 0.12);
        }

        /* Gradient backgrounds */
        .bg-mesh {
            background-image:
                radial-gradient(at 20% 20%, rgba(63, 153, 104, 0.06) 0px, transparent 60%),
                radial-gradient(at 80% 60%, rgba(99, 177, 133, 0.05) 0px, transparent 60%),
                radial-gradient(at 40% 80%, rgba(148, 204, 172, 0.04) 0px, transparent 60%);
        }

        /* Card hover effect */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px -12px rgba(63, 153, 104, 0.15);
        }

        /* Smooth number animation */
        .num-animate {
            display: inline-block;
            animation: count-up 0.6s ease-out forwards;
        }

        /* Staggered animation delays */
        .stagger-1 { animation-delay: 0.05s; opacity: 0; }
        .stagger-2 { animation-delay: 0.10s; opacity: 0; }
        .stagger-3 { animation-delay: 0.15s; opacity: 0; }
        .stagger-4 { animation-delay: 0.20s; opacity: 0; }
        .stagger-5 { animation-delay: 0.25s; opacity: 0; }

        /* Status badge pulse */
        .status-active::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        @keyframes count-up {
            0% { opacity: 0; transform: translateY(8px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .skeleton {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Table row hover */
        .table-row-hover {
            transition: background-color 0.15s ease;
        }
        .table-row-hover:hover {
            background-color: rgba(63, 153, 104, 0.04);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            input, select, textarea {
                font-size: 16px !important;
            }
            button, a {
                min-height: 44px;
            }
        }

        /* Safe Area Support */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading-indicator" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #f6f9f7 0%, #e8f3ec 100%);">
            <div style="text-align: center;">
                <div style="width: 48px; height: 48px; border: 3px solid #c1e1cf; border-top: 3px solid #3f9968; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 24px;"></div>
                <p style="color: #1d422f; font-size: 18px; font-family: 'Noto Sans JP', sans-serif; font-weight: 600; letter-spacing: 0.05em;">si'se</p>
                <p style="color: #63b185; font-size: 11px; font-family: 'Noto Sans JP', sans-serif; margin-top: 8px; letter-spacing: 0.1em;">Loading...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const RechartsLib = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, AreaChart, Area, PieChart, Pie, Cell, ComposedChart } = RechartsLib;

        // ========================================
        // 設定・定数
        // ========================================

        // 店舗マスタ（サーバーから動的に取得）
        let serverStores = [];

        // Google Apps Script Web App URL (日報データ取得用)
        // ※実際のデプロイ後URLに置き換えてください
        const GOOGLE_FORM_SHEET_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL';

        // Square API設定（サーバーサイドプロキシ経由）
        // APIキーはVercel環境変数で管理、フロントエンドには露出しない
        const SQUARE_PROXY_BASE = '/api/square';

        // サーバーから設定を取得（店舗一覧含む）
        const fetchSquareConfig = async () => {
            try {
                const res = await fetch(`${SQUARE_PROXY_BASE}/config`);
                if (res.ok) {
                    const config = await res.json();
                    serverStores = config.stores || [];
                    return config;
                }
            } catch (e) {}
            return {
                configured: false,
                stores: [],
                environment: 'sandbox',
                locationId: '',
                defaultMonthlyPrice: 10000
            };
        };

        // ========================================
        // スタッフ・アクセス管理
        // ========================================

        const STAFF_STORAGE_KEY = 'sise_staff_config';

        // URLパラメータからアクセス情報をデコード
        const parseAccessFromUrl = () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('v');
            if (!token) return null;
            try {
                const json = decodeURIComponent(escape(atob(token)));
                const decoded = JSON.parse(json);
                return {
                    name: decoded.n || '不明',
                    role: decoded.r || 'staff',
                    storeIds: decoded.sid || [],
                };
            } catch (e) {
                console.warn('Invalid access token');
                return null;
            }
        };

        // アクセストークン生成（UTF-8対応）
        const generateStaffToken = (staff) => {
            const payload = { n: staff.name, r: staff.role, sid: staff.storeIds };
            return btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        };

        // スタッフ用URL生成
        const generateStaffUrl = (staff) => {
            const token = generateStaffToken(staff);
            const base = window.location.origin + window.location.pathname;
            return `${base}?v=${token}`;
        };

        // localStorage管理
        const loadStaffList = () => {
            try { return JSON.parse(localStorage.getItem(STAFF_STORAGE_KEY)) || []; }
            catch { return []; }
        };
        const saveStaffList = (list) => localStorage.setItem(STAFF_STORAGE_KEY, JSON.stringify(list));

        // 現在のアクセス情報（URLから解析）
        const currentAccess = parseAccessFromUrl();

        // ========================================
        // ヘルパー関数
        // ========================================

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
        };

        const formatNumber = (value) => {
            return new Intl.NumberFormat('ja-JP').format(value);
        };

        const formatPercent = (value) => {
            return `${value.toFixed(1)}%`;
        };

        // ========================================
        // コンポーネント
        // ========================================

        // アイコンコンポーネント
        const Icon = ({ name, size = 20, color = "currentColor", className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
        };

        // カードコンポーネント
        const Card = ({ children, className = "", hover = false }) => (
            <div className={`bg-white/80 backdrop-blur-sm rounded-2xl shadow-sm border border-slate-200/60 p-6 ${hover ? 'card-hover' : ''} ${className}`}>
                {children}
            </div>
        );

        // KPIカードコンポーネント
        const KpiCard = ({ title, value, subValue, trend, icon, color = "bg-sise-500" }) => (
            <Card hover className="group">
                <div className="flex justify-between items-start mb-4">
                    <div className={`rounded-xl ${color} text-white shadow-lg shadow-sise-500/20 p-3 group-hover:scale-105 transition-transform duration-300`}>
                        <Icon name={icon} size={22} />
                    </div>
                    {trend !== null && trend !== undefined && (
                        <span className={`font-medium ${trend >= 0 ? 'text-emerald-600 bg-emerald-50' : 'text-red-500 bg-red-50'} flex items-center px-2.5 py-1 rounded-full text-xs`}>
                            {trend >= 0 ? '+' : ''}{trend}%
                            <Icon name={trend >= 0 ? 'trending-up' : 'trending-down'} size={12} className="ml-1" />
                        </span>
                    )}
                </div>
                <h3 className="text-slate-500 font-medium text-xs tracking-wide uppercase">{title}</h3>
                <div className="flex items-baseline mt-1.5">
                    <span className="text-2xl font-bold text-slate-900 num-animate">{value}</span>
                </div>
                {subValue && <p className="text-xs text-slate-400 mt-1.5">{subValue}</p>}
            </Card>
        );

        // ========================================
        // Square API連携
        // ========================================

        const useSquareData = (activeStoreId, allowedStoreIds) => {
            const [memberData, setMemberData] = useState({
                totalMembers: 0,
                activeMembers: 0,
                newMembersThisMonth: 0,
                churnedMembers: 0,
                churnRate: 0,
                expectedRevenue: 0,
                members: [], // 会員詳細リスト
                monthlyTrend: [], // 月間入退会トレンド
                stores: [], // 利用可能な店舗一覧
                loading: true,
                error: null
            });

            // ページネーション付きAPI呼び出しヘルパー（プロキシ経由、店舗ID付き）
            const fetchAllPages = async (endpoint, bodyBuilder, resultKey, storeId) => {
                let allResults = [];
                let cursor = null;
                do {
                    const body = bodyBuilder(cursor);
                    const headers = { 'Content-Type': 'application/json' };
                    if (storeId && storeId !== 'all') headers['X-Store-Id'] = storeId;
                    const response = await fetch(`${SQUARE_PROXY_BASE}/${endpoint}`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(body)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({}));
                        throw new Error(`API ${endpoint}: ${response.status} - ${JSON.stringify(errorBody.errors || errorBody.error || [])}`);
                    }
                    const data = await response.json();
                    allResults = allResults.concat(data[resultKey] || []);
                    cursor = data.cursor || null;
                } while (cursor);
                return allResults;
            };

            // サブスクリプション操作（解約・一時停止・再開）
            const operateSubscription = async (subscriptionId, action, storeId) => {
                const headers = { 'Content-Type': 'application/json' };
                if (storeId && storeId !== 'all') headers['X-Store-Id'] = storeId;
                const response = await fetch(`${SQUARE_PROXY_BASE}/subscriptions/${subscriptionId}/${action}`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({})
                });
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    const detail = errorBody.errors
                        ? errorBody.errors.map(e => e.detail || e.code).join(', ')
                        : JSON.stringify(errorBody);
                    throw new Error(detail);
                }
                return await response.json();
            };

            const fetchSquareData = useCallback(async () => {
                // サーバーの設定を確認
                const serverConfig = await fetchSquareConfig();

                // デモモード: サーバーにAPIが設定されていない場合はサンプルデータ
                if (!serverConfig.configured) {
                    const sampleMembers = generateSampleMembers();
                    const sampleMonthlyTrend = generateMonthlyTrend();

                    setMemberData({
                        totalMembers: 156,
                        activeMembers: 142,
                        newMembersThisMonth: 12,
                        churnedMembers: 5,
                        churnRate: 3.2,
                        expectedRevenue: 1420000,
                        members: sampleMembers,
                        monthlyTrend: sampleMonthlyTrend,
                        stores: [],
                        loading: false,
                        error: null
                    });
                    return;
                }

                const stores = serverConfig.stores || [];
                const defaultMonthlyPrice = serverConfig.defaultMonthlyPrice;

                // 取得対象の店舗を決定（アクセス制限適用）
                let availStores = stores;
                if (allowedStoreIds && allowedStoreIds.length > 0) {
                    availStores = stores.filter(s => allowedStoreIds.includes(s.id));
                }
                const targetStores = (activeStoreId && activeStoreId !== 'all')
                    ? availStores.filter(s => s.id === activeStoreId)
                    : availStores;

                if (targetStores.length === 0) {
                    setMemberData(prev => ({ ...prev, stores, loading: false, error: '対象店舗が見つかりません' }));
                    return;
                }

                try {
                    let allCustomers = [];
                    let allSubscriptions = [];
                    let allInvoices = [];
                    let catalogMap = {};

                    // 各店舗のデータを取得
                    for (const store of targetStores) {
                        const storeId = store.id;
                        const locationId = store.locationId;

                        // 1. Customers API
                        const customers = await fetchAllPages(
                            'customers/search',
                            (cursor) => ({ limit: 100, ...(cursor ? { cursor } : {}) }),
                            'customers',
                            storeId
                        );
                        // 店舗情報をタグ付け
                        customers.forEach(c => { c._storeId = storeId; c._storeName = store.name; });
                        allCustomers = allCustomers.concat(customers);

                        // 2. Subscriptions API
                        const subscriptions = await fetchAllPages(
                            'subscriptions/search',
                            (cursor) => ({
                                query: { filter: { location_ids: [locationId] } },
                                ...(cursor ? { cursor } : {})
                            }),
                            'subscriptions',
                            storeId
                        );
                        subscriptions.forEach(s => { s._storeId = storeId; s._storeName = store.name; });
                        allSubscriptions = allSubscriptions.concat(subscriptions);

                        // 3. Catalog API
                        const planIds = [...new Set(subscriptions
                            .filter(s => s.plan_variation_id)
                            .map(s => s.plan_variation_id))];

                        if (planIds.length > 0) {
                            try {
                                const headers = { 'Content-Type': 'application/json' };
                                if (storeId) headers['X-Store-Id'] = storeId;
                                const catalogResponse = await fetch(`${SQUARE_PROXY_BASE}/catalog/batch-retrieve`, {
                                    method: 'POST',
                                    headers,
                                    body: JSON.stringify({ object_ids: planIds })
                                });
                                if (catalogResponse.ok) {
                                    const catalogData = await catalogResponse.json();
                                    (catalogData.objects || []).forEach(obj => {
                                        const subPlan = obj.subscription_plan_variation_data || obj.subscription_plan_data;
                                        catalogMap[obj.id] = {
                                            name: subPlan?.name || obj.id,
                                            phases: subPlan?.phases || []
                                        };
                                    });
                                }
                            } catch (e) {
                                console.warn('Catalog API fetch failed:', e);
                            }
                        }

                        // 4. Invoices API
                        const invoices = await fetchAllPages(
                            'invoices/search',
                            (cursor) => ({
                                query: { filter: { location_ids: [locationId] } },
                                limit: 200,
                                ...(cursor ? { cursor } : {})
                            }),
                            'invoices',
                            storeId
                        );
                        invoices.forEach(inv => { inv._storeId = storeId; inv._storeName = store.name; });
                        allInvoices = allInvoices.concat(invoices);
                    }

                    const customers = allCustomers;
                    const subscriptions = allSubscriptions;
                    const invoices = allInvoices;

                    // 5. 会員詳細データの構築
                    const membersList = subscriptions.map(sub => {
                        const customer = customers.find(c => c.id === sub.customer_id);
                        const memberInvoices = invoices.filter(inv =>
                            inv.primary_recipient?.customer_id === sub.customer_id
                        );

                        // プラン金額をphasesから取得
                        let monthlyPrice = defaultMonthlyPrice;
                        let planName = 'スタンダードプラン';
                        let cadence = 'MONTHLY';

                        // Catalog APIからプラン情報取得
                        if (sub.plan_variation_id && catalogMap[sub.plan_variation_id]) {
                            const plan = catalogMap[sub.plan_variation_id];
                            planName = plan.name;
                            if (plan.phases && plan.phases.length > 0) {
                                const phase = plan.phases[0];
                                cadence = phase.cadence || 'MONTHLY';
                                if (phase.pricing && phase.pricing.price_money) {
                                    monthlyPrice = phase.pricing.price_money.amount || monthlyPrice;
                                } else if (phase.recurring_price_money) {
                                    monthlyPrice = phase.recurring_price_money.amount || monthlyPrice;
                                }
                            }
                        }

                        // Subscription phasesから直接取得（フォールバック）
                        if (sub.phases && sub.phases.length > 0) {
                            const activePhase = sub.phases.find(p => !p.uid || p) || sub.phases[0];
                            if (activePhase.pricing && activePhase.pricing.price_money) {
                                monthlyPrice = activePhase.pricing.price_money.amount || monthlyPrice;
                            } else if (activePhase.recurring_price_money) {
                                monthlyPrice = activePhase.recurring_price_money.amount || monthlyPrice;
                            }
                            if (activePhase.cadence) {
                                cadence = activePhase.cadence;
                            }
                        }

                        // Invoice金額の正しい取得
                        const paymentHistory = memberInvoices
                            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                            .slice(0, 10)
                            .map(inv => {
                                let amount = 0;
                                if (inv.payment_requests && inv.payment_requests.length > 0) {
                                    const req = inv.payment_requests[0];
                                    amount = req.computed_amount_money?.amount
                                        || req.fixed_amount_requested_money?.amount
                                        || 0;
                                }
                                return {
                                    id: inv.id,
                                    date: inv.created_at,
                                    amount: amount,
                                    status: inv.status, // DRAFT, UNPAID, PAID, CANCELED等
                                    invoiceNumber: inv.invoice_number || '-'
                                };
                            });

                        return {
                            id: sub.id,
                            customerId: sub.customer_id,
                            name: customer ? `${customer.family_name || ''}${customer.given_name || ''}`.trim() || '未登録' : '未登録',
                            email: customer?.email_address || '-',
                            phone: customer?.phone_number || '-',
                            status: sub.status,
                            startDate: sub.start_date,
                            canceledDate: sub.canceled_date || null,
                            createdAt: sub.created_at,
                            planName: planName,
                            planVariationId: sub.plan_variation_id,
                            monthlyPrice: monthlyPrice,
                            cadence: cadence,
                            paymentHistory: paymentHistory,
                            storeId: sub._storeId || 'default',
                            storeName: sub._storeName || '',
                        };
                    });

                    // 6. 集計
                    const activeSubscriptions = subscriptions.filter(s => s.status === 'ACTIVE');
                    const now = new Date();
                    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const thisMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                    const canceledThisMonth = subscriptions.filter(s => {
                        if (s.status !== 'CANCELED' || !s.canceled_date) return false;
                        const cancelDate = new Date(s.canceled_date);
                        return cancelDate >= thisMonthStart && cancelDate <= thisMonthEnd;
                    });

                    const newThisMonth = subscriptions.filter(s => {
                        const startDate = new Date(s.start_date);
                        return startDate >= thisMonthStart && startDate <= thisMonthEnd;
                    });

                    // 月間トレンドデータを生成
                    const monthlyTrend = generateMonthlyTrendFromData(subscriptions);

                    // 実際の売上を計算（会員ごとの金額を合計）
                    const totalExpectedRevenue = membersList
                        .filter(m => m.status === 'ACTIVE')
                        .reduce((sum, m) => sum + m.monthlyPrice, 0);

                    setMemberData({
                        totalMembers: subscriptions.length,
                        activeMembers: activeSubscriptions.length,
                        newMembersThisMonth: newThisMonth.length,
                        churnedMembers: canceledThisMonth.length,
                        churnRate: activeSubscriptions.length > 0
                            ? (canceledThisMonth.length / activeSubscriptions.length * 100)
                            : 0,
                        expectedRevenue: totalExpectedRevenue,
                        members: membersList,
                        monthlyTrend: monthlyTrend,
                        stores: stores,
                        loading: false,
                        error: null
                    });

                } catch (error) {
                    console.error('Square API Error:', error);
                    setMemberData(prev => ({
                        ...prev,
                        loading: false,
                        error: error.message
                    }));
                }
            }, [activeStoreId, allowedStoreIds]);

            useEffect(() => {
                fetchSquareData();
                // 5分ごとに更新
                const interval = setInterval(fetchSquareData, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, [fetchSquareData]);

            return { memberData, refreshSquareData: fetchSquareData, operateSubscription };
        };

        // ========================================
        // Googleフォーム日報データ連携
        // ========================================

        const useDailyReportData = () => {
            const [reportData, setReportData] = useState({
                reports: [],
                loading: true,
                error: null,
                lastUpdated: null
            });

            const fetchReportData = useCallback(async () => {
                // デモモード
                if (GOOGLE_FORM_SHEET_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                    // サンプルデータ
                    const sampleData = generateSampleReportData();
                    setReportData({
                        reports: sampleData,
                        loading: false,
                        error: null,
                        lastUpdated: new Date()
                    });
                    return;
                }

                try {
                    const response = await fetch(GOOGLE_FORM_SHEET_URL);
                    if (!response.ok) {
                        throw new Error('Failed to fetch report data');
                    }
                    const data = await response.json();

                    setReportData({
                        reports: data.reports || [],
                        loading: false,
                        error: null,
                        lastUpdated: new Date()
                    });
                } catch (error) {
                    console.error('Report fetch error:', error);
                    setReportData(prev => ({
                        ...prev,
                        loading: false,
                        error: error.message
                    }));
                }
            }, []);

            useEffect(() => {
                fetchReportData();
            }, [fetchReportData]);

            return { reportData, refreshReportData: fetchReportData };
        };

        // サンプル日報データ生成
        const generateSampleReportData = () => {
            const reports = [];
            const storeNames = ['新宿店', '渋谷店'];
            const now = new Date();

            for (let i = 0; i < 30; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);

                storeNames.forEach(store => {
                    reports.push({
                        timestamp: date.toISOString(),
                        store: store,
                        hpbNew: Math.floor(Math.random() * 5),
                        metaNew: Math.floor(Math.random() * 4),
                        referralNew: Math.floor(Math.random() * 3),
                        discountNew: Math.floor(Math.random() * 2),
                        hpbContract: Math.floor(Math.random() * 3),
                        metaContract: Math.floor(Math.random() * 2),
                        referralContract: Math.floor(Math.random() * 2),
                        discountContract: Math.floor(Math.random() * 1),
                        existingTreatments: Math.floor(Math.random() * 15) + 5,
                        dailyTasksCompleted: Math.random() > 0.1,
                        tomorrowPrepCompleted: Math.random() > 0.15
                    });
                });
            }

            return reports;
        };

        // サンプル会員データ生成
        const generateSampleMembers = () => {
            const names = ['田中太郎', '佐藤花子', '鈴木一郎', '高橋美咲', '伊藤健太', '渡辺さくら', '山本大輔', '中村優子', '小林誠', '加藤愛'];
            const statuses = ['ACTIVE', 'ACTIVE', 'ACTIVE', 'ACTIVE', 'ACTIVE', 'ACTIVE', 'CANCELED', 'PENDING'];
            const plans = ['スタンダードプラン', 'プレミアムプラン'];
            const members = [];

            for (let i = 0; i < 50; i++) {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - Math.floor(Math.random() * 12));

                let canceledDate = null;
                if (status === 'CANCELED') {
                    canceledDate = new Date(startDate);
                    canceledDate.setMonth(canceledDate.getMonth() + Math.floor(Math.random() * 6) + 1);
                }

                const monthlyPrice = Math.random() > 0.7 ? 15000 : 10000;
                const paymentCount = Math.floor(Math.random() * 5) + 1;
                const paymentHistory = [];
                for (let j = 0; j < paymentCount; j++) {
                    const payDate = new Date();
                    payDate.setMonth(payDate.getMonth() - j);
                    paymentHistory.push({
                        id: `inv_${i}_${j}`,
                        date: payDate.toISOString(),
                        amount: monthlyPrice,
                        status: Math.random() > 0.1 ? 'PAID' : 'PENDING'
                    });
                }

                members.push({
                    id: `sub_${i}`,
                    customerId: `cust_${i}`,
                    name: names[i % names.length] + (i > 9 ? ` (${Math.floor(i / 10)})` : ''),
                    email: `member${i}@example.com`,
                    phone: `090-${1000 + i}-${1000 + i}`,
                    status: status,
                    startDate: startDate.toISOString(),
                    canceledDate: canceledDate ? canceledDate.toISOString() : null,
                    planName: plans[monthlyPrice === 15000 ? 1 : 0],
                    monthlyPrice: monthlyPrice,
                    cadence: 'MONTHLY',
                    paymentHistory: paymentHistory
                });
            }

            return members;
        };

        // 月間トレンドデータ生成（サンプル）
        const generateMonthlyTrend = () => {
            const trend = [];
            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                trend.push({
                    month: date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' }),
                    newMembers: Math.floor(Math.random() * 15) + 5,
                    churnedMembers: Math.floor(Math.random() * 8) + 1,
                    netGrowth: 0
                });
            }

            trend.forEach(t => {
                t.netGrowth = t.newMembers - t.churnedMembers;
            });

            return trend;
        };

        // 実データから月間トレンドを生成（累積会員数付き）
        const generateMonthlyTrendFromData = (subscriptions) => {
            const trend = [];
            const now = new Date();
            let cumulativeActive = 0;

            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

                const newMembers = subscriptions.filter(s => {
                    const startDate = new Date(s.start_date);
                    return startDate >= monthStart && startDate <= monthEnd;
                }).length;

                const churnedMembers = subscriptions.filter(s => {
                    if (!s.canceled_date) return false;
                    const cancelDate = new Date(s.canceled_date);
                    return cancelDate >= monthStart && cancelDate <= monthEnd;
                }).length;

                // 各月末時点のアクティブ会員数を計算
                const activeAtMonthEnd = subscriptions.filter(s => {
                    const startDate = new Date(s.start_date);
                    if (startDate > monthEnd) return false;
                    if (s.status === 'CANCELED' && s.canceled_date) {
                        const cancelDate = new Date(s.canceled_date);
                        return cancelDate > monthEnd;
                    }
                    return s.status === 'ACTIVE' || s.status === 'PENDING' || s.status === 'PAUSED'
                        || (s.status === 'CANCELED' && s.canceled_date && new Date(s.canceled_date) > monthEnd);
                }).length;

                trend.push({
                    month: date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' }),
                    monthKey: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                    newMembers: newMembers,
                    churnedMembers: churnedMembers,
                    netGrowth: newMembers - churnedMembers,
                    activeMembers: activeAtMonthEnd
                });
            }

            return trend;
        };

        // ========================================
        // ダッシュボードメインビュー
        // ========================================

        const DashboardView = ({ memberData, reportData, selectedStore, setSelectedStore }) => {
            const [dateRange, setDateRange] = useState('month'); // 'week', 'month', 'quarter'

            if (!window.Recharts) return <div className="p-8 text-center">チャートを読み込み中...</div>;

            // 日報データの集計
            const aggregatedData = useMemo(() => {
                if (!reportData.reports || reportData.reports.length === 0) {
                    return {
                        totalNewVisits: 0,
                        totalContracts: 0,
                        totalTreatments: 0,
                        conversionRate: 0,
                        byChannel: [],
                        byStore: [],
                        dailyTrend: []
                    };
                }

                let filtered = reportData.reports;
                if (selectedStore !== 'all') {
                    filtered = filtered.filter(r => r.store === selectedStore);
                }

                // 期間フィルタ
                const now = new Date();
                const startDate = new Date();
                switch (dateRange) {
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                }
                filtered = filtered.filter(r => new Date(r.timestamp) >= startDate);

                // チャネル別集計
                const channels = [
                    { name: 'HPB', newKey: 'hpbNew', contractKey: 'hpbContract', color: '#f97316' },
                    { name: 'Meta', newKey: 'metaNew', contractKey: 'metaContract', color: '#3b82f6' },
                    { name: '紹介', newKey: 'referralNew', contractKey: 'referralContract', color: '#22c55e' },
                    { name: '割引集客', newKey: 'discountNew', contractKey: 'discountContract', color: '#a855f7' }
                ];

                const byChannel = channels.map(ch => {
                    const newCount = filtered.reduce((sum, r) => sum + (r[ch.newKey] || 0), 0);
                    const contractCount = filtered.reduce((sum, r) => sum + (r[ch.contractKey] || 0), 0);
                    return {
                        name: ch.name,
                        new: newCount,
                        contract: contractCount,
                        rate: newCount > 0 ? (contractCount / newCount * 100).toFixed(1) : 0,
                        color: ch.color
                    };
                });

                // 店舗別集計
                const storeMap = {};
                filtered.forEach(r => {
                    if (!storeMap[r.store]) {
                        storeMap[r.store] = { store: r.store, new: 0, contract: 0, treatments: 0 };
                    }
                    storeMap[r.store].new += (r.hpbNew || 0) + (r.metaNew || 0) + (r.referralNew || 0) + (r.discountNew || 0);
                    storeMap[r.store].contract += (r.hpbContract || 0) + (r.metaContract || 0) + (r.referralContract || 0) + (r.discountContract || 0);
                    storeMap[r.store].treatments += r.existingTreatments || 0;
                });
                const byStore = Object.values(storeMap);

                // 日別推移
                const dailyMap = {};
                filtered.forEach(r => {
                    const dateKey = new Date(r.timestamp).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                    if (!dailyMap[dateKey]) {
                        dailyMap[dateKey] = { date: dateKey, new: 0, contract: 0, treatments: 0 };
                    }
                    dailyMap[dateKey].new += (r.hpbNew || 0) + (r.metaNew || 0) + (r.referralNew || 0) + (r.discountNew || 0);
                    dailyMap[dateKey].contract += (r.hpbContract || 0) + (r.metaContract || 0) + (r.referralContract || 0) + (r.discountContract || 0);
                    dailyMap[dateKey].treatments += r.existingTreatments || 0;
                });
                const dailyTrend = Object.values(dailyMap).slice(-14);

                const totalNew = byChannel.reduce((sum, ch) => sum + ch.new, 0);
                const totalContract = byChannel.reduce((sum, ch) => sum + ch.contract, 0);
                const totalTreatments = filtered.reduce((sum, r) => sum + (r.existingTreatments || 0), 0);

                return {
                    totalNewVisits: totalNew,
                    totalContracts: totalContract,
                    totalTreatments: totalTreatments,
                    conversionRate: totalNew > 0 ? (totalContract / totalNew * 100) : 0,
                    byChannel,
                    byStore,
                    dailyTrend
                };
            }, [reportData.reports, selectedStore, dateRange]);

            const CHART_COLORS = ['#3f9968', '#63b185', '#94ccac', '#c1e1cf'];

            return (
                <div className="space-y-6">
                    {/* フィルターバー */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <label className="text-sm font-medium text-slate-600">店舗:</label>
                                <select
                                    value={selectedStore}
                                    onChange={(e) => setSelectedStore(e.target.value)}
                                    className="px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                >
                                    <option value="all">全店舗</option>
                                    {(currentAccess
                                        ? serverStores.filter(s => currentAccess.storeIds.includes(s.id))
                                        : serverStores
                                    ).map(s => (
                                        <option key={s.id} value={s.name}>{s.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex items-center gap-2">
                                {['week', 'month', 'quarter'].map(range => (
                                    <button
                                        key={range}
                                        onClick={() => setDateRange(range)}
                                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                            dateRange === range
                                                ? 'bg-sise-500 text-white'
                                                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                        }`}
                                    >
                                        {range === 'week' ? '1週間' : range === 'month' ? '1ヶ月' : '3ヶ月'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Square会員データ KPIカード */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KpiCard
                            title="アクティブ会員数"
                            value={formatNumber(memberData.activeMembers)}
                            subValue={`総会員: ${formatNumber(memberData.totalMembers)}人`}
                            trend={null}
                            icon="users"
                            color="bg-sise-500"
                        />
                        <KpiCard
                            title="今月の想定売上"
                            value={formatCurrency(memberData.expectedRevenue)}
                            subValue="サブスク収益"
                            trend={null}
                            icon="wallet"
                            color="bg-green-500"
                        />
                        <KpiCard
                            title="今月の新規会員"
                            value={formatNumber(memberData.newMembersThisMonth)}
                            subValue="入会者数"
                            trend={null}
                            icon="user-plus"
                            color="bg-blue-500"
                        />
                        <KpiCard
                            title="退会率"
                            value={formatPercent(memberData.churnRate)}
                            subValue={`退会者: ${memberData.churnedMembers}人`}
                            trend={memberData.churnRate > 5 ? null : null}
                            icon="user-minus"
                            color={memberData.churnRate > 5 ? "bg-red-500" : "bg-slate-500"}
                        />
                    </div>

                    {/* 日報集計 KPIカード */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KpiCard
                            title="新規来店数"
                            value={formatNumber(aggregatedData.totalNewVisits)}
                            subValue="全チャネル合計"
                            trend={null}
                            icon="user-check"
                            color="bg-orange-500"
                        />
                        <KpiCard
                            title="契約数"
                            value={formatNumber(aggregatedData.totalContracts)}
                            subValue="新規契約"
                            trend={null}
                            icon="file-signature"
                            color="bg-purple-500"
                        />
                        <KpiCard
                            title="成約率"
                            value={formatPercent(aggregatedData.conversionRate)}
                            subValue="新規→契約"
                            trend={null}
                            icon="target"
                            color="bg-teal-500"
                        />
                        <KpiCard
                            title="既存施術数"
                            value={formatNumber(aggregatedData.totalTreatments)}
                            subValue="リピーター対応"
                            trend={null}
                            icon="heart-handshake"
                            color="bg-rose-500"
                        />
                    </div>

                    {/* チャート */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* チャネル別成績 */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">チャネル別新規・契約数</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={aggregatedData.byChannel}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="name" tick={{ fontSize: 12 }} />
                                    <YAxis tick={{ fontSize: 12 }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0' }}
                                        formatter={(value, name) => [value, name === 'new' ? '新規' : '契約']}
                                    />
                                    <Legend formatter={(value) => value === 'new' ? '新規数' : '契約数'} />
                                    <Bar dataKey="new" name="new" fill="#0ea5e9" radius={[4, 4, 0, 0]} />
                                    <Bar dataKey="contract" name="contract" fill="#22c55e" radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </Card>

                        {/* 日別推移 */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">日別推移</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={aggregatedData.dailyTrend}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="date" tick={{ fontSize: 10 }} />
                                    <YAxis tick={{ fontSize: 12 }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0' }}
                                    />
                                    <Legend />
                                    <Line type="monotone" dataKey="new" name="新規" stroke="#0ea5e9" strokeWidth={2} dot={{ r: 3 }} />
                                    <Line type="monotone" dataKey="contract" name="契約" stroke="#22c55e" strokeWidth={2} dot={{ r: 3 }} />
                                    <Line type="monotone" dataKey="treatments" name="施術" stroke="#f97316" strokeWidth={2} dot={{ r: 3 }} />
                                </LineChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>

                    {/* チャネル別成約率テーブル */}
                    <Card>
                        <h3 className="text-lg font-bold text-slate-900 mb-4">チャネル別パフォーマンス</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-200">
                                        <th className="text-left py-3 px-4 text-sm font-semibold text-slate-600">チャネル</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">新規数</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">契約数</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">成約率</th>
                                        <th className="text-left py-3 px-4 text-sm font-semibold text-slate-600">進捗</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {aggregatedData.byChannel.map((ch, index) => (
                                        <tr key={ch.name} className="border-b border-slate-100/60 table-row-hover">
                                            <td className="py-3 px-4">
                                                <div className="flex items-center">
                                                    <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: ch.color }}></div>
                                                    <span className="font-medium text-slate-900">{ch.name}</span>
                                                </div>
                                            </td>
                                            <td className="text-right py-3 px-4 text-slate-700">{ch.new}人</td>
                                            <td className="text-right py-3 px-4 text-slate-700">{ch.contract}人</td>
                                            <td className="text-right py-3 px-4">
                                                <span className={`font-semibold ${parseFloat(ch.rate) >= 50 ? 'text-green-600' : parseFloat(ch.rate) >= 30 ? 'text-yellow-600' : 'text-red-500'}`}>
                                                    {ch.rate}%
                                                </span>
                                            </td>
                                            <td className="py-3 px-4">
                                                <div className="w-full bg-slate-200 rounded-full h-2">
                                                    <div
                                                        className="h-2 rounded-full transition-all"
                                                        style={{ width: `${Math.min(parseFloat(ch.rate), 100)}%`, backgroundColor: ch.color }}
                                                    ></div>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {/* 店舗別サマリ */}
                    {aggregatedData.byStore.length > 1 && (
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">店舗別サマリ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {aggregatedData.byStore.map((store, index) => (
                                    <div key={store.store} className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                        <h4 className="font-semibold text-slate-900 mb-3 flex items-center">
                                            <Icon name="building-2" size={18} className="mr-2 text-sise-500" />
                                            {store.store}
                                        </h4>
                                        <div className="grid grid-cols-3 gap-4 text-center">
                                            <div>
                                                <p className="text-2xl font-bold text-sise-600">{store.new}</p>
                                                <p className="text-xs text-slate-500">新規</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-bold text-green-600">{store.contract}</p>
                                                <p className="text-xs text-slate-500">契約</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-bold text-orange-600">{store.treatments}</p>
                                                <p className="text-xs text-slate-500">施術</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // ========================================
        // 日報一覧ビュー
        // ========================================

        const DailyReportListView = ({ reportData }) => {
            const [filterStore, setFilterStore] = useState('all');
            const [sortOrder, setSortOrder] = useState('desc');

            const filteredReports = useMemo(() => {
                let reports = reportData.reports || [];
                if (filterStore !== 'all') {
                    reports = reports.filter(r => r.store === filterStore);
                }
                return reports.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });
            }, [reportData.reports, filterStore, sortOrder]);

            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-xl font-bold text-slate-900">日報一覧</h2>
                        <div className="flex items-center gap-3">
                            <select
                                value={filterStore}
                                onChange={(e) => setFilterStore(e.target.value)}
                                className="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:border-sise-500 outline-none"
                            >
                                <option value="all">全店舗</option>
                                {(currentAccess
                                    ? serverStores.filter(s => currentAccess.storeIds.includes(s.id))
                                    : serverStores
                                ).map(s => (
                                    <option key={s.id} value={s.name}>{s.name}</option>
                                ))}
                            </select>
                            <button
                                onClick={() => setSortOrder(sortOrder === 'desc' ? 'asc' : 'desc')}
                                className="flex items-center px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50"
                            >
                                <Icon name={sortOrder === 'desc' ? 'arrow-down' : 'arrow-up'} size={16} className="mr-1" />
                                {sortOrder === 'desc' ? '新しい順' : '古い順'}
                            </button>
                        </div>
                    </div>

                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-200 bg-slate-50">
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">日時</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">店舗</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">HPB<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">Meta<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">紹介<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">割引<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">既存<br/>施術</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">業務</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">準備</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredReports.slice(0, 50).map((report, index) => (
                                        <tr key={index} className="border-b border-slate-100/60 table-row-hover">
                                            <td className="py-3 px-3 text-slate-700">
                                                {new Date(report.timestamp).toLocaleDateString('ja-JP', {
                                                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                                })}
                                            </td>
                                            <td className="py-3 px-3">
                                                <span className="px-2 py-1 bg-sise-100 text-sise-700 rounded text-xs font-medium">
                                                    {report.store}
                                                </span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-orange-600">{report.hpbNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.hpbContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-blue-600">{report.metaNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.metaContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-emerald-600">{report.referralNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.referralContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-purple-600">{report.discountNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.discountContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2 font-semibold text-slate-700">
                                                {report.existingTreatments}
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                {report.dailyTasksCompleted ? (
                                                    <span className="text-green-500"><Icon name="check-circle" size={18} /></span>
                                                ) : (
                                                    <span className="text-red-400"><Icon name="x-circle" size={18} /></span>
                                                )}
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                {report.tomorrowPrepCompleted ? (
                                                    <span className="text-green-500"><Icon name="check-circle" size={18} /></span>
                                                ) : (
                                                    <span className="text-red-400"><Icon name="x-circle" size={18} /></span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredReports.length > 50 && (
                            <div className="text-center py-4 text-sm text-slate-500">
                                最新50件を表示中（全{filteredReports.length}件）
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        // ========================================
        // 会員管理ビュー（Square連携）
        // ========================================

        const MemberManagementView = ({ memberData, refreshSquareData, operateSubscription, activeStoreId }) => {
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [filterStatus, setFilterStatus] = useState('all'); // all, ACTIVE, CANCELED, PENDING
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedMember, setSelectedMember] = useState(null);
            const [actionLoading, setActionLoading] = useState(null); // 'cancel'|'pause'|'resume'
            const [actionMessage, setActionMessage] = useState(null); // { type, text }

            const handleRefresh = async () => {
                setIsRefreshing(true);
                await refreshSquareData();
                setIsRefreshing(false);
            };

            const handleAction = async (member, action) => {
                const labels = { cancel: '解約', pause: '一時停止', resume: '再開' };
                if (!confirm(`${member.name} のサブスクリプションを${labels[action]}しますか？`)) return;

                setActionLoading(action);
                setActionMessage(null);
                try {
                    await operateSubscription(member.id, action, member.storeId);
                    setActionMessage({ type: 'success', text: `${labels[action]}が完了しました` });
                    // データ更新
                    await refreshSquareData();
                    setSelectedMember(null);
                } catch (e) {
                    setActionMessage({ type: 'error', text: `${labels[action]}に失敗: ${e.message}` });
                } finally {
                    setActionLoading(null);
                }
            };

            // 月額単価（設定可能にする）
            const monthlyPrice = 10000;

            // LTV計算（平均継続月数を仮定）
            const avgRetentionMonths = memberData.churnRate > 0 ? Math.round(100 / memberData.churnRate) : 24;
            const estimatedLTV = monthlyPrice * avgRetentionMonths;

            // 会員フィルタリング
            const filteredMembers = useMemo(() => {
                let filtered = memberData.members || [];

                // ステータスフィルタ
                if (filterStatus !== 'all') {
                    filtered = filtered.filter(m => m.status === filterStatus);
                }

                // 検索クエリ
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(m =>
                        m.name.toLowerCase().includes(query) ||
                        m.email.toLowerCase().includes(query) ||
                        m.phone.includes(query)
                    );
                }

                return filtered;
            }, [memberData.members, filterStatus, searchQuery]);

            // ステータスバッジの色
            const getStatusColor = (status) => {
                switch (status) {
                    case 'ACTIVE': return 'bg-green-100 text-green-700 border-green-200';
                    case 'CANCELED': return 'bg-red-100 text-red-700 border-red-200';
                    case 'PENDING': return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                    case 'PAUSED': return 'bg-slate-100 text-slate-700 border-slate-200';
                    default: return 'bg-slate-100 text-slate-700 border-slate-200';
                }
            };

            // ステータスラベル
            const getStatusLabel = (status) => {
                switch (status) {
                    case 'ACTIVE': return 'アクティブ';
                    case 'CANCELED': return '退会';
                    case 'PENDING': return '保留中';
                    case 'PAUSED': return '一時停止';
                    default: return status;
                }
            };

            // 頻度ラベル
            const getCadenceLabel = (cadence) => {
                switch (cadence) {
                    case 'DAILY': return '日次';
                    case 'WEEKLY': return '週次';
                    case 'EVERY_TWO_WEEKS': return '隔週';
                    case 'MONTHLY': return '月額';
                    case 'EVERY_TWO_MONTHS': return '隔月';
                    case 'QUARTERLY': return '四半期';
                    case 'EVERY_FOUR_MONTHS': return '4ヶ月毎';
                    case 'EVERY_SIX_MONTHS': return '半年';
                    case 'ANNUAL': return '年額';
                    case 'EVERY_TWO_YEARS': return '2年毎';
                    default: return cadence || '月額';
                }
            };

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">会員管理</h2>
                            <p className="text-xs text-sise-500 mt-1 tracking-wide font-medium">MEMBER MANAGEMENT</p>
                        </div>
                        <button
                            onClick={handleRefresh}
                            disabled={isRefreshing}
                            className="flex items-center px-4 py-2.5 bg-sise-500 hover:bg-sise-600 text-white rounded-xl font-medium text-sm shadow-lg shadow-sise-500/25 transition-all disabled:opacity-50 hover:shadow-sise-500/40"
                        >
                            <Icon name={isRefreshing ? "loader" : "refresh-cw"} size={16} className={`mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                            {isRefreshing ? '更新中...' : 'データ更新'}
                        </button>
                    </div>

                    {memberData.error && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p className="text-red-700 text-sm">
                                <Icon name="alert-circle" size={16} className="inline mr-2" />
                                エラー: {memberData.error}
                            </p>
                        </div>
                    )}

                    {/* 会員サマリ */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <Card hover className="stagger-1 animate-fade-in-up border-sise-100">
                            <div className="flex items-center justify-between mb-3">
                                <span className="text-xs font-medium text-slate-500 tracking-wide uppercase">アクティブ会員</span>
                                <div className="w-8 h-8 bg-sise-50 rounded-lg flex items-center justify-center">
                                    <Icon name="users" size={16} className="text-sise-500" />
                                </div>
                            </div>
                            <p className="text-3xl font-bold text-slate-800 num-animate">{memberData.activeMembers}</p>
                            <p className="text-xs text-slate-400 mt-1.5">累計: {memberData.totalMembers}人</p>
                        </Card>

                        <Card hover className="stagger-2 animate-fade-in-up border-emerald-100">
                            <div className="flex items-center justify-between mb-3">
                                <span className="text-xs font-medium text-slate-500 tracking-wide uppercase">月間想定売上</span>
                                <div className="w-8 h-8 bg-emerald-50 rounded-lg flex items-center justify-center">
                                    <Icon name="trending-up" size={16} className="text-emerald-500" />
                                </div>
                            </div>
                            <p className="text-3xl font-bold text-slate-800 num-animate">{formatCurrency(memberData.expectedRevenue)}</p>
                            <p className="text-xs text-slate-400 mt-1.5">@{formatCurrency(monthlyPrice)}/月</p>
                        </Card>

                        <Card hover className="stagger-3 animate-fade-in-up border-teal-100">
                            <div className="flex items-center justify-between mb-3">
                                <span className="text-xs font-medium text-slate-500 tracking-wide uppercase">今月の新規入会</span>
                                <div className="w-8 h-8 bg-teal-50 rounded-lg flex items-center justify-center">
                                    <Icon name="user-plus" size={16} className="text-teal-500" />
                                </div>
                            </div>
                            <p className="text-3xl font-bold text-slate-800 num-animate">{memberData.newMembersThisMonth}</p>
                            <p className="text-xs text-slate-400 mt-1.5">新規獲得</p>
                        </Card>

                        <Card hover className={`stagger-4 animate-fade-in-up ${memberData.churnRate > 5 ? 'border-red-200' : 'border-slate-100'}`}>
                            <div className="flex items-center justify-between mb-3">
                                <span className="text-xs font-medium text-slate-500 tracking-wide uppercase">退会率</span>
                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${memberData.churnRate > 5 ? 'bg-red-50' : 'bg-slate-50'}`}>
                                    <Icon name="user-minus" size={16} className={memberData.churnRate > 5 ? 'text-red-400' : 'text-slate-400'} />
                                </div>
                            </div>
                            <p className={`text-3xl font-bold num-animate ${memberData.churnRate > 5 ? 'text-red-600' : 'text-slate-800'}`}>
                                {formatPercent(memberData.churnRate)}
                            </p>
                            <p className="text-xs text-slate-400 mt-1.5">
                                退会者: {memberData.churnedMembers}人
                            </p>
                        </Card>
                    </div>

                    {/* 分析カード */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="text-base font-bold text-slate-800 mb-1">収益分析</h3>
                        <p className="text-xs text-slate-400 mb-3 tracking-wide">REVENUE ANALYSIS</p>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">月額単価</span>
                                    <span className="font-bold text-slate-900">{formatCurrency(monthlyPrice)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">年間想定売上</span>
                                    <span className="font-bold text-green-600">{formatCurrency(memberData.expectedRevenue * 12)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">平均継続期間</span>
                                    <span className="font-bold text-slate-900">約{avgRetentionMonths}ヶ月</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-sise-50 rounded-lg border border-sise-200">
                                    <span className="text-sise-700 font-medium">推定LTV</span>
                                    <span className="font-bold text-sise-900">{formatCurrency(estimatedLTV)}</span>
                                </div>
                            </div>
                        </Card>

                        <Card>
                            <h3 className="text-base font-bold text-slate-800 mb-1">KPIトレンド</h3>
                        <p className="text-xs text-slate-400 mb-3 tracking-wide">KEY METRICS</p>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-slate-600">会員維持率</span>
                                        <span className="font-semibold text-green-600">{formatPercent(100 - memberData.churnRate)}</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-2">
                                        <div
                                            className="bg-gradient-to-r from-sise-400 to-sise-500 h-2 rounded-full transition-all"
                                            style={{ width: `${100 - memberData.churnRate}%` }}
                                        ></div>
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-slate-600">目標会員数達成率</span>
                                        <span className="font-semibold text-sise-600">{formatPercent(memberData.activeMembers / 200 * 100)}</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-2">
                                        <div
                                            className="bg-gradient-to-r from-sise-300 to-sise-500 h-2 rounded-full transition-all"
                                            style={{ width: `${Math.min(memberData.activeMembers / 200 * 100, 100)}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">目標: 200人</p>
                                </div>
                            </div>
                        </Card>
                    </div>

                    {/* 月間入退会トレンドチャート */}
                    <Card className="stagger-5 animate-fade-in-up">
                        <h3 className="text-base font-bold text-slate-800 mb-1">月間入退会トレンド</h3>
                        <p className="text-xs text-slate-400 mb-4 tracking-wide">MONTHLY ENROLLMENT TREND</p>
                        {window.Recharts && (
                            <ResponsiveContainer width="100%" height={350}>
                                <ComposedChart data={memberData.monthlyTrend || []}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="month" tick={{ fontSize: 11 }} />
                                    <YAxis yAxisId="left" tick={{ fontSize: 12 }} label={{ value: '人数', angle: -90, position: 'insideLeft', style: { fontSize: 11 } }} />
                                    <YAxis yAxisId="right" orientation="right" tick={{ fontSize: 12 }} label={{ value: '累積会員', angle: 90, position: 'insideRight', style: { fontSize: 11 } }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0', borderRadius: '8px' }}
                                        formatter={(value, name) => {
                                            if (name === 'newMembers') return [value + '人', '新規入会'];
                                            if (name === 'churnedMembers') return [value + '人', '退会'];
                                            if (name === 'netGrowth') return [value + '人', '純増減'];
                                            if (name === 'activeMembers') return [value + '人', 'アクティブ会員'];
                                            return [value, name];
                                        }}
                                    />
                                    <Legend
                                        formatter={(value) => {
                                            if (value === 'newMembers') return '新規入会';
                                            if (value === 'churnedMembers') return '退会';
                                            if (value === 'netGrowth') return '純増減';
                                            if (value === 'activeMembers') return 'アクティブ会員';
                                            return value;
                                        }}
                                    />
                                    <Bar yAxisId="left" dataKey="newMembers" name="newMembers" fill="#63b185" radius={[6, 6, 0, 0]} />
                                    <Bar yAxisId="left" dataKey="churnedMembers" name="churnedMembers" fill="#fda4af" radius={[6, 6, 0, 0]} />
                                    <Line yAxisId="left" type="monotone" dataKey="netGrowth" name="netGrowth" stroke="#eab308" strokeWidth={2} strokeDasharray="5 5" dot={{ r: 3 }} />
                                    <Line yAxisId="right" type="monotone" dataKey="activeMembers" name="activeMembers" stroke="#3f9968" strokeWidth={3} dot={{ r: 4, fill: '#3f9968' }} />
                                </ComposedChart>
                            </ResponsiveContainer>
                        )}
                    </Card>

                    {/* 月別サマリーテーブル */}
                    <Card>
                        <h3 className="text-base font-bold text-slate-800 mb-1">月別入退会サマリー</h3>
                        <p className="text-xs text-slate-400 mb-4 tracking-wide">MONTHLY SUMMARY</p>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b-2 border-slate-200 bg-slate-50">
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">月</th>
                                        <th className="text-right py-3 px-3 font-semibold text-green-600">入会</th>
                                        <th className="text-right py-3 px-3 font-semibold text-red-600">退会</th>
                                        <th className="text-right py-3 px-3 font-semibold text-sise-600">純増減</th>
                                        <th className="text-right py-3 px-3 font-semibold text-slate-600">アクティブ</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">推移</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(memberData.monthlyTrend || []).slice().reverse().map((m, idx) => {
                                        const maxActive = Math.max(...(memberData.monthlyTrend || []).map(t => t.activeMembers || 0), 1);
                                        return (
                                            <tr key={m.month} className={`border-b border-slate-100 ${idx === 0 ? 'bg-sise-50' : 'hover:bg-slate-50'}`}>
                                                <td className="py-3 px-3 font-medium text-slate-900">
                                                    {m.month}
                                                    {idx === 0 && <span className="ml-2 text-xs bg-sise-100 text-sise-700 px-2 py-0.5 rounded-full">今月</span>}
                                                </td>
                                                <td className="text-right py-3 px-3">
                                                    <span className="font-bold text-green-600">+{m.newMembers}</span>
                                                </td>
                                                <td className="text-right py-3 px-3">
                                                    <span className="font-bold text-red-500">-{m.churnedMembers}</span>
                                                </td>
                                                <td className="text-right py-3 px-3">
                                                    <span className={`font-bold px-2 py-1 rounded ${m.netGrowth >= 0 ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50'}`}>
                                                        {m.netGrowth >= 0 ? '+' : ''}{m.netGrowth}
                                                    </span>
                                                </td>
                                                <td className="text-right py-3 px-3 font-semibold text-slate-900">{m.activeMembers || '-'}</td>
                                                <td className="py-3 px-3">
                                                    <div className="w-full bg-slate-200 rounded-full h-2 min-w-[80px]">
                                                        <div
                                                            className="bg-gradient-to-r from-sise-300 to-sise-500 h-2 rounded-full transition-all"
                                                            style={{ width: `${((m.activeMembers || 0) / maxActive) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {/* 会員一覧テーブル */}
                    <Card>
                        <div className="flex flex-wrap items-center justify-between gap-4 mb-5">
                            <div>
                                <h3 className="text-base font-bold text-slate-800">会員一覧</h3>
                                <p className="text-xs text-slate-400 tracking-wide">MEMBER LIST</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="relative">
                                    <Icon name="search" size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="検索..."
                                        className="pl-8 pr-3 py-2 border border-slate-200 rounded-xl text-sm focus:border-sise-400 focus:ring-1 focus:ring-sise-400/30 outline-none w-40 bg-slate-50/50"
                                    />
                                </div>
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="px-3 py-2 border border-slate-200 rounded-xl text-sm focus:border-sise-400 outline-none bg-slate-50/50"
                                >
                                    <option value="all">全て</option>
                                    <option value="ACTIVE">アクティブ</option>
                                    <option value="CANCELED">退会</option>
                                    <option value="PENDING">保留中</option>
                                </select>
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-200 bg-slate-50">
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">会員名</th>
                                        {memberData.stores && memberData.stores.length > 1 && (
                                            <th className="text-left py-3 px-3 font-semibold text-slate-600">店舗</th>
                                        )}
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">ステータス</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">プラン</th>
                                        <th className="text-right py-3 px-3 font-semibold text-slate-600">金額</th>
                                        <th className="text-center py-3 px-3 font-semibold text-slate-600">頻度</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">入会日</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">退会日</th>
                                        <th className="text-center py-3 px-3 font-semibold text-slate-600">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredMembers.slice(0, 20).map((member) => (
                                        <tr key={member.id} className="border-b border-slate-100/60 table-row-hover">
                                            <td className="py-3 px-3">
                                                <div>
                                                    <p className="font-medium text-slate-900">{member.name}</p>
                                                    <p className="text-xs text-slate-500">{member.email}</p>
                                                </div>
                                            </td>
                                            {memberData.stores && memberData.stores.length > 1 && (
                                                <td className="py-3 px-3 text-xs text-slate-600">{member.storeName}</td>
                                            )}
                                            <td className="py-3 px-3">
                                                <span className={`px-2 py-1 rounded text-xs font-medium border ${getStatusColor(member.status)}`}>
                                                    {getStatusLabel(member.status)}
                                                </span>
                                            </td>
                                            <td className="py-3 px-3 text-slate-700">{member.planName}</td>
                                            <td className="text-right py-3 px-3 font-semibold text-slate-900">
                                                {formatCurrency(member.monthlyPrice)}
                                            </td>
                                            <td className="text-center py-3 px-3">
                                                <span className="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs font-medium">
                                                    {getCadenceLabel(member.cadence)}
                                                </span>
                                            </td>
                                            <td className="py-3 px-3 text-slate-700">
                                                {new Date(member.startDate).toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' })}
                                            </td>
                                            <td className="py-3 px-3 text-slate-700">
                                                {member.canceledDate
                                                    ? new Date(member.canceledDate).toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' })
                                                    : '-'
                                                }
                                            </td>
                                            <td className="text-center py-3 px-3">
                                                <button
                                                    onClick={() => setSelectedMember(member)}
                                                    className="text-sise-600 hover:text-sise-700 font-medium text-xs underline"
                                                >
                                                    詳細
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredMembers.length > 20 && (
                            <div className="text-center py-4 text-sm text-slate-500">
                                最新20件を表示中（全{filteredMembers.length}件）
                            </div>
                        )}
                        {filteredMembers.length === 0 && (
                            <div className="text-center py-8 text-slate-500">
                                <Icon name="users" size={48} className="mx-auto mb-2 text-slate-300" />
                                <p>該当する会員が見つかりませんでした</p>
                            </div>
                        )}
                    </Card>

                    {/* 会員詳細モーダル */}
                    {selectedMember && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in" onClick={() => { setSelectedMember(null); setActionMessage(null); }}>
                            <div className="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto animate-scale-in border border-slate-200/50" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-slate-900">{selectedMember.name}</h3>
                                    <button onClick={() => { setSelectedMember(null); setActionMessage(null); }} className="p-2 hover:bg-slate-100 rounded-lg">
                                        <Icon name="x" size={20} />
                                    </button>
                                </div>

                                {/* 操作メッセージ */}
                                {actionMessage && (
                                    <div className={`mb-4 p-3 rounded-lg text-sm ${actionMessage.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                        {actionMessage.text}
                                    </div>
                                )}

                                {/* 会員情報サマリ */}
                                <div className="grid grid-cols-2 gap-3 mb-4 p-3 bg-slate-50 rounded-lg">
                                    <div>
                                        <span className="text-xs text-slate-500">プラン</span>
                                        <p className="font-medium text-slate-900">{selectedMember.planName}</p>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-500">金額 / 頻度</span>
                                        <p className="font-medium text-slate-900">{formatCurrency(selectedMember.monthlyPrice)} / {getCadenceLabel(selectedMember.cadence)}</p>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-500">入会日</span>
                                        <p className="font-medium text-slate-900">{new Date(selectedMember.startDate).toLocaleDateString('ja-JP')}</p>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-500">ステータス</span>
                                        <p><span className={`px-2 py-1 rounded text-xs font-medium border ${getStatusColor(selectedMember.status)}`}>{getStatusLabel(selectedMember.status)}</span></p>
                                    </div>
                                    {selectedMember.storeName && (
                                        <div>
                                            <span className="text-xs text-slate-500">店舗</span>
                                            <p className="font-medium text-slate-900">{selectedMember.storeName}</p>
                                        </div>
                                    )}
                                    <div>
                                        <span className="text-xs text-slate-500">メール</span>
                                        <p className="font-medium text-slate-900 text-sm">{selectedMember.email}</p>
                                    </div>
                                </div>

                                {/* 操作ボタン（管理者・責任者のみ） */}
                                {(!currentAccess || currentAccess.role === 'manager') && <div className="mb-4">
                                    <h4 className="text-sm font-semibold text-slate-700 mb-2">サブスクリプション操作</h4>
                                    <div className="flex flex-wrap gap-2">
                                        {selectedMember.status === 'ACTIVE' && (
                                            <>
                                                <button
                                                    onClick={() => handleAction(selectedMember, 'pause')}
                                                    disabled={actionLoading}
                                                    className="flex items-center px-3 py-2 bg-amber-50 hover:bg-amber-100 border border-amber-200 text-amber-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                                >
                                                    <Icon name="pause-circle" size={16} className="mr-1.5" />
                                                    {actionLoading === 'pause' ? '処理中...' : '一時停止'}
                                                </button>
                                                <button
                                                    onClick={() => handleAction(selectedMember, 'cancel')}
                                                    disabled={actionLoading}
                                                    className="flex items-center px-3 py-2 bg-red-50 hover:bg-red-100 border border-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                                >
                                                    <Icon name="x-circle" size={16} className="mr-1.5" />
                                                    {actionLoading === 'cancel' ? '処理中...' : '解約'}
                                                </button>
                                            </>
                                        )}
                                        {selectedMember.status === 'PAUSED' && (
                                            <button
                                                onClick={() => handleAction(selectedMember, 'resume')}
                                                disabled={actionLoading}
                                                className="flex items-center px-3 py-2 bg-green-50 hover:bg-green-100 border border-green-200 text-green-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                            >
                                                <Icon name="play-circle" size={16} className="mr-1.5" />
                                                {actionLoading === 'resume' ? '処理中...' : '再開'}
                                            </button>
                                        )}
                                        {selectedMember.status === 'CANCELED' && (
                                            <span className="px-3 py-2 bg-slate-50 text-slate-500 rounded-lg text-sm">
                                                このサブスクリプションは既に解約済みです
                                            </span>
                                        )}
                                    </div>
                                </div>}

                                <h4 className="text-sm font-semibold text-slate-700 mb-3">請求・支払い履歴（最新10件）</h4>
                                <div className="space-y-3">
                                    {selectedMember.paymentHistory.map((payment) => {
                                        const getPaymentStatusStyle = (status) => {
                                            switch (status) {
                                                case 'PAID': return 'bg-green-100 text-green-700';
                                                case 'UNPAID': return 'bg-yellow-100 text-yellow-700';
                                                case 'DRAFT': return 'bg-slate-100 text-slate-600';
                                                case 'CANCELED': return 'bg-red-100 text-red-600';
                                                case 'SCHEDULED': return 'bg-blue-100 text-blue-600';
                                                default: return 'bg-slate-100 text-slate-600';
                                            }
                                        };
                                        const getPaymentStatusLabel = (status) => {
                                            switch (status) {
                                                case 'PAID': return '支払済';
                                                case 'UNPAID': return '未払';
                                                case 'DRAFT': return '下書き';
                                                case 'CANCELED': return 'キャンセル';
                                                case 'SCHEDULED': return '予定';
                                                case 'PARTIALLY_PAID': return '一部支払';
                                                case 'PAYMENT_PENDING': return '処理中';
                                                default: return status;
                                            }
                                        };
                                        return (
                                            <div key={payment.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                <div>
                                                    <p className="font-medium text-slate-900">{formatCurrency(payment.amount)}</p>
                                                    <p className="text-xs text-slate-500">
                                                        {new Date(payment.date).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}
                                                        {payment.invoiceNumber !== '-' && ` / ${payment.invoiceNumber}`}
                                                    </p>
                                                </div>
                                                <span className={`px-2 py-1 rounded text-xs font-medium ${getPaymentStatusStyle(payment.status)}`}>
                                                    {getPaymentStatusLabel(payment.status)}
                                                </span>
                                            </div>
                                        );
                                    })}
                                    {selectedMember.paymentHistory.length === 0 && (
                                        <p className="text-center text-slate-500 py-4">支払履歴がありません</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 設定情報 */}
                    <Card className="bg-slate-50 border-slate-300">
                        <div className="flex items-start">
                            <Icon name="info" size={20} className="text-sise-500 mr-3 mt-0.5" />
                            <div>
                                <h4 className="font-semibold text-slate-900 mb-2">Square API連携について</h4>
                                <p className="text-sm text-slate-600 mb-2">
                                    このダッシュボードはSquare APIと連携して会員データを取得します。
                                    実際のデータを表示するには、以下の設定が必要です：
                                </p>
                                <ul className="text-sm text-slate-600 list-disc list-inside space-y-1">
                                    <li>Square Developer Accountでアプリを作成</li>
                                    <li>Customers API、Subscriptions APIの権限を付与</li>
                                    <li>アクセストークンとロケーションIDを設定</li>
                                </ul>
                                <p className="text-xs text-slate-500 mt-3">
                                    現在はデモモードで動作しています。
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // ========================================
        // スタッフ管理セクション
        // ========================================

        const StaffManagementSection = () => {
            const [staffList, setStaffList] = useState(loadStaffList());
            const [editingStaff, setEditingStaff] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [copiedId, setCopiedId] = useState(null);
            const [formData, setFormData] = useState({ name: '', role: 'staff', storeIds: [] });

            const handleSave = () => {
                if (!formData.name.trim()) return;
                let updated;
                if (editingStaff) {
                    updated = staffList.map(s => s.id === editingStaff.id ? { ...s, ...formData } : s);
                } else {
                    const newStaff = { ...formData, id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6) };
                    updated = [...staffList, newStaff];
                }
                setStaffList(updated);
                saveStaffList(updated);
                setEditingStaff(null);
                setIsAdding(false);
                setFormData({ name: '', role: 'staff', storeIds: [] });
            };

            const handleDelete = (id) => {
                if (!confirm('このスタッフを削除しますか？')) return;
                const updated = staffList.filter(s => s.id !== id);
                setStaffList(updated);
                saveStaffList(updated);
            };

            const handleEdit = (staff) => {
                setFormData({ name: staff.name, role: staff.role, storeIds: staff.storeIds || [] });
                setEditingStaff(staff);
                setIsAdding(true);
            };

            const handleCopyUrl = (staff) => {
                const url = generateStaffUrl(staff);
                navigator.clipboard.writeText(url).then(() => {
                    setCopiedId(staff.id);
                    setTimeout(() => setCopiedId(null), 2000);
                });
            };

            const toggleStoreId = (storeId) => {
                setFormData(prev => ({
                    ...prev,
                    storeIds: prev.storeIds.includes(storeId)
                        ? prev.storeIds.filter(id => id !== storeId)
                        : [...prev.storeIds, storeId]
                }));
            };

            return (
                <Card>
                    <div className="flex items-center justify-between mb-4">
                        <div>
                            <h3 className="text-lg font-semibold text-slate-900">スタッフ管理</h3>
                            <p className="text-xs text-sise-500 tracking-wide mt-0.5">STAFF ACCESS MANAGEMENT</p>
                        </div>
                        {!isAdding && (
                            <button
                                onClick={() => { setIsAdding(true); setEditingStaff(null); setFormData({ name: '', role: 'staff', storeIds: [] }); }}
                                className="flex items-center px-3 py-2 bg-sise-500 hover:bg-sise-600 text-white rounded-xl text-sm font-medium shadow-lg shadow-sise-500/25 transition-all"
                            >
                                <Icon name="user-plus" size={16} className="mr-1.5" />
                                スタッフを追加
                            </button>
                        )}
                    </div>

                    {/* 追加・編集フォーム */}
                    {isAdding && (
                        <div className="mb-6 p-4 bg-sise-50/50 rounded-xl border border-sise-200 animate-scale-in">
                            <h4 className="font-semibold text-slate-800 mb-3">
                                {editingStaff ? 'スタッフ編集' : '新規スタッフ追加'}
                            </h4>
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">名前</label>
                                    <input
                                        type="text"
                                        value={formData.name}
                                        onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                                        placeholder="例: 田中太郎"
                                        className="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm focus:border-sise-400 focus:ring-1 focus:ring-sise-400/30 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">役割</label>
                                    <div className="flex gap-3">
                                        <label className={`flex items-center px-4 py-2.5 rounded-xl border cursor-pointer transition-all ${formData.role === 'staff' ? 'bg-sise-50 border-sise-300 text-sise-700' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                                            <input type="radio" name="role" value="staff" checked={formData.role === 'staff'} onChange={() => setFormData(prev => ({ ...prev, role: 'staff' }))} className="sr-only" />
                                            <Icon name="user" size={16} className="mr-2" />
                                            <div>
                                                <p className="text-sm font-medium">スタッフ</p>
                                                <p className="text-[10px] text-slate-400">自店舗のみ閲覧</p>
                                            </div>
                                        </label>
                                        <label className={`flex items-center px-4 py-2.5 rounded-xl border cursor-pointer transition-all ${formData.role === 'manager' ? 'bg-sise-50 border-sise-300 text-sise-700' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                                            <input type="radio" name="role" value="manager" checked={formData.role === 'manager'} onChange={() => setFormData(prev => ({ ...prev, role: 'manager' }))} className="sr-only" />
                                            <Icon name="shield" size={16} className="mr-2" />
                                            <div>
                                                <p className="text-sm font-medium">店舗責任者</p>
                                                <p className="text-[10px] text-slate-400">複数店舗閲覧可</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        {formData.role === 'manager' ? '閲覧可能な店舗（複数選択可）' : '所属店舗'}
                                    </label>
                                    {serverStores.length > 0 ? (
                                        <div className="space-y-2">
                                            {serverStores.map(store => (
                                                <label key={store.id} className={`flex items-center px-3 py-2 rounded-lg border cursor-pointer transition-all ${formData.storeIds.includes(store.id) ? 'bg-sise-50 border-sise-300' : 'bg-white border-slate-200 hover:border-slate-300'}`}>
                                                    <input
                                                        type="checkbox"
                                                        checked={formData.storeIds.includes(store.id)}
                                                        onChange={() => toggleStoreId(store.id)}
                                                        className="w-4 h-4 text-sise-500 border-slate-300 rounded focus:ring-sise-400"
                                                    />
                                                    <span className="ml-2 text-sm text-slate-700">{store.name}</span>
                                                    <span className="ml-auto text-xs text-slate-400">ID: {store.id}</span>
                                                </label>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-sm text-slate-500 bg-slate-50 p-3 rounded-lg">
                                            店舗が未設定です。先にSquare APIを接続してください。<br />
                                            デモモードでも手動で店舗IDを指定できます。
                                        </p>
                                    )}
                                    {serverStores.length === 0 && (
                                        <div className="mt-2">
                                            <label className="block text-xs font-medium text-slate-500 mb-1">店舗ID（手動入力、カンマ区切り）</label>
                                            <input
                                                type="text"
                                                value={formData.storeIds.join(',')}
                                                onChange={(e) => setFormData(prev => ({ ...prev, storeIds: e.target.value.split(',').map(s => s.trim()).filter(Boolean) }))}
                                                placeholder="例: 1,2,3"
                                                className="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm focus:border-sise-400 outline-none"
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-4">
                                <button
                                    onClick={() => { setIsAdding(false); setEditingStaff(null); }}
                                    className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-xl transition-colors"
                                >
                                    キャンセル
                                </button>
                                <button
                                    onClick={handleSave}
                                    disabled={!formData.name.trim() || formData.storeIds.length === 0}
                                    className="px-4 py-2 bg-sise-500 hover:bg-sise-600 text-white rounded-xl text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {editingStaff ? '更新' : '追加'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* スタッフ一覧 */}
                    {staffList.length > 0 ? (
                        <div className="space-y-3">
                            {staffList.map(staff => (
                                <div key={staff.id} className="p-4 bg-white rounded-xl border border-slate-200 hover:border-sise-200 transition-colors">
                                    <div className="flex items-start justify-between">
                                        <div className="flex items-center">
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${staff.role === 'manager' ? 'bg-amber-50 text-amber-600' : 'bg-sise-50 text-sise-600'}`}>
                                                <Icon name={staff.role === 'manager' ? 'shield' : 'user'} size={20} />
                                            </div>
                                            <div className="ml-3">
                                                <p className="font-semibold text-slate-800">{staff.name}</p>
                                                <div className="flex items-center gap-2 mt-0.5">
                                                    <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${staff.role === 'manager' ? 'bg-amber-100 text-amber-700' : 'bg-sise-100 text-sise-700'}`}>
                                                        {staff.role === 'manager' ? '店舗責任者' : 'スタッフ'}
                                                    </span>
                                                    <span className="text-xs text-slate-400">
                                                        {(staff.storeIds || []).map(sid => {
                                                            const store = serverStores.find(s => s.id === sid);
                                                            return store ? store.name : `店舗${sid}`;
                                                        }).join(', ')}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button
                                                onClick={() => handleCopyUrl(staff)}
                                                className={`flex items-center px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all ${copiedId === staff.id ? 'bg-green-100 text-green-700' : 'bg-slate-100 hover:bg-sise-50 text-slate-600 hover:text-sise-600'}`}
                                                title="URLをコピー"
                                            >
                                                <Icon name={copiedId === staff.id ? 'check' : 'link'} size={14} className="mr-1" />
                                                {copiedId === staff.id ? 'コピー済' : 'URL'}
                                            </button>
                                            <button
                                                onClick={() => handleEdit(staff)}
                                                className="p-1.5 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"
                                                title="編集"
                                            >
                                                <Icon name="pencil" size={14} />
                                            </button>
                                            <button
                                                onClick={() => handleDelete(staff.id)}
                                                className="p-1.5 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors"
                                                title="削除"
                                            >
                                                <Icon name="trash-2" size={14} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        !isAdding && (
                            <div className="text-center py-8">
                                <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-3">
                                    <Icon name="users" size={28} className="text-slate-300" />
                                </div>
                                <p className="text-slate-500 text-sm">スタッフが登録されていません</p>
                                <p className="text-slate-400 text-xs mt-1">「スタッフを追加」から登録してください</p>
                            </div>
                        )
                    )}

                    {/* ヘルプ */}
                    <div className="mt-4 p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <p className="text-xs text-slate-500 leading-relaxed">
                            <Icon name="info" size={12} className="inline mr-1" />
                            各スタッフの「URL」ボタンで専用リンクをコピーできます。
                            そのURLを開くと、割り当てられた店舗のデータのみ表示されます。
                            店舗責任者は複数店舗を閲覧可能です。管理者（URLなし）は全データにアクセスできます。
                        </p>
                    </div>
                </Card>
            );
        };

        // ========================================
        // 設定ビュー
        // ========================================

        const SettingsView = ({ onSettingsSaved }) => {
            const [squareStatus, setSquareStatus] = useState({ loading: true });
            const [googleFormUrl, setGoogleFormUrl] = useState(
                localStorage.getItem('sise_gas_url') || GOOGLE_FORM_SHEET_URL
            );
            const [saveMessage, setSaveMessage] = useState('');

            // サーバーの接続状態を取得
            useEffect(() => {
                fetchSquareConfig().then(config => {
                    setSquareStatus({ ...config, loading: false });
                });
            }, []);

            const handleSaveGas = () => {
                localStorage.setItem('sise_gas_url', googleFormUrl);
                setSaveMessage('GAS URLを保存しました。リロードで反映されます。');
                setTimeout(() => setSaveMessage(''), 5000);
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-xl font-bold text-slate-900">設定</h2>

                    {saveMessage && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p className="text-green-700 text-sm flex items-center">
                                <Icon name="check-circle" size={16} className="mr-2" />
                                {saveMessage}
                            </p>
                        </div>
                    )}

                    {/* Square API 接続状態 */}
                    <Card>
                        <h3 className="text-lg font-semibold text-slate-900 mb-4">Square API連携</h3>
                        {squareStatus.loading ? (
                            <div className="skeleton h-20 rounded-lg"></div>
                        ) : (
                            <div className="space-y-4">
                                <div className={`flex items-center p-4 rounded-lg border ${
                                    squareStatus.configured
                                        ? 'bg-green-50 border-green-200'
                                        : 'bg-amber-50 border-amber-200'
                                }`}>
                                    <Icon
                                        name={squareStatus.configured ? 'check-circle' : 'alert-circle'}
                                        size={24}
                                        className={`mr-3 ${squareStatus.configured ? 'text-green-500' : 'text-amber-500'}`}
                                    />
                                    <div>
                                        <p className={`font-semibold ${squareStatus.configured ? 'text-green-800' : 'text-amber-800'}`}>
                                            {squareStatus.configured ? '接続済み' : '未設定（デモモード）'}
                                        </p>
                                        <p className="text-sm text-slate-600">
                                            {squareStatus.configured
                                                ? `${squareStatus.stores?.length || 1}店舗接続中 / 環境: ${squareStatus.environment === 'production' ? '本番' : 'Sandbox'}`
                                                : 'Vercelダッシュボードで環境変数を設定してください'
                                            }
                                        </p>
                                    </div>
                                </div>

                                {/* 接続済み店舗一覧 */}
                                {squareStatus.stores && squareStatus.stores.length > 0 && (
                                    <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                        <h4 className="font-semibold text-slate-900 mb-3">接続済み店舗</h4>
                                        <div className="space-y-2">
                                            {squareStatus.stores.map(store => (
                                                <div key={store.id} className="flex items-center justify-between p-2 bg-white rounded border border-slate-200">
                                                    <div>
                                                        <span className="font-medium text-slate-900">{store.name}</span>
                                                        <span className="text-xs text-slate-500 ml-2">ID: {store.id}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs text-slate-500">Location: {store.locationId}</span>
                                                        <span className={`text-xs px-2 py-0.5 rounded ${store.environment === 'production' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                                                            {store.environment === 'production' ? '本番' : 'Sandbox'}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                    <h4 className="font-semibold text-slate-900 mb-3">環境変数の設定方法</h4>
                                    <p className="text-sm text-slate-600 mb-3">
                                        Vercelダッシュボード &gt; Settings &gt; Environment Variables に以下を設定:
                                    </p>

                                    <p className="text-xs font-semibold text-slate-700 mb-2">単一店舗の場合:</p>
                                    <div className="space-y-2 font-mono text-xs mb-4">
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_ACCESS_TOKEN</span>
                                            <span className="text-slate-500">= sq0atp-... or EAAA...</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_LOCATION_ID</span>
                                            <span className="text-slate-500">= L...</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_ENVIRONMENT</span>
                                            <span className="text-slate-500">= sandbox or production</span>
                                        </div>
                                    </div>

                                    <p className="text-xs font-semibold text-slate-700 mb-2">複数店舗の場合（店舗ごとに番号を付与）:</p>
                                    <div className="space-y-2 font-mono text-xs">
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_STORE_1_NAME</span>
                                            <span className="text-slate-500">= 新宿店</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_STORE_1_ACCESS_TOKEN</span>
                                            <span className="text-slate-500">= 店舗1のトークン</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_STORE_1_LOCATION_ID</span>
                                            <span className="text-slate-500">= 店舗1のロケーションID</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-slate-100 rounded border border-slate-200">
                                            <span className="text-slate-500">... 2〜5も同様 (SQUARE_STORE_2_*, SQUARE_STORE_3_* ...)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </Card>

                    {/* Googleフォーム連携 */}
                    <Card>
                        <h3 className="text-lg font-semibold text-slate-900 mb-4">Googleフォーム連携</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Google Apps Script Web App URL
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="url"
                                        value={googleFormUrl}
                                        onChange={(e) => setGoogleFormUrl(e.target.value)}
                                        className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                        placeholder="https://script.google.com/macros/s/..."
                                    />
                                    <button
                                        onClick={handleSaveGas}
                                        className="px-4 py-2 bg-sise-500 hover:bg-sise-600 text-white rounded-lg font-medium text-sm transition-colors"
                                    >
                                        保存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </Card>

                    {/* スタッフ管理 */}
                    <StaffManagementSection />

                    {/* セキュリティ情報 */}
                    <Card className="bg-green-50 border-green-200">
                        <div className="flex items-start">
                            <Icon name="shield-check" size={20} className="text-green-500 mr-3 mt-0.5" />
                            <div>
                                <h4 className="font-semibold text-green-900 mb-1">セキュリティ</h4>
                                <p className="text-sm text-green-700">
                                    Square APIトークンはVercelのサーバーサイドで管理されています。
                                    ブラウザにはトークンが露出しない安全な構成です。
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // ========================================
        // メインアプリケーション
        // ========================================

        const App = () => {
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedStore, setSelectedStore] = useState('all');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(false);

            const isStaffMode = !!currentAccess;
            const [activeStoreId, setActiveStoreId] = useState(
                isStaffMode && currentAccess.storeIds.length === 1 ? currentAccess.storeIds[0] : 'all'
            );
            // Square データ取得（店舗選択に連動、アクセス制限適用）
            const { memberData, refreshSquareData, operateSubscription } = useSquareData(
                activeStoreId,
                isStaffMode ? currentAccess.storeIds : null
            );
            // 日報データ取得
            const { reportData, refreshReportData } = useDailyReportData();

            // ダークモード切り替え
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);

            const navItems = [
                { id: 'dashboard', label: 'ダッシュボード', icon: 'layout-dashboard' },
                { id: 'reports', label: '日報一覧', icon: 'clipboard-list' },
                { id: 'members', label: '会員管理', icon: 'users' },
                ...(!isStaffMode ? [{ id: 'settings', label: '設定', icon: 'settings' }] : []),
            ];

            const renderView = () => {
                switch (currentView) {
                    case 'dashboard':
                        return <DashboardView
                            memberData={memberData}
                            reportData={reportData}
                            selectedStore={selectedStore}
                            setSelectedStore={setSelectedStore}
                        />;
                    case 'reports':
                        return <DailyReportListView reportData={reportData} />;
                    case 'members':
                        return <MemberManagementView memberData={memberData} refreshSquareData={refreshSquareData} operateSubscription={operateSubscription} activeStoreId={activeStoreId} />;
                    case 'settings':
                        return isStaffMode
                            ? <DashboardView memberData={memberData} reportData={reportData} selectedStore={selectedStore} setSelectedStore={setSelectedStore} />
                            : <SettingsView onSettingsSaved={() => {}} />;
                    default:
                        return <DashboardView
                            memberData={memberData}
                            reportData={reportData}
                            selectedStore={selectedStore}
                            setSelectedStore={setSelectedStore}
                        />;
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 bg-mesh">
                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 z-50 glass-panel safe-top">
                        <div className="flex items-center justify-between px-5 h-16">
                            <div className="flex items-center">
                                <button
                                    onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                    className="lg:hidden p-2 rounded-xl hover:bg-sise-50 mr-2 transition-colors"
                                >
                                    <Icon name="menu" size={22} />
                                </button>
                                <div className="flex items-center">
                                    <div className="w-9 h-9 bg-gradient-to-br from-sise-400 to-sise-600 rounded-xl flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-sise-500/25">
                                        S
                                    </div>
                                    <div className="ml-3">
                                        <h1 className="text-base font-bold text-slate-800 tracking-wide">si'se</h1>
                                        <p className="text-[10px] text-sise-500 -mt-0.5 font-medium tracking-wider">DASHBOARD</p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-1.5">
                                {/* スタッフ表示バッジ */}
                                {isStaffMode && (
                                    <div className="flex items-center px-3 py-1.5 bg-sise-50 border border-sise-200 rounded-xl">
                                        <Icon name={currentAccess.role === 'manager' ? 'shield' : 'user'} size={14} className="text-sise-500 mr-1.5" />
                                        <span className="text-xs font-medium text-sise-700">{currentAccess.name}</span>
                                        <span className="text-[10px] text-sise-400 ml-1.5">
                                            {currentAccess.role === 'manager' ? '責任者' : 'スタッフ'}
                                        </span>
                                    </div>
                                )}
                                {/* 店舗セレクター（アクセス制限適用） */}
                                {(() => {
                                    const visibleStores = isStaffMode
                                        ? (memberData.stores || []).filter(s => currentAccess.storeIds.includes(s.id))
                                        : (memberData.stores || []);
                                    return visibleStores.length > 1 ? (
                                        <select
                                            value={activeStoreId}
                                            onChange={(e) => setActiveStoreId(e.target.value)}
                                            className="px-3 py-1.5 border border-sise-200 rounded-xl text-xs font-medium focus:border-sise-400 focus:ring-1 focus:ring-sise-400/30 outline-none bg-sise-50/50 text-sise-700"
                                        >
                                            <option value="all">全店舗</option>
                                            {visibleStores.map(s => (
                                                <option key={s.id} value={s.id}>{s.name}</option>
                                            ))}
                                        </select>
                                    ) : null;
                                })()}
                                <button
                                    onClick={() => { refreshReportData(); refreshSquareData(); }}
                                    className="p-2 rounded-xl hover:bg-sise-50 text-slate-500 hover:text-sise-600 transition-colors"
                                    title="データ更新"
                                >
                                    <Icon name="refresh-cw" size={18} />
                                </button>
                                <button
                                    onClick={() => setIsDarkMode(!isDarkMode)}
                                    className="p-2 rounded-xl hover:bg-sise-50 text-slate-500 hover:text-sise-600 transition-colors"
                                    title="ダークモード切り替え"
                                >
                                    <Icon name={isDarkMode ? 'sun' : 'moon'} size={18} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Sidebar Overlay (Mobile) */}
                    {isSidebarOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-40 lg:hidden"
                            onClick={() => setIsSidebarOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`fixed top-16 left-0 bottom-0 w-60 glass-panel z-40 transform transition-transform duration-300 ease-out lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <nav className="p-3 space-y-0.5 mt-2">
                            {navItems.map((item, idx) => (
                                <button
                                    key={item.id}
                                    onClick={() => {
                                        setCurrentView(item.id);
                                        setIsSidebarOpen(false);
                                    }}
                                    className={`w-full flex items-center px-4 py-2.5 rounded-xl text-left text-sm font-medium transition-all duration-200 ${
                                        currentView === item.id
                                            ? 'bg-sise-500 text-white shadow-md shadow-sise-500/25'
                                            : 'text-slate-600 hover:bg-sise-50 hover:text-sise-700'
                                    }`}
                                >
                                    <Icon name={item.icon} size={18} className="mr-3" />
                                    {item.label}
                                </button>
                            ))}
                        </nav>

                        {/* データ更新時刻 / スタッフ情報 */}
                        <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-200/50">
                            {isStaffMode && (
                                <div className="flex items-center mb-2 px-1">
                                    <div className={`w-7 h-7 rounded-lg flex items-center justify-center ${currentAccess.role === 'manager' ? 'bg-amber-50 text-amber-500' : 'bg-sise-50 text-sise-500'}`}>
                                        <Icon name={currentAccess.role === 'manager' ? 'shield' : 'user'} size={14} />
                                    </div>
                                    <div className="ml-2">
                                        <p className="text-xs font-medium text-slate-700 leading-tight">{currentAccess.name}</p>
                                        <p className="text-[10px] text-slate-400">
                                            {currentAccess.role === 'manager' ? '店舗責任者' : 'スタッフ'}
                                        </p>
                                    </div>
                                </div>
                            )}
                            <p className="text-[10px] text-slate-400 tracking-wide">
                                LAST UPDATE: {reportData.lastUpdated
                                    ? reportData.lastUpdated.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
                                    : '--:--'
                                }
                            </p>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="pt-16 lg:pl-60 min-h-screen">
                        <div className="p-4 lg:p-8 max-w-7xl mx-auto safe-bottom">
                            {memberData.loading || reportData.loading ? (
                                <div className="flex items-center justify-center h-64 animate-fade-in">
                                    <div className="text-center">
                                        <div className="w-10 h-10 border-3 border-sise-200 border-t-sise-500 rounded-full animate-spin mx-auto mb-4"></div>
                                        <p className="text-slate-400 text-sm tracking-wide">Loading...</p>
                                    </div>
                                </div>
                            ) : (
                                renderView()
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // アプリケーションのレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
