<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>si'se - 整体院経営ダッシュボード</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts Dependencies -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config for Tailwind (si'se Theme - Calm Blue/Green) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        sise: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9', // Brand Primary
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        accent: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e', // Success/Accent
                            600: '#16a34a',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', '"Hiragino Sans"', 'sans-serif'],
                        display: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: "Noto Sans JP", "Hiragino Sans", sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Dark Mode Styles */
        .dark body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .dark .bg-white {
            background-color: #1e293b !important;
        }

        .dark .bg-slate-50 {
            background-color: #0f172a !important;
        }

        .dark .text-slate-900 {
            color: #f1f5f9 !important;
        }

        .dark .text-slate-700 {
            color: #cbd5e1 !important;
        }

        .dark .text-slate-600 {
            color: #94a3b8 !important;
        }

        .dark .border-slate-200 {
            border-color: #334155 !important;
        }

        .dark .border-sise-200 {
            border-color: #0369a1 !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #0ea5e9;
            border-radius: 4px;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .skeleton {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e2e8f0;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            input, select, textarea {
                font-size: 16px !important;
            }
            button, a {
                min-height: 44px;
            }
        }

        /* Safe Area Support */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading-indicator" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f8fafc;">
            <div style="text-align: center;">
                <div style="width: 50px; height: 50px; border: 5px solid #0ea5e9; border-top: 5px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #1e293b; font-size: 16px; font-family: sans-serif;">si'se Dashboard</p>
                <p style="color: #64748b; font-size: 12px; font-family: sans-serif; margin-top: 10px;">読み込み中...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const RechartsLib = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, AreaChart, Area, PieChart, Pie, Cell, ComposedChart } = RechartsLib;

        // ========================================
        // 設定・定数
        // ========================================

        // 店舗マスタ
        const stores = [
            { id: 1, name: "新宿店", code: "shinjuku" },
            { id: 2, name: "渋谷店", code: "shibuya" }
        ];

        // Google Apps Script Web App URL (日報データ取得用)
        // ※実際のデプロイ後URLに置き換えてください
        const GOOGLE_FORM_SHEET_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL';

        // Square API設定（サーバーサイドプロキシ経由）
        // APIキーはVercel環境変数で管理、フロントエンドには露出しない
        const SQUARE_PROXY_BASE = '/api/square';

        // サーバーから設定を取得
        const fetchSquareConfig = async () => {
            try {
                const res = await fetch(`${SQUARE_PROXY_BASE}/config`);
                if (res.ok) return await res.json();
            } catch (e) {}
            return {
                configured: false,
                environment: 'sandbox',
                locationId: '',
                defaultMonthlyPrice: 10000
            };
        };

        // ========================================
        // ヘルパー関数
        // ========================================

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
        };

        const formatNumber = (value) => {
            return new Intl.NumberFormat('ja-JP').format(value);
        };

        const formatPercent = (value) => {
            return `${value.toFixed(1)}%`;
        };

        // ========================================
        // コンポーネント
        // ========================================

        // アイコンコンポーネント
        const Icon = ({ name, size = 20, color = "currentColor", className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
        };

        // カードコンポーネント
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>
                {children}
            </div>
        );

        // KPIカードコンポーネント
        const KpiCard = ({ title, value, subValue, trend, icon, color = "bg-sise-500" }) => (
            <Card className="hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start mb-4">
                    <div className={`rounded-lg ${color} text-white shadow-md p-3`}>
                        <Icon name={icon} size={24} />
                    </div>
                    {trend !== null && trend !== undefined && (
                        <span className={`font-medium ${trend >= 0 ? 'text-green-600' : 'text-red-500'} flex items-center bg-slate-50 px-2 py-1 rounded-full text-sm`}>
                            {trend >= 0 ? '+' : ''}{trend}%
                            <Icon name={trend >= 0 ? 'trending-up' : 'trending-down'} size={14} className="ml-1" />
                        </span>
                    )}
                </div>
                <h3 className="text-slate-600 font-medium text-sm">{title}</h3>
                <div className="flex items-baseline mt-1">
                    <span className="text-2xl font-bold text-slate-900">{value}</span>
                </div>
                {subValue && <p className="text-xs text-slate-500 mt-1">{subValue}</p>}
            </Card>
        );

        // ========================================
        // Square API連携
        // ========================================

        const useSquareData = () => {
            const [memberData, setMemberData] = useState({
                totalMembers: 0,
                activeMembers: 0,
                newMembersThisMonth: 0,
                churnedMembers: 0,
                churnRate: 0,
                expectedRevenue: 0,
                members: [], // 会員詳細リスト
                monthlyTrend: [], // 月間入退会トレンド
                loading: true,
                error: null
            });

            // ページネーション付きAPI呼び出しヘルパー（プロキシ経由）
            const fetchAllPages = async (endpoint, bodyBuilder, resultKey) => {
                let allResults = [];
                let cursor = null;
                do {
                    const body = bodyBuilder(cursor);
                    const response = await fetch(`${SQUARE_PROXY_BASE}/${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({}));
                        throw new Error(`API ${endpoint}: ${response.status} - ${JSON.stringify(errorBody.errors || errorBody.error || [])}`);
                    }
                    const data = await response.json();
                    allResults = allResults.concat(data[resultKey] || []);
                    cursor = data.cursor || null;
                } while (cursor);
                return allResults;
            };

            const fetchSquareData = useCallback(async () => {
                // サーバーの設定を確認
                const serverConfig = await fetchSquareConfig();

                // デモモード: サーバーにAPIが設定されていない場合はサンプルデータ
                if (!serverConfig.configured) {
                    const sampleMembers = generateSampleMembers();
                    const sampleMonthlyTrend = generateMonthlyTrend();

                    setMemberData({
                        totalMembers: 156,
                        activeMembers: 142,
                        newMembersThisMonth: 12,
                        churnedMembers: 5,
                        churnRate: 3.2,
                        expectedRevenue: 1420000,
                        members: sampleMembers,
                        monthlyTrend: sampleMonthlyTrend,
                        loading: false,
                        error: null
                    });
                    return;
                }

                const locationId = serverConfig.locationId;
                const defaultMonthlyPrice = serverConfig.defaultMonthlyPrice;

                try {
                    // 1. Customers API - 全顧客を取得（ページネーション付き）
                    const customers = await fetchAllPages(
                        'customers/search',
                        (cursor) => ({
                            limit: 100,
                            ...(cursor ? { cursor } : {})
                        }),
                        'customers'
                    );

                    // 2. Subscriptions API - ロケーションのサブスクリプション取得
                    const subscriptions = await fetchAllPages(
                        'subscriptions/search',
                        (cursor) => ({
                            query: {
                                filter: {
                                    location_ids: [locationId]
                                }
                            },
                            ...(cursor ? { cursor } : {})
                        }),
                        'subscriptions'
                    );

                    // 3. Catalog API - プラン名と金額の解決
                    const planIds = [...new Set(subscriptions
                        .filter(s => s.plan_variation_id)
                        .map(s => s.plan_variation_id))];

                    let catalogMap = {};
                    if (planIds.length > 0) {
                        try {
                            const catalogResponse = await fetch(`${SQUARE_PROXY_BASE}/catalog/batch-retrieve`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ object_ids: planIds })
                            });
                            if (catalogResponse.ok) {
                                const catalogData = await catalogResponse.json();
                                (catalogData.objects || []).forEach(obj => {
                                    const subPlan = obj.subscription_plan_variation_data || obj.subscription_plan_data;
                                    catalogMap[obj.id] = {
                                        name: subPlan?.name || obj.id,
                                        phases: subPlan?.phases || []
                                    };
                                });
                            }
                        } catch (e) {
                            console.warn('Catalog API fetch failed, using fallback:', e);
                        }
                    }

                    // 4. Invoices API - 請求書・支払い履歴
                    const invoices = await fetchAllPages(
                        'invoices/search',
                        (cursor) => ({
                            query: {
                                filter: {
                                    location_ids: [locationId]
                                }
                            },
                            limit: 200,
                            ...(cursor ? { cursor } : {})
                        }),
                        'invoices'
                    );

                    // 5. 会員詳細データの構築
                    const membersList = subscriptions.map(sub => {
                        const customer = customers.find(c => c.id === sub.customer_id);
                        const memberInvoices = invoices.filter(inv =>
                            inv.primary_recipient?.customer_id === sub.customer_id
                        );

                        // プラン金額をphasesから取得
                        let monthlyPrice = defaultMonthlyPrice;
                        let planName = 'スタンダードプラン';
                        let cadence = 'MONTHLY';

                        // Catalog APIからプラン情報取得
                        if (sub.plan_variation_id && catalogMap[sub.plan_variation_id]) {
                            const plan = catalogMap[sub.plan_variation_id];
                            planName = plan.name;
                            if (plan.phases && plan.phases.length > 0) {
                                const phase = plan.phases[0];
                                cadence = phase.cadence || 'MONTHLY';
                                if (phase.recurring_price_money) {
                                    monthlyPrice = phase.recurring_price_money.amount || monthlyPrice;
                                }
                            }
                        }

                        // Subscription phasesから直接取得（フォールバック）
                        if (sub.phases && sub.phases.length > 0) {
                            const activePhase = sub.phases.find(p => !p.uid || p) || sub.phases[0];
                            if (activePhase.recurring_price_money) {
                                monthlyPrice = activePhase.recurring_price_money.amount || monthlyPrice;
                            }
                            if (activePhase.cadence) {
                                cadence = activePhase.cadence;
                            }
                        }

                        // Invoice金額の正しい取得
                        const paymentHistory = memberInvoices
                            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                            .slice(0, 10)
                            .map(inv => {
                                let amount = 0;
                                if (inv.payment_requests && inv.payment_requests.length > 0) {
                                    const req = inv.payment_requests[0];
                                    amount = req.computed_amount_money?.amount
                                        || req.fixed_amount_requested_money?.amount
                                        || 0;
                                }
                                return {
                                    id: inv.id,
                                    date: inv.created_at,
                                    amount: amount,
                                    status: inv.status, // DRAFT, UNPAID, PAID, CANCELED等
                                    invoiceNumber: inv.invoice_number || '-'
                                };
                            });

                        return {
                            id: sub.id,
                            customerId: sub.customer_id,
                            name: customer ? `${customer.family_name || ''}${customer.given_name || ''}`.trim() || '未登録' : '未登録',
                            email: customer?.email_address || '-',
                            phone: customer?.phone_number || '-',
                            status: sub.status,
                            startDate: sub.start_date,
                            canceledDate: sub.canceled_date || null,
                            createdAt: sub.created_at,
                            planName: planName,
                            planVariationId: sub.plan_variation_id,
                            monthlyPrice: monthlyPrice,
                            cadence: cadence,
                            paymentHistory: paymentHistory
                        };
                    });

                    // 6. 集計
                    const activeSubscriptions = subscriptions.filter(s => s.status === 'ACTIVE');
                    const now = new Date();
                    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const thisMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                    const canceledThisMonth = subscriptions.filter(s => {
                        if (s.status !== 'CANCELED' || !s.canceled_date) return false;
                        const cancelDate = new Date(s.canceled_date);
                        return cancelDate >= thisMonthStart && cancelDate <= thisMonthEnd;
                    });

                    const newThisMonth = subscriptions.filter(s => {
                        const startDate = new Date(s.start_date);
                        return startDate >= thisMonthStart && startDate <= thisMonthEnd;
                    });

                    // 月間トレンドデータを生成
                    const monthlyTrend = generateMonthlyTrendFromData(subscriptions);

                    // 実際の売上を計算（会員ごとの金額を合計）
                    const totalExpectedRevenue = membersList
                        .filter(m => m.status === 'ACTIVE')
                        .reduce((sum, m) => sum + m.monthlyPrice, 0);

                    setMemberData({
                        totalMembers: subscriptions.length,
                        activeMembers: activeSubscriptions.length,
                        newMembersThisMonth: newThisMonth.length,
                        churnedMembers: canceledThisMonth.length,
                        churnRate: subscriptions.length > 0
                            ? (canceledThisMonth.length / activeSubscriptions.length * 100)
                            : 0,
                        expectedRevenue: totalExpectedRevenue,
                        members: membersList,
                        monthlyTrend: monthlyTrend,
                        loading: false,
                        error: null
                    });

                } catch (error) {
                    console.error('Square API Error:', error);
                    setMemberData(prev => ({
                        ...prev,
                        loading: false,
                        error: error.message
                    }));
                }
            }, []);

            useEffect(() => {
                fetchSquareData();
                // 5分ごとに更新
                const interval = setInterval(fetchSquareData, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, [fetchSquareData]);

            return { memberData, refreshSquareData: fetchSquareData };
        };

        // ========================================
        // Googleフォーム日報データ連携
        // ========================================

        const useDailyReportData = () => {
            const [reportData, setReportData] = useState({
                reports: [],
                loading: true,
                error: null,
                lastUpdated: null
            });

            const fetchReportData = useCallback(async () => {
                // デモモード
                if (GOOGLE_FORM_SHEET_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                    // サンプルデータ
                    const sampleData = generateSampleReportData();
                    setReportData({
                        reports: sampleData,
                        loading: false,
                        error: null,
                        lastUpdated: new Date()
                    });
                    return;
                }

                try {
                    const response = await fetch(GOOGLE_FORM_SHEET_URL);
                    if (!response.ok) {
                        throw new Error('Failed to fetch report data');
                    }
                    const data = await response.json();

                    setReportData({
                        reports: data.reports || [],
                        loading: false,
                        error: null,
                        lastUpdated: new Date()
                    });
                } catch (error) {
                    console.error('Report fetch error:', error);
                    setReportData(prev => ({
                        ...prev,
                        loading: false,
                        error: error.message
                    }));
                }
            }, []);

            useEffect(() => {
                fetchReportData();
            }, [fetchReportData]);

            return { reportData, refreshReportData: fetchReportData };
        };

        // サンプル日報データ生成
        const generateSampleReportData = () => {
            const reports = [];
            const storeNames = ['新宿店', '渋谷店'];
            const now = new Date();

            for (let i = 0; i < 30; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);

                storeNames.forEach(store => {
                    reports.push({
                        timestamp: date.toISOString(),
                        store: store,
                        hpbNew: Math.floor(Math.random() * 5),
                        metaNew: Math.floor(Math.random() * 4),
                        referralNew: Math.floor(Math.random() * 3),
                        discountNew: Math.floor(Math.random() * 2),
                        hpbContract: Math.floor(Math.random() * 3),
                        metaContract: Math.floor(Math.random() * 2),
                        referralContract: Math.floor(Math.random() * 2),
                        discountContract: Math.floor(Math.random() * 1),
                        existingTreatments: Math.floor(Math.random() * 15) + 5,
                        dailyTasksCompleted: Math.random() > 0.1,
                        tomorrowPrepCompleted: Math.random() > 0.15
                    });
                });
            }

            return reports;
        };

        // サンプル会員データ生成
        const generateSampleMembers = () => {
            const names = ['田中太郎', '佐藤花子', '鈴木一郎', '高橋美咲', '伊藤健太', '渡辺さくら', '山本大輔', '中村優子', '小林誠', '加藤愛'];
            const statuses = ['ACTIVE', 'ACTIVE', 'ACTIVE', 'ACTIVE', 'ACTIVE', 'ACTIVE', 'CANCELED', 'PENDING'];
            const plans = ['スタンダードプラン', 'プレミアムプラン'];
            const members = [];

            for (let i = 0; i < 50; i++) {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - Math.floor(Math.random() * 12));

                let canceledDate = null;
                if (status === 'CANCELED') {
                    canceledDate = new Date(startDate);
                    canceledDate.setMonth(canceledDate.getMonth() + Math.floor(Math.random() * 6) + 1);
                }

                const monthlyPrice = Math.random() > 0.7 ? 15000 : 10000;
                const paymentCount = Math.floor(Math.random() * 5) + 1;
                const paymentHistory = [];
                for (let j = 0; j < paymentCount; j++) {
                    const payDate = new Date();
                    payDate.setMonth(payDate.getMonth() - j);
                    paymentHistory.push({
                        id: `inv_${i}_${j}`,
                        date: payDate.toISOString(),
                        amount: monthlyPrice,
                        status: Math.random() > 0.1 ? 'PAID' : 'PENDING'
                    });
                }

                members.push({
                    id: `sub_${i}`,
                    customerId: `cust_${i}`,
                    name: names[i % names.length] + (i > 9 ? ` (${Math.floor(i / 10)})` : ''),
                    email: `member${i}@example.com`,
                    phone: `090-${1000 + i}-${1000 + i}`,
                    status: status,
                    startDate: startDate.toISOString(),
                    canceledDate: canceledDate ? canceledDate.toISOString() : null,
                    planName: plans[monthlyPrice === 15000 ? 1 : 0],
                    monthlyPrice: monthlyPrice,
                    cadence: 'MONTHLY',
                    paymentHistory: paymentHistory
                });
            }

            return members;
        };

        // 月間トレンドデータ生成（サンプル）
        const generateMonthlyTrend = () => {
            const trend = [];
            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                trend.push({
                    month: date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' }),
                    newMembers: Math.floor(Math.random() * 15) + 5,
                    churnedMembers: Math.floor(Math.random() * 8) + 1,
                    netGrowth: 0
                });
            }

            trend.forEach(t => {
                t.netGrowth = t.newMembers - t.churnedMembers;
            });

            return trend;
        };

        // 実データから月間トレンドを生成（累積会員数付き）
        const generateMonthlyTrendFromData = (subscriptions) => {
            const trend = [];
            const now = new Date();
            let cumulativeActive = 0;

            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

                const newMembers = subscriptions.filter(s => {
                    const startDate = new Date(s.start_date);
                    return startDate >= monthStart && startDate <= monthEnd;
                }).length;

                const churnedMembers = subscriptions.filter(s => {
                    if (!s.canceled_date) return false;
                    const cancelDate = new Date(s.canceled_date);
                    return cancelDate >= monthStart && cancelDate <= monthEnd;
                }).length;

                // 各月末時点のアクティブ会員数を計算
                const activeAtMonthEnd = subscriptions.filter(s => {
                    const startDate = new Date(s.start_date);
                    if (startDate > monthEnd) return false;
                    if (s.status === 'CANCELED' && s.canceled_date) {
                        const cancelDate = new Date(s.canceled_date);
                        return cancelDate > monthEnd;
                    }
                    return s.status === 'ACTIVE' || s.status === 'PENDING' || s.status === 'PAUSED'
                        || (s.status === 'CANCELED' && s.canceled_date && new Date(s.canceled_date) > monthEnd);
                }).length;

                trend.push({
                    month: date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' }),
                    monthKey: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                    newMembers: newMembers,
                    churnedMembers: churnedMembers,
                    netGrowth: newMembers - churnedMembers,
                    activeMembers: activeAtMonthEnd
                });
            }

            return trend;
        };

        // ========================================
        // ダッシュボードメインビュー
        // ========================================

        const DashboardView = ({ memberData, reportData, selectedStore, setSelectedStore }) => {
            const [dateRange, setDateRange] = useState('month'); // 'week', 'month', 'quarter'

            if (!window.Recharts) return <div className="p-8 text-center">チャートを読み込み中...</div>;

            // 日報データの集計
            const aggregatedData = useMemo(() => {
                if (!reportData.reports || reportData.reports.length === 0) {
                    return {
                        totalNewVisits: 0,
                        totalContracts: 0,
                        totalTreatments: 0,
                        conversionRate: 0,
                        byChannel: [],
                        byStore: [],
                        dailyTrend: []
                    };
                }

                let filtered = reportData.reports;
                if (selectedStore !== 'all') {
                    filtered = filtered.filter(r => r.store === selectedStore);
                }

                // 期間フィルタ
                const now = new Date();
                const startDate = new Date();
                switch (dateRange) {
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                }
                filtered = filtered.filter(r => new Date(r.timestamp) >= startDate);

                // チャネル別集計
                const channels = [
                    { name: 'HPB', newKey: 'hpbNew', contractKey: 'hpbContract', color: '#f97316' },
                    { name: 'Meta', newKey: 'metaNew', contractKey: 'metaContract', color: '#3b82f6' },
                    { name: '紹介', newKey: 'referralNew', contractKey: 'referralContract', color: '#22c55e' },
                    { name: '割引集客', newKey: 'discountNew', contractKey: 'discountContract', color: '#a855f7' }
                ];

                const byChannel = channels.map(ch => {
                    const newCount = filtered.reduce((sum, r) => sum + (r[ch.newKey] || 0), 0);
                    const contractCount = filtered.reduce((sum, r) => sum + (r[ch.contractKey] || 0), 0);
                    return {
                        name: ch.name,
                        new: newCount,
                        contract: contractCount,
                        rate: newCount > 0 ? (contractCount / newCount * 100).toFixed(1) : 0,
                        color: ch.color
                    };
                });

                // 店舗別集計
                const storeMap = {};
                filtered.forEach(r => {
                    if (!storeMap[r.store]) {
                        storeMap[r.store] = { store: r.store, new: 0, contract: 0, treatments: 0 };
                    }
                    storeMap[r.store].new += (r.hpbNew || 0) + (r.metaNew || 0) + (r.referralNew || 0) + (r.discountNew || 0);
                    storeMap[r.store].contract += (r.hpbContract || 0) + (r.metaContract || 0) + (r.referralContract || 0) + (r.discountContract || 0);
                    storeMap[r.store].treatments += r.existingTreatments || 0;
                });
                const byStore = Object.values(storeMap);

                // 日別推移
                const dailyMap = {};
                filtered.forEach(r => {
                    const dateKey = new Date(r.timestamp).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                    if (!dailyMap[dateKey]) {
                        dailyMap[dateKey] = { date: dateKey, new: 0, contract: 0, treatments: 0 };
                    }
                    dailyMap[dateKey].new += (r.hpbNew || 0) + (r.metaNew || 0) + (r.referralNew || 0) + (r.discountNew || 0);
                    dailyMap[dateKey].contract += (r.hpbContract || 0) + (r.metaContract || 0) + (r.referralContract || 0) + (r.discountContract || 0);
                    dailyMap[dateKey].treatments += r.existingTreatments || 0;
                });
                const dailyTrend = Object.values(dailyMap).slice(-14);

                const totalNew = byChannel.reduce((sum, ch) => sum + ch.new, 0);
                const totalContract = byChannel.reduce((sum, ch) => sum + ch.contract, 0);
                const totalTreatments = filtered.reduce((sum, r) => sum + (r.existingTreatments || 0), 0);

                return {
                    totalNewVisits: totalNew,
                    totalContracts: totalContract,
                    totalTreatments: totalTreatments,
                    conversionRate: totalNew > 0 ? (totalContract / totalNew * 100) : 0,
                    byChannel,
                    byStore,
                    dailyTrend
                };
            }, [reportData.reports, selectedStore, dateRange]);

            const CHART_COLORS = ['#0ea5e9', '#22c55e', '#f97316', '#a855f7'];

            return (
                <div className="space-y-6">
                    {/* フィルターバー */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <label className="text-sm font-medium text-slate-600">店舗:</label>
                                <select
                                    value={selectedStore}
                                    onChange={(e) => setSelectedStore(e.target.value)}
                                    className="px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                >
                                    <option value="all">全店舗</option>
                                    {stores.map(s => (
                                        <option key={s.id} value={s.name}>{s.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex items-center gap-2">
                                {['week', 'month', 'quarter'].map(range => (
                                    <button
                                        key={range}
                                        onClick={() => setDateRange(range)}
                                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                            dateRange === range
                                                ? 'bg-sise-500 text-white'
                                                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                        }`}
                                    >
                                        {range === 'week' ? '1週間' : range === 'month' ? '1ヶ月' : '3ヶ月'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Square会員データ KPIカード */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KpiCard
                            title="アクティブ会員数"
                            value={formatNumber(memberData.activeMembers)}
                            subValue={`総会員: ${formatNumber(memberData.totalMembers)}人`}
                            trend={null}
                            icon="users"
                            color="bg-sise-500"
                        />
                        <KpiCard
                            title="今月の想定売上"
                            value={formatCurrency(memberData.expectedRevenue)}
                            subValue="サブスク収益"
                            trend={null}
                            icon="wallet"
                            color="bg-green-500"
                        />
                        <KpiCard
                            title="今月の新規会員"
                            value={formatNumber(memberData.newMembersThisMonth)}
                            subValue="入会者数"
                            trend={null}
                            icon="user-plus"
                            color="bg-blue-500"
                        />
                        <KpiCard
                            title="退会率"
                            value={formatPercent(memberData.churnRate)}
                            subValue={`退会者: ${memberData.churnedMembers}人`}
                            trend={memberData.churnRate > 5 ? null : null}
                            icon="user-minus"
                            color={memberData.churnRate > 5 ? "bg-red-500" : "bg-slate-500"}
                        />
                    </div>

                    {/* 日報集計 KPIカード */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KpiCard
                            title="新規来店数"
                            value={formatNumber(aggregatedData.totalNewVisits)}
                            subValue="全チャネル合計"
                            trend={null}
                            icon="user-check"
                            color="bg-orange-500"
                        />
                        <KpiCard
                            title="契約数"
                            value={formatNumber(aggregatedData.totalContracts)}
                            subValue="新規契約"
                            trend={null}
                            icon="file-signature"
                            color="bg-purple-500"
                        />
                        <KpiCard
                            title="成約率"
                            value={formatPercent(aggregatedData.conversionRate)}
                            subValue="新規→契約"
                            trend={null}
                            icon="target"
                            color="bg-teal-500"
                        />
                        <KpiCard
                            title="既存施術数"
                            value={formatNumber(aggregatedData.totalTreatments)}
                            subValue="リピーター対応"
                            trend={null}
                            icon="heart-handshake"
                            color="bg-rose-500"
                        />
                    </div>

                    {/* チャート */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* チャネル別成績 */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">チャネル別新規・契約数</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={aggregatedData.byChannel}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="name" tick={{ fontSize: 12 }} />
                                    <YAxis tick={{ fontSize: 12 }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0' }}
                                        formatter={(value, name) => [value, name === 'new' ? '新規' : '契約']}
                                    />
                                    <Legend formatter={(value) => value === 'new' ? '新規数' : '契約数'} />
                                    <Bar dataKey="new" name="new" fill="#0ea5e9" radius={[4, 4, 0, 0]} />
                                    <Bar dataKey="contract" name="contract" fill="#22c55e" radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </Card>

                        {/* 日別推移 */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">日別推移</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={aggregatedData.dailyTrend}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="date" tick={{ fontSize: 10 }} />
                                    <YAxis tick={{ fontSize: 12 }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0' }}
                                    />
                                    <Legend />
                                    <Line type="monotone" dataKey="new" name="新規" stroke="#0ea5e9" strokeWidth={2} dot={{ r: 3 }} />
                                    <Line type="monotone" dataKey="contract" name="契約" stroke="#22c55e" strokeWidth={2} dot={{ r: 3 }} />
                                    <Line type="monotone" dataKey="treatments" name="施術" stroke="#f97316" strokeWidth={2} dot={{ r: 3 }} />
                                </LineChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>

                    {/* チャネル別成約率テーブル */}
                    <Card>
                        <h3 className="text-lg font-bold text-slate-900 mb-4">チャネル別パフォーマンス</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-200">
                                        <th className="text-left py-3 px-4 text-sm font-semibold text-slate-600">チャネル</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">新規数</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">契約数</th>
                                        <th className="text-right py-3 px-4 text-sm font-semibold text-slate-600">成約率</th>
                                        <th className="text-left py-3 px-4 text-sm font-semibold text-slate-600">進捗</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {aggregatedData.byChannel.map((ch, index) => (
                                        <tr key={ch.name} className="border-b border-slate-100 hover:bg-slate-50">
                                            <td className="py-3 px-4">
                                                <div className="flex items-center">
                                                    <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: ch.color }}></div>
                                                    <span className="font-medium text-slate-900">{ch.name}</span>
                                                </div>
                                            </td>
                                            <td className="text-right py-3 px-4 text-slate-700">{ch.new}人</td>
                                            <td className="text-right py-3 px-4 text-slate-700">{ch.contract}人</td>
                                            <td className="text-right py-3 px-4">
                                                <span className={`font-semibold ${parseFloat(ch.rate) >= 50 ? 'text-green-600' : parseFloat(ch.rate) >= 30 ? 'text-yellow-600' : 'text-red-500'}`}>
                                                    {ch.rate}%
                                                </span>
                                            </td>
                                            <td className="py-3 px-4">
                                                <div className="w-full bg-slate-200 rounded-full h-2">
                                                    <div
                                                        className="h-2 rounded-full transition-all"
                                                        style={{ width: `${Math.min(parseFloat(ch.rate), 100)}%`, backgroundColor: ch.color }}
                                                    ></div>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {/* 店舗別サマリ */}
                    {aggregatedData.byStore.length > 1 && (
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">店舗別サマリ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {aggregatedData.byStore.map((store, index) => (
                                    <div key={store.store} className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                        <h4 className="font-semibold text-slate-900 mb-3 flex items-center">
                                            <Icon name="building-2" size={18} className="mr-2 text-sise-500" />
                                            {store.store}
                                        </h4>
                                        <div className="grid grid-cols-3 gap-4 text-center">
                                            <div>
                                                <p className="text-2xl font-bold text-sise-600">{store.new}</p>
                                                <p className="text-xs text-slate-500">新規</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-bold text-green-600">{store.contract}</p>
                                                <p className="text-xs text-slate-500">契約</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-bold text-orange-600">{store.treatments}</p>
                                                <p className="text-xs text-slate-500">施術</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // ========================================
        // 日報一覧ビュー
        // ========================================

        const DailyReportListView = ({ reportData }) => {
            const [filterStore, setFilterStore] = useState('all');
            const [sortOrder, setSortOrder] = useState('desc');

            const filteredReports = useMemo(() => {
                let reports = reportData.reports || [];
                if (filterStore !== 'all') {
                    reports = reports.filter(r => r.store === filterStore);
                }
                return reports.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });
            }, [reportData.reports, filterStore, sortOrder]);

            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-xl font-bold text-slate-900">日報一覧</h2>
                        <div className="flex items-center gap-3">
                            <select
                                value={filterStore}
                                onChange={(e) => setFilterStore(e.target.value)}
                                className="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:border-sise-500 outline-none"
                            >
                                <option value="all">全店舗</option>
                                {stores.map(s => (
                                    <option key={s.id} value={s.name}>{s.name}</option>
                                ))}
                            </select>
                            <button
                                onClick={() => setSortOrder(sortOrder === 'desc' ? 'asc' : 'desc')}
                                className="flex items-center px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50"
                            >
                                <Icon name={sortOrder === 'desc' ? 'arrow-down' : 'arrow-up'} size={16} className="mr-1" />
                                {sortOrder === 'desc' ? '新しい順' : '古い順'}
                            </button>
                        </div>
                    </div>

                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-200 bg-slate-50">
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">日時</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">店舗</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">HPB<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">Meta<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">紹介<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">割引<br/><span className="text-xs font-normal">新規/契約</span></th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">既存<br/>施術</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">業務</th>
                                        <th className="text-center py-3 px-2 font-semibold text-slate-600">準備</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredReports.slice(0, 50).map((report, index) => (
                                        <tr key={index} className="border-b border-slate-100 hover:bg-slate-50">
                                            <td className="py-3 px-3 text-slate-700">
                                                {new Date(report.timestamp).toLocaleDateString('ja-JP', {
                                                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                                })}
                                            </td>
                                            <td className="py-3 px-3">
                                                <span className="px-2 py-1 bg-sise-100 text-sise-700 rounded text-xs font-medium">
                                                    {report.store}
                                                </span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-orange-600">{report.hpbNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.hpbContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-blue-600">{report.metaNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.metaContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-emerald-600">{report.referralNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.referralContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                <span className="text-purple-600">{report.discountNew}</span>
                                                <span className="text-slate-400 mx-1">/</span>
                                                <span className="text-green-600">{report.discountContract}</span>
                                            </td>
                                            <td className="text-center py-3 px-2 font-semibold text-slate-700">
                                                {report.existingTreatments}
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                {report.dailyTasksCompleted ? (
                                                    <span className="text-green-500"><Icon name="check-circle" size={18} /></span>
                                                ) : (
                                                    <span className="text-red-400"><Icon name="x-circle" size={18} /></span>
                                                )}
                                            </td>
                                            <td className="text-center py-3 px-2">
                                                {report.tomorrowPrepCompleted ? (
                                                    <span className="text-green-500"><Icon name="check-circle" size={18} /></span>
                                                ) : (
                                                    <span className="text-red-400"><Icon name="x-circle" size={18} /></span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredReports.length > 50 && (
                            <div className="text-center py-4 text-sm text-slate-500">
                                最新50件を表示中（全{filteredReports.length}件）
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        // ========================================
        // 会員管理ビュー（Square連携）
        // ========================================

        const MemberManagementView = ({ memberData, refreshSquareData }) => {
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [filterStatus, setFilterStatus] = useState('all'); // all, ACTIVE, CANCELED, PENDING
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedMember, setSelectedMember] = useState(null);

            const handleRefresh = async () => {
                setIsRefreshing(true);
                await refreshSquareData();
                setIsRefreshing(false);
            };

            // 月額単価（設定可能にする）
            const monthlyPrice = 10000;

            // LTV計算（平均継続月数を仮定）
            const avgRetentionMonths = memberData.churnRate > 0 ? Math.round(100 / memberData.churnRate) : 24;
            const estimatedLTV = monthlyPrice * avgRetentionMonths;

            // 会員フィルタリング
            const filteredMembers = useMemo(() => {
                let filtered = memberData.members || [];

                // ステータスフィルタ
                if (filterStatus !== 'all') {
                    filtered = filtered.filter(m => m.status === filterStatus);
                }

                // 検索クエリ
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(m =>
                        m.name.toLowerCase().includes(query) ||
                        m.email.toLowerCase().includes(query) ||
                        m.phone.includes(query)
                    );
                }

                return filtered;
            }, [memberData.members, filterStatus, searchQuery]);

            // ステータスバッジの色
            const getStatusColor = (status) => {
                switch (status) {
                    case 'ACTIVE': return 'bg-green-100 text-green-700 border-green-200';
                    case 'CANCELED': return 'bg-red-100 text-red-700 border-red-200';
                    case 'PENDING': return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                    case 'PAUSED': return 'bg-slate-100 text-slate-700 border-slate-200';
                    default: return 'bg-slate-100 text-slate-700 border-slate-200';
                }
            };

            // ステータスラベル
            const getStatusLabel = (status) => {
                switch (status) {
                    case 'ACTIVE': return 'アクティブ';
                    case 'CANCELED': return '退会';
                    case 'PENDING': return '保留中';
                    case 'PAUSED': return '一時停止';
                    default: return status;
                }
            };

            // 頻度ラベル
            const getCadenceLabel = (cadence) => {
                switch (cadence) {
                    case 'DAILY': return '日次';
                    case 'WEEKLY': return '週次';
                    case 'EVERY_TWO_WEEKS': return '隔週';
                    case 'MONTHLY': return '月額';
                    case 'EVERY_TWO_MONTHS': return '隔月';
                    case 'QUARTERLY': return '四半期';
                    case 'EVERY_FOUR_MONTHS': return '4ヶ月毎';
                    case 'EVERY_SIX_MONTHS': return '半年';
                    case 'ANNUAL': return '年額';
                    case 'EVERY_TWO_YEARS': return '2年毎';
                    default: return cadence || '月額';
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-slate-900">会員管理</h2>
                            <p className="text-sm text-slate-500 mt-1">Square連携データ</p>
                        </div>
                        <button
                            onClick={handleRefresh}
                            disabled={isRefreshing}
                            className="flex items-center px-4 py-2 bg-sise-500 hover:bg-sise-600 text-white rounded-lg font-medium shadow-sm transition-colors disabled:opacity-50"
                        >
                            <Icon name={isRefreshing ? "loader" : "refresh-cw"} size={18} className={`mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                            {isRefreshing ? '更新中...' : 'データ更新'}
                        </button>
                    </div>

                    {memberData.error && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p className="text-red-700 text-sm">
                                <Icon name="alert-circle" size={16} className="inline mr-2" />
                                エラー: {memberData.error}
                            </p>
                        </div>
                    )}

                    {/* 会員サマリ */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <Card className="bg-gradient-to-br from-sise-50 to-sise-100 border-sise-200">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-sise-700">アクティブ会員</span>
                                <Icon name="users" size={20} className="text-sise-500" />
                            </div>
                            <p className="text-3xl font-bold text-sise-900">{memberData.activeMembers}</p>
                            <p className="text-xs text-sise-600 mt-1">累計: {memberData.totalMembers}人</p>
                        </Card>

                        <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-green-700">月間想定売上</span>
                                <Icon name="trending-up" size={20} className="text-green-500" />
                            </div>
                            <p className="text-3xl font-bold text-green-900">{formatCurrency(memberData.expectedRevenue)}</p>
                            <p className="text-xs text-green-600 mt-1">@{formatCurrency(monthlyPrice)}/月</p>
                        </Card>

                        <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-blue-700">今月の新規入会</span>
                                <Icon name="user-plus" size={20} className="text-blue-500" />
                            </div>
                            <p className="text-3xl font-bold text-blue-900">{memberData.newMembersThisMonth}</p>
                            <p className="text-xs text-blue-600 mt-1">新規獲得</p>
                        </Card>

                        <Card className={`bg-gradient-to-br ${memberData.churnRate > 5 ? 'from-red-50 to-red-100 border-red-200' : 'from-slate-50 to-slate-100 border-slate-200'}`}>
                            <div className="flex items-center justify-between mb-2">
                                <span className={`text-sm font-medium ${memberData.churnRate > 5 ? 'text-red-700' : 'text-slate-700'}`}>退会率</span>
                                <Icon name="user-minus" size={20} className={memberData.churnRate > 5 ? 'text-red-500' : 'text-slate-500'} />
                            </div>
                            <p className={`text-3xl font-bold ${memberData.churnRate > 5 ? 'text-red-900' : 'text-slate-900'}`}>
                                {formatPercent(memberData.churnRate)}
                            </p>
                            <p className={`text-xs mt-1 ${memberData.churnRate > 5 ? 'text-red-600' : 'text-slate-600'}`}>
                                退会者: {memberData.churnedMembers}人
                            </p>
                        </Card>
                    </div>

                    {/* 分析カード */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">収益分析</h3>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">月額単価</span>
                                    <span className="font-bold text-slate-900">{formatCurrency(monthlyPrice)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">年間想定売上</span>
                                    <span className="font-bold text-green-600">{formatCurrency(memberData.expectedRevenue * 12)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-600">平均継続期間</span>
                                    <span className="font-bold text-slate-900">約{avgRetentionMonths}ヶ月</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-sise-50 rounded-lg border border-sise-200">
                                    <span className="text-sise-700 font-medium">推定LTV</span>
                                    <span className="font-bold text-sise-900">{formatCurrency(estimatedLTV)}</span>
                                </div>
                            </div>
                        </Card>

                        <Card>
                            <h3 className="text-lg font-bold text-slate-900 mb-4">KPIトレンド</h3>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-slate-600">会員維持率</span>
                                        <span className="font-semibold text-green-600">{formatPercent(100 - memberData.churnRate)}</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-2">
                                        <div
                                            className="bg-green-500 h-2 rounded-full transition-all"
                                            style={{ width: `${100 - memberData.churnRate}%` }}
                                        ></div>
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-slate-600">目標会員数達成率</span>
                                        <span className="font-semibold text-sise-600">{formatPercent(memberData.activeMembers / 200 * 100)}</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-2">
                                        <div
                                            className="bg-sise-500 h-2 rounded-full transition-all"
                                            style={{ width: `${Math.min(memberData.activeMembers / 200 * 100, 100)}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">目標: 200人</p>
                                </div>
                            </div>
                        </Card>
                    </div>

                    {/* 月間入退会トレンドチャート */}
                    <Card>
                        <h3 className="text-lg font-bold text-slate-900 mb-4">月間入退会トレンド</h3>
                        {window.Recharts && (
                            <ResponsiveContainer width="100%" height={350}>
                                <ComposedChart data={memberData.monthlyTrend || []}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                    <XAxis dataKey="month" tick={{ fontSize: 11 }} />
                                    <YAxis yAxisId="left" tick={{ fontSize: 12 }} label={{ value: '人数', angle: -90, position: 'insideLeft', style: { fontSize: 11 } }} />
                                    <YAxis yAxisId="right" orientation="right" tick={{ fontSize: 12 }} label={{ value: '累積会員', angle: 90, position: 'insideRight', style: { fontSize: 11 } }} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#fff', borderColor: '#e2e8f0', borderRadius: '8px' }}
                                        formatter={(value, name) => {
                                            if (name === 'newMembers') return [value + '人', '新規入会'];
                                            if (name === 'churnedMembers') return [value + '人', '退会'];
                                            if (name === 'netGrowth') return [value + '人', '純増減'];
                                            if (name === 'activeMembers') return [value + '人', 'アクティブ会員'];
                                            return [value, name];
                                        }}
                                    />
                                    <Legend
                                        formatter={(value) => {
                                            if (value === 'newMembers') return '新規入会';
                                            if (value === 'churnedMembers') return '退会';
                                            if (value === 'netGrowth') return '純増減';
                                            if (value === 'activeMembers') return 'アクティブ会員';
                                            return value;
                                        }}
                                    />
                                    <Bar yAxisId="left" dataKey="newMembers" name="newMembers" fill="#22c55e" radius={[4, 4, 0, 0]} />
                                    <Bar yAxisId="left" dataKey="churnedMembers" name="churnedMembers" fill="#ef4444" radius={[4, 4, 0, 0]} />
                                    <Line yAxisId="left" type="monotone" dataKey="netGrowth" name="netGrowth" stroke="#f59e0b" strokeWidth={2} strokeDasharray="5 5" dot={{ r: 3 }} />
                                    <Line yAxisId="right" type="monotone" dataKey="activeMembers" name="activeMembers" stroke="#0ea5e9" strokeWidth={3} dot={{ r: 4, fill: '#0ea5e9' }} />
                                </ComposedChart>
                            </ResponsiveContainer>
                        )}
                    </Card>

                    {/* 月別サマリーテーブル */}
                    <Card>
                        <h3 className="text-lg font-bold text-slate-900 mb-4">月別入退会サマリー</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b-2 border-slate-200 bg-slate-50">
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">月</th>
                                        <th className="text-right py-3 px-3 font-semibold text-green-600">入会</th>
                                        <th className="text-right py-3 px-3 font-semibold text-red-600">退会</th>
                                        <th className="text-right py-3 px-3 font-semibold text-sise-600">純増減</th>
                                        <th className="text-right py-3 px-3 font-semibold text-slate-600">アクティブ</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">推移</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(memberData.monthlyTrend || []).slice().reverse().map((m, idx) => {
                                        const maxActive = Math.max(...(memberData.monthlyTrend || []).map(t => t.activeMembers || 0), 1);
                                        return (
                                            <tr key={m.month} className={`border-b border-slate-100 ${idx === 0 ? 'bg-sise-50' : 'hover:bg-slate-50'}`}>
                                                <td className="py-3 px-3 font-medium text-slate-900">
                                                    {m.month}
                                                    {idx === 0 && <span className="ml-2 text-xs bg-sise-100 text-sise-700 px-2 py-0.5 rounded-full">今月</span>}
                                                </td>
                                                <td className="text-right py-3 px-3">
                                                    <span className="font-bold text-green-600">+{m.newMembers}</span>
                                                </td>
                                                <td className="text-right py-3 px-3">
                                                    <span className="font-bold text-red-500">-{m.churnedMembers}</span>
                                                </td>
                                                <td className="text-right py-3 px-3">
                                                    <span className={`font-bold px-2 py-1 rounded ${m.netGrowth >= 0 ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50'}`}>
                                                        {m.netGrowth >= 0 ? '+' : ''}{m.netGrowth}
                                                    </span>
                                                </td>
                                                <td className="text-right py-3 px-3 font-semibold text-slate-900">{m.activeMembers || '-'}</td>
                                                <td className="py-3 px-3">
                                                    <div className="w-full bg-slate-200 rounded-full h-2 min-w-[80px]">
                                                        <div
                                                            className="bg-sise-500 h-2 rounded-full transition-all"
                                                            style={{ width: `${((m.activeMembers || 0) / maxActive) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {/* 会員一覧テーブル */}
                    <Card>
                        <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                            <h3 className="text-lg font-bold text-slate-900">会員一覧</h3>
                            <div className="flex items-center gap-2">
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="会員を検索..."
                                    className="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:border-sise-500 outline-none"
                                />
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:border-sise-500 outline-none"
                                >
                                    <option value="all">全て</option>
                                    <option value="ACTIVE">アクティブ</option>
                                    <option value="CANCELED">退会</option>
                                    <option value="PENDING">保留中</option>
                                </select>
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-200 bg-slate-50">
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">会員名</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">ステータス</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">プラン</th>
                                        <th className="text-right py-3 px-3 font-semibold text-slate-600">金額</th>
                                        <th className="text-center py-3 px-3 font-semibold text-slate-600">頻度</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">入会日</th>
                                        <th className="text-left py-3 px-3 font-semibold text-slate-600">退会日</th>
                                        <th className="text-center py-3 px-3 font-semibold text-slate-600">支払履歴</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredMembers.slice(0, 20).map((member) => (
                                        <tr key={member.id} className="border-b border-slate-100 hover:bg-slate-50">
                                            <td className="py-3 px-3">
                                                <div>
                                                    <p className="font-medium text-slate-900">{member.name}</p>
                                                    <p className="text-xs text-slate-500">{member.email}</p>
                                                </div>
                                            </td>
                                            <td className="py-3 px-3">
                                                <span className={`px-2 py-1 rounded text-xs font-medium border ${getStatusColor(member.status)}`}>
                                                    {getStatusLabel(member.status)}
                                                </span>
                                            </td>
                                            <td className="py-3 px-3 text-slate-700">{member.planName}</td>
                                            <td className="text-right py-3 px-3 font-semibold text-slate-900">
                                                {formatCurrency(member.monthlyPrice)}
                                            </td>
                                            <td className="text-center py-3 px-3">
                                                <span className="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs font-medium">
                                                    {getCadenceLabel(member.cadence)}
                                                </span>
                                            </td>
                                            <td className="py-3 px-3 text-slate-700">
                                                {new Date(member.startDate).toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' })}
                                            </td>
                                            <td className="py-3 px-3 text-slate-700">
                                                {member.canceledDate
                                                    ? new Date(member.canceledDate).toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' })
                                                    : '-'
                                                }
                                            </td>
                                            <td className="text-center py-3 px-3">
                                                <button
                                                    onClick={() => setSelectedMember(member)}
                                                    className="text-sise-600 hover:text-sise-700 font-medium text-xs"
                                                >
                                                    {member.paymentHistory.length}件
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {filteredMembers.length > 20 && (
                            <div className="text-center py-4 text-sm text-slate-500">
                                最新20件を表示中（全{filteredMembers.length}件）
                            </div>
                        )}
                        {filteredMembers.length === 0 && (
                            <div className="text-center py-8 text-slate-500">
                                <Icon name="users" size={48} className="mx-auto mb-2 text-slate-300" />
                                <p>該当する会員が見つかりませんでした</p>
                            </div>
                        )}
                    </Card>

                    {/* 支払履歴モーダル */}
                    {selectedMember && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setSelectedMember(null)}>
                            <div className="bg-white rounded-xl shadow-xl max-w-2xl w-full p-6" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-slate-900">{selectedMember.name} - 支払履歴</h3>
                                    <button onClick={() => setSelectedMember(null)} className="p-2 hover:bg-slate-100 rounded-lg">
                                        <Icon name="x" size={20} />
                                    </button>
                                </div>
                                {/* 会員情報サマリ */}
                                <div className="grid grid-cols-2 gap-3 mb-4 p-3 bg-slate-50 rounded-lg">
                                    <div>
                                        <span className="text-xs text-slate-500">プラン</span>
                                        <p className="font-medium text-slate-900">{selectedMember.planName}</p>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-500">金額 / 頻度</span>
                                        <p className="font-medium text-slate-900">{formatCurrency(selectedMember.monthlyPrice)} / {getCadenceLabel(selectedMember.cadence)}</p>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-500">入会日</span>
                                        <p className="font-medium text-slate-900">{new Date(selectedMember.startDate).toLocaleDateString('ja-JP')}</p>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-500">ステータス</span>
                                        <p><span className={`px-2 py-1 rounded text-xs font-medium border ${getStatusColor(selectedMember.status)}`}>{getStatusLabel(selectedMember.status)}</span></p>
                                    </div>
                                </div>
                                <h4 className="text-sm font-semibold text-slate-700 mb-3">請求・支払い履歴（最新10件）</h4>
                                <div className="space-y-3">
                                    {selectedMember.paymentHistory.map((payment) => {
                                        const getPaymentStatusStyle = (status) => {
                                            switch (status) {
                                                case 'PAID': return 'bg-green-100 text-green-700';
                                                case 'UNPAID': return 'bg-yellow-100 text-yellow-700';
                                                case 'DRAFT': return 'bg-slate-100 text-slate-600';
                                                case 'CANCELED': return 'bg-red-100 text-red-600';
                                                case 'SCHEDULED': return 'bg-blue-100 text-blue-600';
                                                default: return 'bg-slate-100 text-slate-600';
                                            }
                                        };
                                        const getPaymentStatusLabel = (status) => {
                                            switch (status) {
                                                case 'PAID': return '支払済';
                                                case 'UNPAID': return '未払';
                                                case 'DRAFT': return '下書き';
                                                case 'CANCELED': return 'キャンセル';
                                                case 'SCHEDULED': return '予定';
                                                case 'PARTIALLY_PAID': return '一部支払';
                                                case 'PAYMENT_PENDING': return '処理中';
                                                default: return status;
                                            }
                                        };
                                        return (
                                            <div key={payment.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                <div>
                                                    <p className="font-medium text-slate-900">{formatCurrency(payment.amount)}</p>
                                                    <p className="text-xs text-slate-500">
                                                        {new Date(payment.date).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}
                                                        {payment.invoiceNumber !== '-' && ` / ${payment.invoiceNumber}`}
                                                    </p>
                                                </div>
                                                <span className={`px-2 py-1 rounded text-xs font-medium ${getPaymentStatusStyle(payment.status)}`}>
                                                    {getPaymentStatusLabel(payment.status)}
                                                </span>
                                            </div>
                                        );
                                    })}
                                    {selectedMember.paymentHistory.length === 0 && (
                                        <p className="text-center text-slate-500 py-4">支払履歴がありません</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 設定情報 */}
                    <Card className="bg-slate-50 border-slate-300">
                        <div className="flex items-start">
                            <Icon name="info" size={20} className="text-sise-500 mr-3 mt-0.5" />
                            <div>
                                <h4 className="font-semibold text-slate-900 mb-2">Square API連携について</h4>
                                <p className="text-sm text-slate-600 mb-2">
                                    このダッシュボードはSquare APIと連携して会員データを取得します。
                                    実際のデータを表示するには、以下の設定が必要です：
                                </p>
                                <ul className="text-sm text-slate-600 list-disc list-inside space-y-1">
                                    <li>Square Developer Accountでアプリを作成</li>
                                    <li>Customers API、Subscriptions APIの権限を付与</li>
                                    <li>アクセストークンとロケーションIDを設定</li>
                                </ul>
                                <p className="text-xs text-slate-500 mt-3">
                                    現在はデモモードで動作しています。
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // ========================================
        // 設定ビュー
        // ========================================

        const SettingsView = ({ onSettingsSaved }) => {
            const [squareStatus, setSquareStatus] = useState({ loading: true });
            const [googleFormUrl, setGoogleFormUrl] = useState(
                localStorage.getItem('sise_gas_url') || GOOGLE_FORM_SHEET_URL
            );
            const [saveMessage, setSaveMessage] = useState('');

            // サーバーの接続状態を取得
            useEffect(() => {
                fetchSquareConfig().then(config => {
                    setSquareStatus({ ...config, loading: false });
                });
            }, []);

            const handleSaveGas = () => {
                localStorage.setItem('sise_gas_url', googleFormUrl);
                setSaveMessage('GAS URLを保存しました。リロードで反映されます。');
                setTimeout(() => setSaveMessage(''), 5000);
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-xl font-bold text-slate-900">設定</h2>

                    {saveMessage && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p className="text-green-700 text-sm flex items-center">
                                <Icon name="check-circle" size={16} className="mr-2" />
                                {saveMessage}
                            </p>
                        </div>
                    )}

                    {/* Square API 接続状態 */}
                    <Card>
                        <h3 className="text-lg font-semibold text-slate-900 mb-4">Square API連携</h3>
                        {squareStatus.loading ? (
                            <div className="skeleton h-20 rounded-lg"></div>
                        ) : (
                            <div className="space-y-4">
                                <div className={`flex items-center p-4 rounded-lg border ${
                                    squareStatus.configured
                                        ? 'bg-green-50 border-green-200'
                                        : 'bg-amber-50 border-amber-200'
                                }`}>
                                    <Icon
                                        name={squareStatus.configured ? 'check-circle' : 'alert-circle'}
                                        size={24}
                                        className={`mr-3 ${squareStatus.configured ? 'text-green-500' : 'text-amber-500'}`}
                                    />
                                    <div>
                                        <p className={`font-semibold ${squareStatus.configured ? 'text-green-800' : 'text-amber-800'}`}>
                                            {squareStatus.configured ? '接続済み' : '未設定（デモモード）'}
                                        </p>
                                        <p className="text-sm text-slate-600">
                                            {squareStatus.configured
                                                ? `環境: ${squareStatus.environment === 'production' ? '本番' : 'Sandbox'} / Location: ${squareStatus.locationId}`
                                                : 'Vercelダッシュボードで環境変数を設定してください'
                                            }
                                        </p>
                                    </div>
                                </div>

                                <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                    <h4 className="font-semibold text-slate-900 mb-3">環境変数の設定方法</h4>
                                    <p className="text-sm text-slate-600 mb-3">
                                        Vercelダッシュボード &gt; Settings &gt; Environment Variables に以下を設定:
                                    </p>
                                    <div className="space-y-2 font-mono text-xs">
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_ACCESS_TOKEN</span>
                                            <span className="text-slate-500">= sq0atp-... or EAAA...</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_LOCATION_ID</span>
                                            <span className="text-slate-500">= L...</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_ENVIRONMENT</span>
                                            <span className="text-slate-500">= sandbox or production</span>
                                        </div>
                                        <div className="flex items-center p-2 bg-white rounded border border-slate-200">
                                            <span className="text-sise-600 font-semibold w-64">SQUARE_DEFAULT_MONTHLY_PRICE</span>
                                            <span className="text-slate-500">= 10000</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </Card>

                    {/* Googleフォーム連携 */}
                    <Card>
                        <h3 className="text-lg font-semibold text-slate-900 mb-4">Googleフォーム連携</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Google Apps Script Web App URL
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="url"
                                        value={googleFormUrl}
                                        onChange={(e) => setGoogleFormUrl(e.target.value)}
                                        className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:border-sise-500 focus:ring-1 focus:ring-sise-500 outline-none"
                                        placeholder="https://script.google.com/macros/s/..."
                                    />
                                    <button
                                        onClick={handleSaveGas}
                                        className="px-4 py-2 bg-sise-500 hover:bg-sise-600 text-white rounded-lg font-medium text-sm transition-colors"
                                    >
                                        保存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </Card>

                    {/* セキュリティ情報 */}
                    <Card className="bg-green-50 border-green-200">
                        <div className="flex items-start">
                            <Icon name="shield-check" size={20} className="text-green-500 mr-3 mt-0.5" />
                            <div>
                                <h4 className="font-semibold text-green-900 mb-1">セキュリティ</h4>
                                <p className="text-sm text-green-700">
                                    Square APIトークンはVercelのサーバーサイドで管理されています。
                                    ブラウザにはトークンが露出しない安全な構成です。
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // ========================================
        // メインアプリケーション
        // ========================================

        const App = () => {
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedStore, setSelectedStore] = useState('all');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(false);

            // Square データ取得
            const { memberData, refreshSquareData } = useSquareData();
            // 日報データ取得
            const { reportData, refreshReportData } = useDailyReportData();

            // ダークモード切り替え
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);

            const navItems = [
                { id: 'dashboard', label: 'ダッシュボード', icon: 'layout-dashboard' },
                { id: 'reports', label: '日報一覧', icon: 'clipboard-list' },
                { id: 'members', label: '会員管理', icon: 'users' },
                { id: 'settings', label: '設定', icon: 'settings' },
            ];

            const renderView = () => {
                switch (currentView) {
                    case 'dashboard':
                        return <DashboardView
                            memberData={memberData}
                            reportData={reportData}
                            selectedStore={selectedStore}
                            setSelectedStore={setSelectedStore}
                        />;
                    case 'reports':
                        return <DailyReportListView reportData={reportData} />;
                    case 'members':
                        return <MemberManagementView memberData={memberData} refreshSquareData={refreshSquareData} />;
                    case 'settings':
                        return <SettingsView onSettingsSaved={() => {}} />;
                    default:
                        return <DashboardView
                            memberData={memberData}
                            reportData={reportData}
                            selectedStore={selectedStore}
                            setSelectedStore={setSelectedStore}
                        />;
                }
            };

            return (
                <div className="min-h-screen bg-slate-50">
                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm border-b border-slate-200 safe-top">
                        <div className="flex items-center justify-between px-4 h-16">
                            <div className="flex items-center">
                                <button
                                    onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                    className="lg:hidden p-2 rounded-lg hover:bg-slate-100 mr-2"
                                >
                                    <Icon name="menu" size={24} />
                                </button>
                                <div className="flex items-center">
                                    <div className="w-10 h-10 bg-gradient-to-br from-sise-400 to-sise-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-md">
                                        S
                                    </div>
                                    <div className="ml-3">
                                        <h1 className="text-lg font-bold text-slate-900">si'se</h1>
                                        <p className="text-xs text-slate-500 -mt-0.5">整体院ダッシュボード</p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => { refreshReportData(); refreshSquareData(); }}
                                    className="p-2 rounded-lg hover:bg-slate-100 text-slate-600"
                                    title="データ更新"
                                >
                                    <Icon name="refresh-cw" size={20} />
                                </button>
                                <button
                                    onClick={() => setIsDarkMode(!isDarkMode)}
                                    className="p-2 rounded-lg hover:bg-slate-100 text-slate-600"
                                    title="ダークモード切り替え"
                                >
                                    <Icon name={isDarkMode ? 'sun' : 'moon'} size={20} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Sidebar Overlay (Mobile) */}
                    {isSidebarOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-40 lg:hidden"
                            onClick={() => setIsSidebarOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`fixed top-16 left-0 bottom-0 w-64 bg-white border-r border-slate-200 z-40 transform transition-transform duration-300 lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <nav className="p-4 space-y-1">
                            {navItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => {
                                        setCurrentView(item.id);
                                        setIsSidebarOpen(false);
                                    }}
                                    className={`w-full flex items-center px-4 py-3 rounded-lg text-left font-medium transition-colors ${
                                        currentView === item.id
                                            ? 'bg-sise-50 text-sise-700 border-l-4 border-sise-500'
                                            : 'text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <Icon name={item.icon} size={20} className="mr-3" />
                                    {item.label}
                                </button>
                            ))}
                        </nav>

                        {/* データ更新時刻 */}
                        <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-200 bg-slate-50">
                            <p className="text-xs text-slate-500">
                                最終更新: {reportData.lastUpdated
                                    ? reportData.lastUpdated.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
                                    : '-'
                                }
                            </p>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="pt-16 lg:pl-64 min-h-screen">
                        <div className="p-4 lg:p-6 max-w-7xl mx-auto safe-bottom">
                            {memberData.loading || reportData.loading ? (
                                <div className="flex items-center justify-center h-64">
                                    <div className="text-center">
                                        <div className="w-12 h-12 border-4 border-sise-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                                        <p className="text-slate-600">データを読み込み中...</p>
                                    </div>
                                </div>
                            ) : (
                                renderView()
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // アプリケーションのレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
